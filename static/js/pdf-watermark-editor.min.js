document.addEventListener("DOMContentLoaded",()=>{const e="3.11.174",t="string"==typeof window.PDFJS_LOCAL_PDF?window.PDFJS_LOCAL_PDF:null,n="string"==typeof window.PDFJS_LOCAL_WORKER?window.PDFJS_LOCAL_WORKER:null,o=[...t?[t]:[],`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${e}/pdf.min.js`,`https://unpkg.com/pdfjs-dist@${e}/build/pdf.min.js`],a=[...n?[n]:[],`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${e}/pdf.worker.min.js`,`https://unpkg.com/pdfjs-dist@${e}/build/pdf.worker.min.js`];function i(e){return new Promise((t,n)=>{const o=Array.from(document.scripts).find(t=>t.src===e);if(o)return void 0!==window.pdfjsLib?t():(o.addEventListener("load",()=>t(),{once:!0}),void o.addEventListener("error",()=>n(new Error(`Failed to load ${e}`)),{once:!0}));const a=document.createElement("script");a.src=e,a.async=!0,a.crossOrigin="anonymous",a.onload=()=>t(),a.onerror=()=>n(new Error(`Failed to load ${e}`)),document.head.appendChild(a)})}void 0!==window.pdfjsLib&&(window.pdfjsLib.GlobalWorkerOptions.workerSrc=a[0]);const d=document.getElementById("editorForm");if(!d)return;const r=document.getElementById("fileInput"),s=document.getElementById("fileInputDrop"),l=(document.getElementById("selectFileButton"),document.getElementById("pdfPreviewSection")),c=document.getElementById("watermarkSettingsSection"),u=document.getElementById("pdfCanvas"),m=document.getElementById("pdfCanvasContainer"),h=document.getElementById("watermarkPreview"),w=document.getElementById("pageSelector"),p=document.getElementById("editButton"),g=document.getElementById("editorResult"),f=document.getElementById("watermarkTypeText"),v=document.getElementById("watermarkTypeImage"),E=document.getElementById("textWatermarkSection"),y=document.getElementById("imageWatermarkSection"),L=document.getElementById("fontSizeSection"),I=document.getElementById("watermark_text"),k=document.getElementById("watermark_file"),B=document.getElementById("watermarkFileButton"),x=document.getElementById("watermarkFileName"),b=document.getElementById("watermark_color"),F=document.getElementById("watermark_color_text"),P=document.getElementById("opacity"),C=document.getElementById("opacityValue"),M=document.getElementById("font_size"),D=document.getElementById("fontSizeValue"),T=(document.getElementById("pages"),document.getElementById("position")),_=document.getElementById("x"),S=document.getElementById("y"),A=document.getElementById("rotation"),N=document.getElementById("scale");let R=null,j=1,O=0,$=1,H=0,X=0,W=0,Y=0,z=null,G=null,U=null,V=0,q=1,J=null;const K=document.getElementById("watermarkXSlider"),Q=document.getElementById("watermarkYSlider");function Z(e){return Math.max(0,Math.min(1,e))}function ee(e){const t=Number(e);return Number.isFinite(t)?Z(t/100):.5}function te(){if(!R||!H||!X)return;if(!K||!Q)return;const e=ee(K.value),t=ee(Q.value);z=H*e,G=X*t,_&&(_.value=z.toFixed(2)),S&&(S.value=G.toFixed(2)),T&&(T.value="custom"),Fe()}K&&K.addEventListener("input",()=>{te()}),Q&&Q.addEventListener("input",()=>{te()});let ne=!1,oe=!1,ae=0,ie=0,de=null,re=!1,se=!1,le=0,ce=null,ue=!1,me=1,he=0;f&&v&&(f.addEventListener("change",()=>{f.checked&&(E.classList.remove("hidden"),y.classList.add("hidden"),L.classList.remove("hidden"),k&&(k.value=""),x&&(x.textContent=""),Fe())}),v.addEventListener("change",()=>{v.checked&&(E.classList.add("hidden"),y.classList.remove("hidden"),L.classList.add("hidden"),Fe())}));const we=()=>{R&&null!==z&&null!==G&&Fe()};b&&b.addEventListener("input",we),F&&F.addEventListener("input",we),P&&P.addEventListener("input",e=>{const t=parseInt(e.target.value);C&&(C.textContent=t+"%"),we()}),M&&M.addEventListener("input",e=>{const t=parseInt(e.target.value);D&&(D.textContent=t+"px"),we()});const pe=document.getElementById("rotation_slider"),ge=document.getElementById("rotationValue");pe&&pe.addEventListener("input",e=>{const t=parseInt(e.target.value);ge&&(ge.textContent=t+"Â°"),V=t<0?360+t:t,A&&(A.value=V.toFixed(1)),we()});const fe=document.getElementById("scale_slider"),ve=document.getElementById("scaleValue");async function Ee(e){try{if(g&&(g.classList.add("hidden"),g.innerHTML=""),ye(),l.classList.remove("hidden"),c.classList.remove("hidden"),!e||!e.type||!e.type.includes("pdf"))return window.showError("Please select a valid PDF file.","editorResult"),l.classList.add("hidden"),void c.classList.add("hidden");if(!await async function(){if(void 0!==window.pdfjsLib)return!0;for(const e of o)try{if(await i(e),void 0!==window.pdfjsLib)break}catch(e){}return void 0!==window.pdfjsLib&&(window.pdfjsLib.GlobalWorkerOptions.workerSrc||(window.pdfjsLib.GlobalWorkerOptions.workerSrc=a[0]),!0)}()||void 0===window.pdfjsLib)return window.showError("PDF preview engine (PDF.js) is not loaded. Please disable adblock for this site or check that cdnjs/unpkg are not blocked, then refresh the page.","editorResult"),l.classList.add("hidden"),c.classList.add("hidden"),void ye();window.pdfjsLib.GlobalWorkerOptions.workerSrc||(window.pdfjsLib.GlobalWorkerOptions.workerSrc=a[0]),await new Promise(e=>setTimeout(e,50));const t=await e.arrayBuffer();if(!t||0===t.byteLength)return window.showError("Failed to read file. Please try again.","editorResult"),l.classList.add("hidden"),void c.classList.add("hidden");let n=0;const d=3;for(;n<d;)try{if(R=await window.pdfjsLib.getDocument({data:t,verbosity:0}).promise,!R)throw new Error("PDF document is null");break}catch(e){if(n++,console.error(`PDF load attempt ${n} failed:`,e),n>=d)return window.showError("Failed to load PDF file. Please try again.","editorResult"),l.classList.add("hidden"),c.classList.add("hidden"),void ye()}O=R.numPages;if(!await window.validatePdfPageLimit(e))return l.classList.add("hidden"),c.classList.add("hidden"),void ye();w.innerHTML="";const r=window.PAGE_LABEL||"Page";for(let e=1;e<=O;e++){const t=document.createElement("option");t.value=e,t.textContent=`${r} ${e}`,w.appendChild(t)}j=1,await Le(1),p&&(p.disabled=!1,p.classList.remove("opacity-50","cursor-not-allowed"))}catch(e){let t="Failed to load PDF file. Please try again.";e&&e.message&&(t=e.message.includes("Invalid PDF")?"Invalid PDF file. Please select a valid PDF file.":e.message.includes("password")?"This PDF is password protected. Please unlock it first.":e.message.includes("network")||e.message.includes("fetch")?"Network error. Please check your connection and try again.":`Error: ${e.message}`),window.showError(t,"editorResult"),"undefined"!=typeof console&&console.error&&(console.error("Error loading PDF:",e),console.error("Error details:",{name:e?.name,message:e?.message,stack:e?.stack})),l&&l.classList.add("hidden"),c&&c.classList.add("hidden")}}function ye(){if(R){try{R.destroy()}catch(e){}R=null}if(j=1,O=0,z=null,G=null,U=null,ne=!1,oe=!1,u){u.getContext("2d").clearRect(0,0,u.width,u.height)}h&&(h.innerHTML="",h.classList.add("hidden"))}async function Le(e){if(R)try{const t=await R.getPage(e),n=t.getViewport({scale:1}),o=700,a=600/n.width,i=o/n.height;$=Math.min(a,i,1);const d=t.getViewport({scale:$});W=d.width,Y=d.height,u.width=W,u.height=Y,u.style.width="",u.style.height="",H=n.width,X=n.height,J&&(J.cancel(),J=null);const r={canvasContext:u.getContext("2d"),viewport:d};J=t.render(r),await J.promise,J=null,setTimeout(()=>{Ie()},100)}catch(e){console?.error&&console.error("Error rendering page:",e)}}function Ie(){if(!R||0===H||0===X)return;const e=window.innerWidth<=768;z=H/2,G=e?30:50,(void 0===V||isNaN(V)||null===V)&&(V=0),(void 0===q||isNaN(q)||null===q)&&(q=e?.8:1),h.classList.remove("hidden"),_&&(_.value=z.toFixed(2)),S&&(S.value=G.toFixed(2)),T&&(T.value="custom"),A&&(A.value=(V||0).toFixed(1)),N&&(N.value=(q||1).toFixed(2)),Fe()}fe&&fe.addEventListener("input",e=>{const t=parseFloat(e.target.value);ve&&(ve.textContent=Math.round(100*t)+"%");let n=3;const o=f?.checked;if(R&&H&&X)if(o){const e=parseInt(M?.value||72),t=e*(I?.value||"CONFIDENTIAL").length*.6,o=.95*H/t,a=.95*X/(1.2*e);n=Math.max(.5,Math.min(o,a,5))}else if(U){const e=.5*Math.min(H/U.width,X/U.height),t=U.width*e,o=U.height*e,a=.95*H/t,i=.95*X/o;n=Math.max(.5,Math.min(a,i,5))}q=Math.max(.1,Math.min(n,t)),q!==t&&(fe.value=q,ve&&(ve.textContent=Math.round(100*q)+"%")),N&&(N.value=q.toFixed(2)),we()}),I&&(I.addEventListener("input",we),I.addEventListener("blur",we)),B&&k&&B.addEventListener("click",e=>{e.preventDefault(),k.click()}),k&&k.addEventListener("change",e=>{if(e.target.files&&e.target.files.length>0){const t=e.target.files[0];x&&(x.textContent=t.name);const n=new FileReader;n.onload=e=>{U=new Image,U.onload=()=>{Fe()},U.src=e.target.result},n.readAsDataURL(t)}}),document.addEventListener("fileSelected",e=>{const t=e.detail?.file;t&&"application/pdf"===t.type&&Ee(t)}),r&&r.addEventListener("change",async e=>{if(await new Promise(e=>setTimeout(e,100)),e.target.files&&e.target.files.length>0){const t=e.target.files[0];"application/pdf"===t.type&&Ee(t)}}),s&&s.addEventListener("change",async e=>{if(await new Promise(e=>setTimeout(e,100)),e.target.files&&e.target.files.length>0){const t=e.target.files[0];"application/pdf"===t.type&&Ee(t)}});const ke=document.getElementById("watermarkPagesAll"),Be=document.getElementById("watermarkPagesCurrent"),xe=document.getElementById("watermarkPagesCustom"),be=document.getElementById("watermarkPagesCustomInput");function Fe(){if(!R)return void h.classList.add("hidden");if(null===z||null===G)return void Ie();const e=f?.checked,t=parseInt(P?.value||30)/100,n=b?.value||"#000000",o=parseInt(M?.value||72),a=I?.value||"CONFIDENTIAL";console.log("Updating watermark preview with:",{isText:e,opacity:t,color:n,fontSize:o,text:a});const i=W/H,d=z*i,r=Y-G*i;console.log("Canvas coordinates:",{canvasX:d,canvasY:r,scaleFactor:i}),h.classList.remove("hidden"),h.style.left=`${d}px`,h.style.top=`${r}px`,h.style.color=n,h.style.opacity=t;const s=-V;h.style.transform=`translate(-50%, -50%) rotate(${s}deg) scale(${q})`,h.style.transformOrigin="center center";let l="";if(e){const e=o*i*q,t=a.trim()||"CONFIDENTIAL";l=`<span class="watermark-preview-text" style="font-size: ${e}px; font-weight: bold; font-family: Arial, Helvetica, sans-serif;">${Me(t)}</span>`}else if(U){const e=U.width,n=U.height,o=.5*Math.min(H/e,X/n),a=e*o*q*i,d=n*o*q*i;l=`<img src="${U.src}" style="width: ${a}px; height: ${d}px; opacity: ${t};" alt="Watermark">`}else l=`<span class="watermark-preview-text" style="font-size: ${24*i}px; font-weight: bold; font-family: Arial, Helvetica, sans-serif; color: #ccc;">Select watermark type</span>`;l+='<div class="watermark-handle corner nw" data-corner="nw"></div>',l+='<div class="watermark-handle corner ne" data-corner="ne"></div>',l+='<div class="watermark-handle corner sw" data-corner="sw"></div>',l+='<div class="watermark-handle corner se" data-corner="se"></div>',h.innerHTML=l,h.classList.remove("hidden"),function(){const e=h.querySelectorAll(".corner"),t=(t,n,o)=>{if(!u||!R)return;const a=u.getBoundingClientRect();if(re=!0,Array.from(e).includes(o)){oe=!0,de=o.dataset.corner;const e=W/H,i=z*e,d=Y-G*e,r=t-a.left,s=n-a.top;return ae=r,ie=s,he=Math.sqrt(Math.pow(r-i,2)+Math.pow(s-d,2)),me=q||1,o.style.transform="scale(1.2)",void(o.style.backgroundColor="rgba(59, 130, 246, 0.8)")}return o===h||o.closest("#watermarkPreview")?(ne=!0,ae=t-a.left,ie=n-a.top,function(){ce||function(){if(ce)return;ce=document.createElement("div"),ce.id="alignmentGrid",ce.style.cssText="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            pointer-events: none;\n            opacity: 0;\n            transition: opacity 0.2s ease;\n            z-index: 5;\n        ";const e='\n            <div style="position: absolute; top: 0; left: 50%; width: 1px; height: 100%; background: rgba(59, 130, 246, 0.3); transform: translateX(-50%);"></div>\n            <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: rgba(59, 130, 246, 0.3); transform: translateY(-50%);"></div>\n            <div style="position: absolute; top: 25%; left: 0; width: 100%; height: 1px; background: rgba(59, 130, 246, 0.15);"></div>\n            <div style="position: absolute; top: 75%; left: 0; width: 100%; height: 1px; background: rgba(59, 130, 246, 0.15);"></div>\n            <div style="position: absolute; top: 0; left: 25%; width: 1px; height: 100%; background: rgba(59, 130, 246, 0.15);"></div>\n            <div style="position: absolute; top: 0; left: 75%; width: 1px; height: 100%; background: rgba(59, 130, 246, 0.15);"></div>\n        ';ce.innerHTML=e,m.appendChild(ce)}();ce.style.opacity="1",ue=!0}(),h.style.transition="none",void(h.style.cursor="grabbing")):void 0};h.addEventListener("mousedown",e=>{u&&R&&(t(e.clientX,e.clientY,e.target),e.preventDefault())}),e.forEach(e=>{e.addEventListener("mousedown",n=>{u&&R&&(t(n.clientX,n.clientY,e),n.stopPropagation(),n.preventDefault())})}),h.addEventListener("touchstart",e=>{if(!u||!R)return;const n=e.touches[0];n&&(t(n.clientX,n.clientY,e.target),e.preventDefault())},{passive:!1}),e.forEach(e=>{e.addEventListener("touchstart",n=>{if(!u||!R)return;const o=n.touches[0];o&&(t(o.clientX,o.clientY,e),n.stopPropagation(),n.preventDefault())},{passive:!1})})}()}function Pe(){ce&&(ce.style.opacity="0"),ue=!1}function Ce(e,t){if(ne){const n=H/W;let o=e,a=t;const i=10,d=[.25*W,.5*W,.75*W,.25*Y,.5*Y,.75*Y];for(const t of d)if(Math.abs(e-t)<i){o=t;break}z+=(o-ae)*n,G+=-(a-ie)*n,z=Math.max(0,Math.min(z,H)),G=Math.max(0,Math.min(G,X)),_&&(_.value=z.toFixed(2)),S&&(S.value=G.toFixed(2)),ae=o,ie=a,Fe()}else if(oe){const n=W/H,o=z*n,a=Y-G*n,i=Math.sqrt(Math.pow(e-o,2)+Math.pow(t-a,2))/he;let d=3;const r=f?.checked;if(r){const e=parseInt(M?.value||72),t=e*(I?.value||"CONFIDENTIAL").length*.6,n=.95*H/t,o=.95*X/(1.2*e);d=Math.max(.5,Math.min(n,o,5))}else if(U){const e=.5*Math.min(H/U.width,X/U.height),t=U.width*e,n=U.height*e,o=.95*H/t,a=.95*X/n;d=Math.max(.5,Math.min(o,a,5))}q=Math.max(.1,Math.min(d,me*i));const s=document.getElementById("scale_slider"),l=document.getElementById("scaleValue");s&&(s.value=q,l&&(l.textContent=Math.round(100*q)+"%")),N&&(N.value=q.toFixed(2)),Fe()}}ke&&ke.addEventListener("change",()=>{be&&(be.disabled=!0,be.value="")}),Be&&Be.addEventListener("change",()=>{be&&(be.disabled=!0,be.value="")}),xe&&be&&xe.addEventListener("change",()=>{be.disabled=!1,be.focus()}),w.addEventListener("change",async e=>{j=parseInt(e.target.value),await Le(j)}),u.addEventListener("mousedown",e=>{if(!R)return;if(e.target.closest("#watermarkPreview"))return;const t=u.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,a=H/W;z=n*a,G=(Y-o)*a,(void 0===V||isNaN(V))&&(V=0),(void 0===q||isNaN(q))&&(q=1),_&&(_.value=z.toFixed(2)),S&&(S.value=G.toFixed(2)),T&&(T.value="custom"),A&&(A.value=V.toFixed(1)),N&&(N.value=q.toFixed(2)),Fe()}),document.addEventListener("mousemove",e=>{if(!R||null===z||null===G)return;const t=u.getBoundingClientRect();Ce(e.clientX-t.left,e.clientY-t.top)}),document.addEventListener("touchmove",e=>{if(!R||null===z||null===G)return;if(2===e.touches.length&&re){const t=e.touches[0],n=e.touches[1],o=Math.sqrt(Math.pow(n.clientX-t.clientX,2)+Math.pow(n.clientY-t.clientY,2));if(se){const e=o/le;let t=3;const n=f?.checked;if(n){const e=parseInt(M?.value||72),n=e*(I?.value||"CONFIDENTIAL").length*.6,o=.95*H/n,a=.95*X/(1.2*e);t=Math.max(.5,Math.min(o,a,5))}else if(U){const e=.5*Math.min(H/U.width,X/U.height),n=U.width*e,o=U.height*e,a=.95*H/n,i=.95*X/o;t=Math.max(.5,Math.min(a,i,5))}q=Math.max(.1,Math.min(t,me*e));const a=document.getElementById("scale_slider"),i=document.getElementById("scaleValue");a&&(a.value=q,i&&(i.textContent=Math.round(100*q)+"%")),N&&(N.value=q.toFixed(2)),Fe()}else se=!0,le=o,me=q;return void e.preventDefault()}const t=e.touches[0];if(!t)return;const n=u.getBoundingClientRect(),o=t.clientX-n.left,a=t.clientY-n.top;(ne||oe)&&Ce(o,a),(ne||oe||se)&&e.preventDefault()},{passive:!1}),document.addEventListener("mouseup",()=>{if(re){ne=!1,oe=!1,de=null,re=!1,Pe(),h&&(h.style.transition="transform 0.2s ease",h.style.cursor="grab");const e=h?.querySelectorAll(".corner");e&&e.forEach(e=>{e.style.transform="scale(1)",e.style.backgroundColor="rgba(59, 130, 246, 0.6)"})}}),document.addEventListener("touchend",()=>{if(re){ne=!1,oe=!1,se=!1,de=null,re=!1,Pe(),h&&(h.style.transition="transform 0.2s ease");const e=h?.querySelectorAll(".corner");e&&e.forEach(e=>{e.style.transform="scale(1)",e.style.backgroundColor="rgba(59, 130, 246, 0.6)"})}});const Me=window.escapeHtml||function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML};function De(){window.hideDownload("downloadContainer")}function Te(){g&&g.classList.add("hidden")}function _e(e){p&&(p.disabled=e);d.querySelectorAll("input, select, textarea, button").forEach(t=>{t!==p&&(t.disabled=e)})}d.addEventListener("submit",async e=>{if(e.preventDefault(),null!==z&&null!==G||Ie(),null===z||null===G)return void window.showError("Please wait for PDF to load, then adjust the watermark.","editorResult");const t=new FormData,n=window.FILE_INPUT_NAME||"pdf_file",o=r?.files&&r.files.length>0?r.files:s?.files&&s.files.length>0?s.files:null,a=Boolean(window.BATCH_ENABLED&&window.IS_PREMIUM&&o&&o.length>1&&window.BATCH_API_URL&&window.BATCH_FIELD_NAME),i=o?.[0]||null;if(!i)return void window.showError(window.SELECT_FILE_MESSAGE||"Please select a file","editorResult");if(a){const e=window.BATCH_FIELD_NAME;Array.from(o).forEach(n=>{t.append(e,n)})}else t.append(n,i);const d=v?.checked?"image":"text";t.append("watermark_type",d),t.append("position",T.value||"custom");const l=parseFloat(_.value),c=parseFloat(S.value);if(isNaN(l)||isNaN(c))return void window.showError("Invalid watermark position. Please click on the PDF to set the position.","editorResult");t.append("x",l.toFixed(2)),t.append("y",c.toFixed(2)),t.append("color",b.value),t.append("opacity",(parseInt(P.value)/100).toFixed(2)),t.append("rotation",(V||0).toFixed(1)),t.append("scale",(q||1).toFixed(2));document.getElementById("watermarkPagesAll");const u=document.getElementById("watermarkPagesCurrent"),m=document.getElementById("watermarkPagesCustom"),h=document.getElementById("watermarkPagesCustomInput");let w="all";w=u&&u.checked?j.toString():m&&m.checked&&h&&h.value.trim()?h.value.trim():"all",t.append("pages",w);const p=I?.value||"CONFIDENTIAL";t.append("watermark_text",p),t.append("font_size",M?.value||72),"image"===d&&k?.files?.[0]&&(a?t.append("watermark_image",k.files[0]):t.append("watermark_file",k.files[0])),Te(),De(),window.showLoading("loadingContainer",{showProgress:!a}),_e(!0);try{const e=a?window.BATCH_API_URL:window.API_URL,n=await fetch(e,{method:"POST",headers:{"X-CSRFToken":window.CSRF_TOKEN},body:t});if(!n.ok){const e=await n.json().catch(()=>({}));throw console.log("Error data received:",e),console.log("Error data.error:",e.error),e.error?new Error(e.error):new Error("API returned error but no error message")}const o=await n.blob();window.hideLoading("loadingContainer");const d=n.headers.get("content-disposition");let r=a?"convertica.zip":i.name;if(d){const e=d.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);e&&e[1]&&(r=e[1].replace(/['"]/g,""))}window.showDownloadButton(o,r,"downloadContainer",{successTitle:window.SUCCESS_TITLE||"Editing Complete!",downloadButtonText:window.DOWNLOAD_BUTTON_TEXT||"Download File",convertAnotherText:window.EDIT_ANOTHER_TEXT||"Edit another file",onConvertAnother:()=>{const e=document.getElementById("fileInput"),t=document.getElementById("fileInputDrop"),n=document.getElementById("selectedFile"),o=document.getElementById("fileInfo"),a=document.getElementById("editButton");e&&(e.value=""),t&&(t.value=""),n&&n.classList.add("hidden"),o&&o.classList.remove("hidden"),a&&(a.disabled=!0);const i=document.getElementById("pdfPreviewSection"),d=document.getElementById("watermarkSettingsSection");i&&i.classList.add("hidden"),d&&d.classList.add("hidden"),De(),Te(),_e(!1),window.scrollTo({top:0,behavior:"smooth"}),setTimeout(()=>{const e=document.getElementById("selectFileButton");e&&e.focus({preventScroll:!0})},800)}}),_e(!1)}catch(e){window.hideLoading("loadingContainer"),window.showError(e.message||window.ERROR_MESSAGE,"editorResult"),_e(!1)}})});