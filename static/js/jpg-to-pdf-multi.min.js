document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("converterForm");if(!e)return;const n=document.getElementById("fileInput"),t=document.getElementById("fileInputDrop"),o=document.getElementById("selectFileButton"),r=document.getElementById("addMoreFilesButton"),i=document.getElementById("selectedFilesContainer"),d=document.getElementById("selectedFilesList"),a=document.getElementById("fileCount"),l=document.getElementById("convertButton"),s=document.getElementById("dropZone"),c=document.getElementById("converterResult");let u=[];d&&d.addEventListener("click",e=>{const n=e.target.closest("button[data-file-index]");if(n){e.preventDefault(),e.stopPropagation();const t=parseInt(n.dataset.fileIndex,10);isNaN(t)||f(t)}});const w=document.createElement("div");w.id="loadingContainer",w.className="hidden mt-6";const m=document.createElement("div");function E(e){e&&0!==e.length&&(Array.from(e).forEach(e=>{u.some(n=>n.name===e.name&&n.size===e.size)||u.push(e)}),h(),L())}if(m.id="downloadContainer",m.className="hidden mt-6",n&&n.addEventListener("change",e=>{E(e.target.files)}),t&&t.addEventListener("change",e=>{E(e.target.files)}),o&&o.addEventListener("click",()=>{n?.click()}),r&&r.addEventListener("click",()=>{n?.click()}),s){function g(e){e.preventDefault(),e.stopPropagation()}["dragenter","dragover","dragleave","drop"].forEach(e=>{s.addEventListener(e,g,!1)}),["dragenter","dragover"].forEach(e=>{s.addEventListener(e,()=>{s.classList.add("border-blue-500","bg-blue-100")},!1)}),["dragleave","drop"].forEach(e=>{s.addEventListener(e,()=>{s.classList.remove("border-blue-500","bg-blue-100")},!1)}),s.addEventListener("drop",e=>{E(e.dataTransfer.files)},!1)}function f(e){e<0||e>=u.length||(u.splice(e,1),h(),L())}function h(){d&&(a.textContent=u.length,0!==u.length?(i.classList.remove("hidden"),d.innerHTML=u.map((e,n)=>{const t=v(e.size);return`\n                <div class="flex items-center justify-between p-2.5 bg-white rounded-lg border border-gray-200 hover:border-blue-300 transition-colors group">\n                    <div class="flex items-center space-x-3 flex-1 min-w-0">\n                        <svg class="w-5 h-5 text-pink-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>\n                        </svg>\n                        <div class="flex-1 min-w-0">\n                            <p class="font-medium text-gray-900 text-sm truncate" title="${p(e.name)}">${p(e.name)}</p>\n                            <p class="text-gray-500 text-xs">${t}</p>\n                        </div>\n                    </div>\n                    <button type="button"\n                            class="ml-3 p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors flex-shrink-0 opacity-0 group-hover:opacity-100"\n                            data-file-index="${n}"\n                            onclick="removeFileAtIndex(${n})"\n                            aria-label="Remove file">\n                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                        </svg>\n                    </button>\n                </div>\n            `}).join("")):i.classList.add("hidden"))}window.removeFileAtIndex=function(e){f(e)};const v=window.formatFileSize||function(e){if(0===e)return"0 Bytes";const n=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,n)*100)/100+" "+["Bytes","KB","MB","GB"][n]},p=window.escapeHtml||function(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML};function L(){l&&(l.disabled=0===u.length)}function C(){window.hideDownload("downloadContainer")}function b(){c&&c.classList.add("hidden")}function y(e){l&&(l.disabled=e||0===u.length,e?l.classList.add("opacity-50","cursor-not-allowed"):l.classList.remove("opacity-50","cursor-not-allowed")),n&&(n.disabled=e),t&&(t.disabled=e)}e.addEventListener("submit",async r=>{if(r.preventDefault(),0===u.length)return void showError(window.SELECT_FILE_MESSAGE||"Please select at least one image file");b(),C(),window.showLoading("loadingContainer"),y(!0);const i=new FormData,d=window.FILE_INPUT_NAME||"image_file";u.forEach(e=>{i.append(d,e)});const a=document.getElementById("qualitySelect");a&&i.append("quality",a.value),window._onCancelCallback=()=>{window.hideLoading("loadingContainer"),y(!1)};const l=new AbortController;window._currentAbortController=l;try{const r=await fetch(window.API_URL,{method:"POST",body:i,headers:{"X-CSRFToken":window.CSRF_TOKEN||""},signal:l.signal});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error||window.ERROR_MESSAGE||"Conversion failed")}const d=await r.blob();window.hideLoading("loadingContainer"),!m.parentNode&&e.parentNode&&e.parentNode.insertBefore(m,e.nextSibling),window.showDownloadButton(d,function(){if(0===u.length)return"converted.pdf";const e=u[0];let n=e.name;if(window.REPLACE_REGEX&&window.REPLACE_TO)try{const t=new RegExp(window.REPLACE_REGEX,"i");if(n=e.name.replace(t,window.REPLACE_TO),u.length>1){const e=n.replace(/\.pdf$/i,"");n=`${e}_and_${u.length-1}_more.pdf`}}catch(e){console.warn("Invalid regex pattern:",window.REPLACE_REGEX)}return n}(),"downloadContainer",{successTitle:window.SUCCESS_TITLE||"Conversion Complete!",successMessage:window.SUCCESS_MESSAGE||"Your PDF is ready to download",downloadButtonText:window.DOWNLOAD_BUTTON_TEXT||"Download PDF",convertAnotherText:window.CONVERT_ANOTHER_TEXT||"Convert another file",onConvertAnother:()=>{u=[],h(),L(),n&&(n.value=""),t&&(t.value=""),C(),b(),y(!1),window.scrollTo({top:0,behavior:"smooth"}),setTimeout(()=>{o&&o.focus({preventScroll:!0})},800)}})}catch(e){if(e&&"AbortError"===e.name)return;"undefined"!=typeof console&&console.error&&console.error("Conversion error:",e),window.hideLoading("loadingContainer"),window.showError(e.message,"converterResult")}finally{y(!1)}})});