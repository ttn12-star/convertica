document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("compareForm");if(!e)return;const t=document.getElementById("compareButton"),n=document.getElementById("diffThreshold"),a=document.getElementById("diffThresholdValue"),o=document.getElementById("pdfFile1"),r=document.getElementById("pdfFile2"),i=document.getElementById("comparisonPreview"),d=document.getElementById("compareDownloadButton"),s=document.getElementById("comparePrevButton"),c=document.getElementById("compareNextButton"),l=document.getElementById("comparePageIndicator"),m=document.getElementById("comparePageList"),g=document.getElementById("compareSummaryGeneratedAt"),p=document.getElementById("compareSummaryPages"),u=document.getElementById("compareSummaryChange"),w=document.getElementById("compareSummaryWordsAdded"),E=document.getElementById("compareSummaryWordsRemoved"),_=document.getElementById("compareMainImage"),f=document.getElementById("compareMainEmpty"),h=document.getElementById("compareMainLoading"),y=document.getElementById("compareBaseImage"),b=document.getElementById("compareUpdatedImage"),P=document.getElementById("comparePageMeta"),v=Array.from(document.querySelectorAll(".compare-view-btn")),R={archiveBlob:null,archiveFilename:null,zip:null,report:null,pages:[],currentPageIndex:0,activeView:"diff",assetUrlCache:new Map,renderToken:0};function A(e){t&&(t.disabled=e,t.classList.toggle("opacity-50",e),t.classList.toggle("cursor-not-allowed",e)),o&&(o.disabled=e),r&&(r.disabled=e),n&&(n.disabled=e)}function I(e){return(new Intl.NumberFormat).format(Number(e)||0)}function C(e){return`${(Number(e)||0).toFixed(2)}%`}function T(){R.assetUrlCache.forEach(e=>{try{URL.revokeObjectURL(e)}catch(e){}}),R.assetUrlCache.clear()}function x(e){h&&(e?(h.classList.remove("hidden"),h.classList.add("flex")):(h.classList.add("hidden"),h.classList.remove("flex")))}function L(){v.forEach(e=>{const t=e.dataset.view===R.activeView;e.classList.toggle("bg-white",t),e.classList.toggle("text-amber-700",t),e.classList.toggle("shadow-sm",t),e.classList.toggle("text-gray-700",!t)})}function S(){const e=R.pages.length,t=0===e?0:R.currentPageIndex+1;l&&(l.textContent=`${window.COMPARE_PAGE_TEXT||"Page"} ${t} ${window.COMPARE_OF_TEXT||"of"} ${e}`),s&&(s.disabled=R.currentPageIndex<=0),c&&(c.disabled=R.currentPageIndex>=e-1)}function O(){const e=R.report||{},t=R.pages,n=t.reduce((e,t)=>e+(t.wordsAdded||0),0),a=t.reduce((e,t)=>e+(t.wordsRemoved||0),0);if(g){const t=function(e){if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short",timeZone:"UTC"}).format(t)}(e.generated_at_utc);g.textContent=t?`UTC: ${t}`:""}p&&(p.textContent=I(e.pages_analyzed||t.length||0)),u&&(u.textContent=C(e.overall_visual_change_percent||0)),w&&(w.textContent=I(n)),E&&(E.textContent=I(a))}function M(){m&&(m.innerHTML="",R.pages.forEach((e,t)=>{const{badge:n,row:a}="present_in_both"===(o=e.status)?{badge:"bg-blue-100 text-blue-800",row:"hover:bg-blue-50/60"}:"added_in_second_pdf"===o?{badge:"bg-emerald-100 text-emerald-800",row:"hover:bg-emerald-50/60"}:"missing_in_second_pdf"===o?{badge:"bg-rose-100 text-rose-800",row:"hover:bg-rose-50/60"}:{badge:"bg-gray-100 text-gray-700",row:"hover:bg-gray-50"};var o;const r=document.createElement("button");r.type="button",r.dataset.pageIndex=String(t),r.className=`w-full text-left px-3.5 py-3.5 transition-colors ${a}`,r.innerHTML=`\n                <div class="flex items-start justify-between gap-3">\n                    <div>\n                        <p class="font-semibold text-gray-900">${window.COMPARE_PAGE_TEXT||"Page"} ${e.pageNumber}</p>\n                        <p class="text-xs text-gray-600 mt-1">${window.COMPARE_VISUAL_CHANGE_TEXT||"Visual change"}: ${C(e.changePercent)}</p>\n                    </div>\n                    <span class="text-[11px] font-semibold px-2 py-1 rounded-full ${n}">\n                        ${function(e){return"present_in_both"===e?window.COMPARE_STATUS_PRESENT||"Compared":"added_in_second_pdf"===e?window.COMPARE_STATUS_ADDED||"Added in updated PDF":"missing_in_second_pdf"===e?window.COMPARE_STATUS_MISSING||"Missing in updated PDF":window.COMPARE_STATUS_UNKNOWN||"Status unknown"}(e.status)}\n                    </span>\n                </div>\n            `,r.addEventListener("click",()=>{$(t)}),m.appendChild(r)}),N())}function N(){if(!m)return;m.querySelectorAll("button[data-page-index]").forEach(e=>{const t=Number(e.dataset.pageIndex)===R.currentPageIndex;e.classList.toggle("bg-amber-50",t),e.classList.toggle("ring-1",t),e.classList.toggle("ring-amber-300",t)})}async function B(e){if(!e||!R.zip)return null;if(R.assetUrlCache.has(e))return R.assetUrlCache.get(e);const t=R.zip.file(e);if(!t)return null;const n=await t.async("blob"),a=URL.createObjectURL(n);return R.assetUrlCache.set(e,a),a}async function D(){const e=R.pages[R.currentPageIndex];if(!e)return;const t=++R.renderToken;x(!0),f&&f.classList.add("hidden");try{const[n,a,o]=await Promise.all([B(e.diffImagePath),B(e.baseImagePath),B(e.compareImagePath)]);if(t!==R.renderToken)return;const r="base"===R.activeView?a:"compare"===R.activeView?o:n;_&&r&&(_.src=r,_.classList.remove("hidden")),y&&a&&(y.src=a),b&&o&&(b.src=o),P&&(P.innerHTML=function(e){const t=window.COMPARE_CHANGED_PIXELS_TEXT||"Changed pixels",n=window.COMPARE_TOTAL_PIXELS_TEXT||"Total pixels",a=window.COMPARE_WORDS_ADDED_TEXT||"Words added",o=window.COMPARE_WORDS_REMOVED_TEXT||"Words removed",r=window.COMPARE_TEXT_SIMILARITY_TEXT||"Text similarity";return`\n            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2.5">\n                <p><span class="font-semibold text-gray-900">${t}:</span> ${I(e.changedPixels)}</p>\n                <p><span class="font-semibold text-gray-900">${n}:</span> ${I(e.totalPixels)}</p>\n                <p><span class="font-semibold text-gray-900">${a}:</span> ${I(e.wordsAdded)}</p>\n                <p><span class="font-semibold text-gray-900">${o}:</span> ${I(e.wordsRemoved)}</p>\n                <p><span class="font-semibold text-gray-900">${r}:</span> ${C(e.textSimilarityPercent)}</p>\n            </div>\n        `}(e))}finally{t===R.renderToken&&(x(!1),N(),S())}}async function $(e){e<0||e>=R.pages.length||(R.currentPageIndex=e,await D())}async function U(){if(!R.archiveBlob||!R.archiveFilename||!d)return;const e=window.COMPARE_DOWNLOAD_REPORT_TEXT||"Download ZIP Report";d.disabled=!0,d.textContent=window.COMPARE_DOWNLOAD_IN_PROGRESS_TEXT||"Preparing download...";try{await async function(e,t){if(window.showSaveFilePicker)try{const n=await window.showSaveFilePicker({suggestedName:t,types:[{description:"ZIP archive",accept:{"application/zip":[".zip"]}}]}),a=await n.createWritable();return await a.write(e),void await a.close()}catch(e){if(e&&"AbortError"===e.name)return}const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(()=>{URL.revokeObjectURL(n)},1e3)}(R.archiveBlob,R.archiveFilename)}catch(e){window.showError(e.message||window.COMPARE_DOWNLOAD_FAILED_TEXT||"Failed to download report ZIP.","converterResult")}finally{d.disabled=!1,d.textContent=e}}n&&a&&n.addEventListener("input",()=>{a.textContent=n.value}),v.forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.view;t&&t!==R.activeView&&(R.activeView=t,L(),await D())})}),s&&s.addEventListener("click",async()=>{await $(R.currentPageIndex-1)}),c&&c.addEventListener("click",async()=>{await $(R.currentPageIndex+1)}),d&&d.addEventListener("click",async()=>{await U()}),e.addEventListener("submit",async e=>{e.preventDefault();const t=o?.files?.[0],a=r?.files?.[0];if(!t||!a)return void window.showError(window.COMPARE_FILE_MESSAGE||"Please select two PDF files.","converterResult");R.archiveBlob=null,R.archiveFilename=null,R.zip=null,R.report=null,R.pages=[],R.currentPageIndex=0,R.activeView="diff",R.renderToken+=1,T(),i&&i.classList.add("hidden"),_&&(_.classList.add("hidden"),_.removeAttribute("src")),f&&f.classList.remove("hidden"),m&&(m.innerHTML=""),P&&(P.textContent=""),y&&y.removeAttribute("src"),b&&b.removeAttribute("src"),window.hideError("converterResult"),window.hideDownload("downloadContainer"),window.showLoading("loadingContainer",{showProgress:!0}),A(!0);const s=new FormData;s.append("pdf_file_1",t),s.append("pdf_file_2",a),s.append("diff_threshold",n?.value||"32");try{const e=await fetch(window.COMPARE_API_URL,{method:"POST",headers:{"X-CSRFToken":window.CSRF_TOKEN||""},body:s});if(!e.ok){let t=window.COMPARE_ERROR_MESSAGE||"Comparison failed.";try{t=(await e.json()).error||t}catch(e){}throw new Error(t)}const n=await e.blob(),o=function(e,t){const n=(e.headers.get("content-disposition")||"").match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);return n&&n[1]?n[1].replace(/['"]/g,""):t}(e,function(e,t){return`${(e?.name||"base").replace(/\.pdf$/i,"")}_vs_${(t?.name||"compare").replace(/\.pdf$/i,"")}_convertica.zip`}(t,a)),r=await async function(e){if(void 0===window.JSZip)throw new Error(window.COMPARE_ARCHIVE_ERROR_MESSAGE||"Could not read comparison archive. Please try again.");const t=await window.JSZip.loadAsync(e),n=t.file("report.json");if(!n)throw new Error(window.COMPARE_REPORT_MISSING_MESSAGE||"Comparison report is incomplete. Please run the comparison again.");const a=await n.async("text");let o;try{o=JSON.parse(a)}catch(e){throw new Error(window.COMPARE_ARCHIVE_ERROR_MESSAGE||"Could not read comparison archive. Please try again.")}const r=(Array.isArray(o.page_reports)?o.page_reports:[]).map((e,t)=>({pageNumber:Number(e.page)||t+1,status:e.status||"",changePercent:Number(e.change_percent)||0,changedPixels:Number(e.changed_pixels)||0,totalPixels:Number(e.total_pixels)||0,wordsAdded:Number(e.words_added)||0,wordsRemoved:Number(e.words_removed)||0,textSimilarityPercent:Number(e.text_similarity_percent)||0,diffImagePath:e.diff_image||"",baseImagePath:e.base_image||"",compareImagePath:e.compare_image||""}));if(0===r.length)throw new Error(window.COMPARE_NO_PAGES_MESSAGE||"No pages found in comparison report.");return{zip:t,report:o,pages:r}}(n);window.hideLoading("loadingContainer",!0),await async function(e,t,n){T(),R.zip=e.zip,R.report=e.report,R.pages=e.pages,R.archiveBlob=t,R.archiveFilename=n,R.currentPageIndex=0,R.activeView="diff",L(),O(),M(),S(),d&&(d.disabled=!1,d.textContent=window.COMPARE_DOWNLOAD_REPORT_TEXT||"Download ZIP Report"),i&&(i.classList.remove("hidden"),i.scrollIntoView({behavior:"smooth",block:"start"})),await D()}(r,n,o)}catch(e){window.hideLoading("loadingContainer"),window.showError(e.message||window.COMPARE_ERROR_MESSAGE||"Comparison failed.","converterResult")}finally{A(!1)}})});