document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("compareForm");if(!e)return;const t=document.getElementById("compareButton"),n=document.getElementById("diffThreshold"),a=document.getElementById("diffThresholdValue"),r=document.getElementById("pdfFile1"),o=document.getElementById("pdfFile2"),i=document.getElementById("comparisonPreview"),d=document.getElementById("compareDownloadButton"),s=document.getElementById("comparePrevButton"),c=document.getElementById("compareNextButton"),l=document.getElementById("comparePageIndicator"),m=document.getElementById("comparePageList"),u=document.getElementById("compareSummaryGeneratedAt"),g=document.getElementById("compareSummaryPages"),p=document.getElementById("compareSummaryChange"),w=document.getElementById("compareSummaryWordsAdded"),E=document.getElementById("compareSummaryWordsRemoved"),f=document.getElementById("compareMainImage"),_=document.getElementById("compareMainEmpty"),h=document.getElementById("compareMainLoading"),y=document.getElementById("compareMainViewport"),b=document.getElementById("compareBaseImage"),P=document.getElementById("compareUpdatedImage"),v=document.getElementById("comparePageMeta"),R=Array.from(document.querySelectorAll(".compare-view-btn")),x={archiveBlob:null,archiveFilename:null,zip:null,report:null,pages:[],currentPageIndex:0,activeView:"diff",assetUrlCache:new Map,renderToken:0};function A(e){t&&(t.disabled=e,t.classList.toggle("opacity-50",e),t.classList.toggle("cursor-not-allowed",e)),r&&(r.disabled=e),o&&(o.disabled=e),n&&(n.disabled=e)}function C(e){return(new Intl.NumberFormat).format(Number(e)||0)}function I(e){return`${(Number(e)||0).toFixed(2)}%`}function T(){x.assetUrlCache.forEach(e=>{try{URL.revokeObjectURL(e)}catch(e){}}),x.assetUrlCache.clear()}function L(){return Boolean(i&&!i.classList.contains("hidden")&&x.pages.length>0)}function S(e){h&&(e?(h.classList.remove("hidden"),h.classList.add("flex")):(h.classList.add("hidden"),h.classList.remove("flex")))}function O(){R.forEach(e=>{const t=e.dataset.view===x.activeView;e.classList.toggle("bg-white",t),e.classList.toggle("text-amber-700",t),e.classList.toggle("shadow-sm",t),e.classList.toggle("text-gray-700",!t)})}function M(){const e=x.pages.length,t=0===e?0:x.currentPageIndex+1;l&&(l.textContent=`${window.COMPARE_PAGE_TEXT||"Page"} ${t} ${window.COMPARE_OF_TEXT||"of"} ${e}`),s&&(s.disabled=x.currentPageIndex<=0),c&&(c.disabled=x.currentPageIndex>=e-1)}function N(){const e=x.report||{},t=x.pages,n=t.reduce((e,t)=>e+(t.wordsAdded||0),0),a=t.reduce((e,t)=>e+(t.wordsRemoved||0),0);if(u){const t=function(e){if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":new Intl.DateTimeFormat(void 0,{dateStyle:"medium",timeStyle:"short",timeZone:"UTC"}).format(t)}(e.generated_at_utc);u.textContent=t?`UTC: ${t}`:""}g&&(g.textContent=C(e.pages_analyzed||t.length||0)),p&&(p.textContent=I(e.overall_visual_change_percent||0)),w&&(w.textContent=C(n)),E&&(E.textContent=C(a))}function B(){m&&(m.innerHTML="",x.pages.forEach((e,t)=>{const{badge:n,row:a}="present_in_both"===(r=e.status)?{badge:"bg-blue-100 text-blue-800",row:"hover:bg-blue-50/60"}:"added_in_second_pdf"===r?{badge:"bg-emerald-100 text-emerald-800",row:"hover:bg-emerald-50/60"}:"missing_in_second_pdf"===r?{badge:"bg-rose-100 text-rose-800",row:"hover:bg-rose-50/60"}:{badge:"bg-gray-100 text-gray-700",row:"hover:bg-gray-50"};var r;const o=document.createElement("button");o.type="button",o.dataset.pageIndex=String(t),o.className=`w-full text-left px-3.5 py-3.5 transition-colors ${a}`,o.innerHTML=`\n                <div class="flex items-start justify-between gap-3">\n                    <div>\n                        <p class="font-semibold text-gray-900">${window.COMPARE_PAGE_TEXT||"Page"} ${e.pageNumber}</p>\n                        <p class="text-xs text-gray-600 mt-1">${window.COMPARE_VISUAL_CHANGE_TEXT||"Visual change"}: ${I(e.changePercent)}</p>\n                    </div>\n                    <span class="text-[11px] font-semibold px-2 py-1 rounded-full ${n}">\n                        ${function(e){return"present_in_both"===e?window.COMPARE_STATUS_PRESENT||"Compared":"added_in_second_pdf"===e?window.COMPARE_STATUS_ADDED||"Added in updated PDF":"missing_in_second_pdf"===e?window.COMPARE_STATUS_MISSING||"Missing in updated PDF":window.COMPARE_STATUS_UNKNOWN||"Status unknown"}(e.status)}\n                    </span>\n                </div>\n            `,o.addEventListener("click",()=>{U(t)}),m.appendChild(o)}),D())}function D(){if(!m)return;m.querySelectorAll("button[data-page-index]").forEach(e=>{const t=Number(e.dataset.pageIndex)===x.currentPageIndex;e.classList.toggle("bg-amber-50",t),e.classList.toggle("ring-1",t),e.classList.toggle("ring-amber-300",t)})}async function $(e){if(!e||!x.zip)return null;if(x.assetUrlCache.has(e))return x.assetUrlCache.get(e);const t=x.zip.file(e);if(!t)return null;const n=await t.async("blob"),a=URL.createObjectURL(n);return x.assetUrlCache.set(e,a),a}async function k(){const e=x.pages[x.currentPageIndex];if(!e)return;const t=++x.renderToken;S(!0),_&&_.classList.add("hidden");try{const[n,a,r]=await Promise.all([$(e.diffImagePath),$(e.baseImagePath),$(e.compareImagePath)]);if(t!==x.renderToken)return;const o="base"===x.activeView?a:"compare"===x.activeView?r:n;f&&o&&(f.src=o,f.classList.remove("hidden")),b&&a&&(b.src=a),P&&r&&(P.src=r),v&&(v.innerHTML=function(e){const t=window.COMPARE_CHANGED_PIXELS_TEXT||"Changed pixels",n=window.COMPARE_TOTAL_PIXELS_TEXT||"Total pixels",a=window.COMPARE_WORDS_ADDED_TEXT||"Words added",r=window.COMPARE_WORDS_REMOVED_TEXT||"Words removed",o=window.COMPARE_TEXT_SIMILARITY_TEXT||"Text similarity";return`\n            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2.5">\n                <p><span class="font-semibold text-gray-900">${t}:</span> ${C(e.changedPixels)}</p>\n                <p><span class="font-semibold text-gray-900">${n}:</span> ${C(e.totalPixels)}</p>\n                <p><span class="font-semibold text-gray-900">${a}:</span> ${C(e.wordsAdded)}</p>\n                <p><span class="font-semibold text-gray-900">${r}:</span> ${C(e.wordsRemoved)}</p>\n                <p><span class="font-semibold text-gray-900">${o}:</span> ${I(e.textSimilarityPercent)}</p>\n            </div>\n        `}(e))}finally{t===x.renderToken&&(S(!1),D(),M())}}async function U(e){e<0||e>=x.pages.length||(x.currentPageIndex=e,await k())}async function F(){if(!x.archiveBlob||!x.archiveFilename||!d)return;const e=window.COMPARE_DOWNLOAD_REPORT_TEXT||"Export Report";d.disabled=!0,d.textContent=window.COMPARE_DOWNLOAD_IN_PROGRESS_TEXT||"Preparing report export...";try{await async function(e,t){if(window.showSaveFilePicker)try{const n=await window.showSaveFilePicker({suggestedName:t,types:[{description:"Comparison report archive",accept:{"application/zip":[".zip"]}}]}),a=await n.createWritable();return await a.write(e),void await a.close()}catch(e){if(e&&"AbortError"===e.name)return}const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(()=>{URL.revokeObjectURL(n)},1e3)}(x.archiveBlob,x.archiveFilename)}catch(e){window.showError(e.message||window.COMPARE_DOWNLOAD_FAILED_TEXT||"Failed to export report.","converterResult")}finally{d.disabled=!1,d.textContent=e}}n&&a&&n.addEventListener("input",()=>{a.textContent=n.value}),R.forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.view;t&&t!==x.activeView&&(x.activeView=t,O(),await k())})}),s&&s.addEventListener("click",async()=>{await U(x.currentPageIndex-1)}),c&&c.addEventListener("click",async()=>{await U(x.currentPageIndex+1)}),d&&d.addEventListener("click",async()=>{await F()}),document.addEventListener("keydown",async e=>{if(L()&&!function(e){if(!e)return!1;const t=(e.tagName||"").toLowerCase();return"input"===t||"textarea"===t||"select"===t||e.isContentEditable}(e.target))return"ArrowRight"===e.key||"PageDown"===e.key?(e.preventDefault(),void await U(x.currentPageIndex+1)):void("ArrowLeft"!==e.key&&"PageUp"!==e.key||(e.preventDefault(),await U(x.currentPageIndex-1)))}),y&&y.addEventListener("click",async e=>{if(!L())return;const t=y.getBoundingClientRect();e.clientX-t.left<t.width/2?await U(x.currentPageIndex-1):await U(x.currentPageIndex+1)}),e.addEventListener("submit",async e=>{e.preventDefault();const t=r?.files?.[0],a=o?.files?.[0];if(!t||!a)return void window.showError(window.COMPARE_FILE_MESSAGE||"Please select two PDF files.","converterResult");x.archiveBlob=null,x.archiveFilename=null,x.zip=null,x.report=null,x.pages=[],x.currentPageIndex=0,x.activeView="diff",x.renderToken+=1,T(),i&&i.classList.add("hidden"),f&&(f.classList.add("hidden"),f.removeAttribute("src")),_&&_.classList.remove("hidden"),m&&(m.innerHTML=""),v&&(v.textContent=""),b&&b.removeAttribute("src"),P&&P.removeAttribute("src"),window.hideError("converterResult"),window.hideDownload("downloadContainer"),window.showLoading("loadingContainer",{showProgress:!0}),A(!0);const s=new FormData;s.append("pdf_file_1",t),s.append("pdf_file_2",a),s.append("diff_threshold",n?.value||"32");try{const e=await fetch(window.COMPARE_API_URL,{method:"POST",headers:{"X-CSRFToken":window.CSRF_TOKEN||""},body:s});if(!e.ok){let t=window.COMPARE_ERROR_MESSAGE||"Comparison failed.";try{t=(await e.json()).error||t}catch(e){}throw new Error(t)}const n=await e.blob(),r=function(e,t){const n=(e.headers.get("content-disposition")||"").match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);return n&&n[1]?n[1].replace(/['"]/g,""):t}(e,function(e,t){return`${(e?.name||"base").replace(/\.pdf$/i,"")}_vs_${(t?.name||"compare").replace(/\.pdf$/i,"")}_convertica.zip`}(t,a)),o=await async function(e){if(void 0===window.JSZip)throw new Error(window.COMPARE_ARCHIVE_ERROR_MESSAGE||"Could not read comparison archive. Please try again.");const t=await window.JSZip.loadAsync(e),n=t.file("report.json");if(!n)throw new Error(window.COMPARE_REPORT_MISSING_MESSAGE||"Comparison report is incomplete. Please run the comparison again.");const a=await n.async("text");let r;try{r=JSON.parse(a)}catch(e){throw new Error(window.COMPARE_ARCHIVE_ERROR_MESSAGE||"Could not read comparison archive. Please try again.")}const o=(Array.isArray(r.page_reports)?r.page_reports:[]).map((e,t)=>({pageNumber:Number(e.page)||t+1,status:e.status||"",changePercent:Number(e.change_percent)||0,changedPixels:Number(e.changed_pixels)||0,totalPixels:Number(e.total_pixels)||0,wordsAdded:Number(e.words_added)||0,wordsRemoved:Number(e.words_removed)||0,textSimilarityPercent:Number(e.text_similarity_percent)||0,diffImagePath:e.diff_image||"",baseImagePath:e.base_image||"",compareImagePath:e.compare_image||""}));if(0===o.length)throw new Error(window.COMPARE_NO_PAGES_MESSAGE||"No pages found in comparison report.");return{zip:t,report:r,pages:o}}(n);window.hideLoading("loadingContainer",!0),await async function(e,t,n){T(),x.zip=e.zip,x.report=e.report,x.pages=e.pages,x.archiveBlob=t,x.archiveFilename=n,x.currentPageIndex=0,x.activeView="diff",O(),N(),B(),M(),d&&(d.disabled=!1,d.textContent=window.COMPARE_DOWNLOAD_REPORT_TEXT||"Export Report"),i&&(i.classList.remove("hidden"),i.scrollIntoView({behavior:"smooth",block:"start"})),await k()}(o,n,r)}catch(e){window.hideLoading("loadingContainer"),window.showError(e.message||window.COMPARE_ERROR_MESSAGE||"Comparison failed.","converterResult")}finally{A(!1)}})});