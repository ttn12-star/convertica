function cancelCurrentOperation(){const e=window._currentTaskId,n=window._currentAbortController,t=window._onCancelCallback;if(e){const n=_getCSRFToken(),t=window.getTaskToken?window.getTaskToken(e):null;fetch("/api/cancel-task/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":n},body:JSON.stringify({task_id:e,task_token:t})}).catch(()=>{}),window.unregisterTaskForCancellation&&window.unregisterTaskForCancellation(e)}if(n)try{n.abort()}catch(e){}window._currentTaskId=null,window._currentAbortController=null,"function"==typeof t&&t(),window._onCancelCallback=null}function _getCSRFToken(){return document.querySelector('meta[name="csrf-token"]')?.content||document.querySelector("[name=csrfmiddlewaretoken]")?.value||null}function formatFileSize(e){if(0===e)return"0 Bytes";const n=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,n)*100)/100+" "+["Bytes","KB","MB","GB"][n]}function escapeHtml(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}function showError(e,n=null){let t=e,o=null,r=null;"object"==typeof e&&null!==e&&(t=e.error||e.message||"An error occurred",o=e.upgrade_url||null,r=e.upgrade_text||null);let a=null;if(n)a=document.getElementById(n);else{const e=["converterResult","editorResult","errorMessage"];for(const n of e)if(a=document.getElementById(n),a)break}let s="";if(o&&r){s=`<a href="${escapeHtml(o)}" class="inline-block mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">${escapeHtml(r)}</a>`}if(!a){const e=document.createElement("div");e.className="bg-red-50 border-2 border-red-200 rounded-xl p-6 shadow-lg animate-fade-in mt-6",e.innerHTML=`\n            <div class="flex items-start space-x-3">\n                <svg class="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                </svg>\n                <div>\n                    <h4 class="font-semibold text-red-800 mb-1">${window.ERROR_TITLE||"Error"}</h4>\n                    <p class="text-red-700 text-sm">${escapeHtml(t)}</p>\n                    ${s}\n                </div>\n            </div>\n        `;const n=document.getElementById("fileInput")||document.getElementById("fileInputDrop");return void(n&&n.parentNode&&n.parentNode.insertBefore(e,n.nextSibling))}const i=`\n        <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6 shadow-lg animate-fade-in">\n            <div class="flex items-start space-x-3">\n                <svg class="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                </svg>\n                <div>\n                    <h4 class="font-semibold text-red-800 mb-1">${window.ERROR_TITLE||"Error"}</h4>\n                    <p class="text-red-700 text-sm">${escapeHtml(t)}</p>\n                    ${s}\n                </div>\n            </div>\n        </div>\n    `;a.innerHTML=i,a.classList.remove("hidden"),"converterResult"===a.id&&a.scrollIntoView({behavior:"smooth",block:"nearest"})}function hideError(e=null){(e?[e]:["converterResult","editorResult","errorMessage"]).forEach(e=>{const n=document.getElementById(e);n&&(n.classList.add("hidden"),n.innerHTML="")})}function showLoading(e="loadingContainer",n={}){const t=document.getElementById(e);if(!t)return;const o=n.title||window.LOADING_TITLE||"Processing your file...",r=n.message||window.LOADING_MESSAGE||"Please wait, this may take a few moments",a=!1!==n.showProgress,s=window.PATIENCE_TITLE||"Everything is going well!",i=window.PATIENCE_MESSAGE||"Large files take a bit longer. Please don't close this page â€” your file is being processed.";t.innerHTML=`\n        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-800 dark:to-gray-900 rounded-2xl p-8 sm:p-12 shadow-lg border-2 border-blue-200 dark:border-gray-700">\n            <div class="flex flex-col items-center justify-center space-y-6">\n                \x3c!-- Animated Spinner --\x3e\n                <div class="relative">\n                    <div class="w-20 h-20 sm:w-24 sm:h-24 border-8 border-blue-200 dark:border-gray-700 border-t-blue-600 dark:border-t-blue-500 rounded-full animate-spin"></div>\n                    <div class="absolute inset-0 flex items-center justify-center">\n                        <svg class="w-10 h-10 sm:w-12 sm:h-12 text-blue-600 dark:text-blue-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>\n                        </svg>\n                    </div>\n                </div>\n\n                \x3c!-- Loading Text --\x3e\n                <div class="text-center">\n                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">${o}</h3>\n                    <p class="text-gray-600 dark:text-gray-300 text-sm sm:text-base mb-4">${r}</p>\n                </div>\n\n                ${a?'\n                \x3c!-- Progress Bar with Percentage --\x3e\n                <div class="w-full max-w-md">\n                    <div class="flex items-center justify-between mb-2">\n                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Progress</span>\n                        <span id="progressPercentage" class="text-sm font-bold text-blue-600 dark:text-blue-400">0%</span>\n                    </div>\n                    <div class="h-3 bg-blue-100 dark:bg-gray-700 rounded-full overflow-hidden shadow-inner">\n                        <div id="progressBar"\n                             class="h-full bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500 dark:from-blue-600 dark:via-purple-600 dark:to-blue-600 rounded-full transition-all duration-300 ease-out"\n                             style="width: 0%">\n                        </div>\n                    </div>\n                    <p id="progressStatusText" class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">Processing your file...</p>\n                </div>\n                ':""}\n\n                \x3c!-- Patience Message (hidden initially, shown after 40 seconds) --\x3e\n                <div id="patienceMessage" class="hidden w-full max-w-md animate-fade-in">\n                    <div class="bg-gradient-to-r from-emerald-100 to-teal-100 dark:from-emerald-900/30 dark:to-teal-900/30 border-2 border-emerald-400 dark:border-emerald-700 rounded-xl p-4 sm:p-5 shadow-md">\n                        <div class="flex items-start space-x-3">\n                            <div class="flex-shrink-0">\n                                <div class="w-10 h-10 bg-emerald-500 dark:bg-emerald-600 rounded-full flex items-center justify-center shadow-sm">\n                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>\n                                    </svg>\n                                </div>\n                            </div>\n                            <div>\n                                <h4 class="font-bold text-emerald-800 dark:text-emerald-200 text-base mb-1">${s}</h4>\n                                <p class="text-emerald-700 dark:text-emerald-300 text-sm">${i}</p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Action Buttons: Cancel + Continue in Background --\x3e\n                <div class="flex items-center justify-center gap-4 mt-2">\n                    \x3c!-- Cancel Button --\x3e\n                    <button id="cancelOperationBtn" type="button"\n                            class="inline-flex items-center gap-1.5 text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 transition-colors text-sm font-medium px-3 py-1.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20"\n                            title="${window.CANCEL_OPERATION_TEXT||"Cancel operation"}">\n                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>\n                        </svg>\n                        <span>${window.CANCEL_OPERATION_TEXT||"Cancel"}</span>\n                    </button>\n\n                    \x3c!-- Continue in Background Button (Premium only, hidden by default) --\x3e\n                    <button id="sendToBackgroundBtn" type="button"\n                            class="hidden inline-flex items-center gap-1.5 text-blue-500 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors text-sm font-medium px-3 py-1.5 rounded-lg hover:bg-blue-50 dark:hover:bg-blue-900/20"\n                            title="${window.CONTINUE_IN_BACKGROUND_TEXT||"Continue in background"}">\n                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>\n                        </svg>\n                        <span>${window.CONTINUE_IN_BACKGROUND_TEXT||"Continue in background"}</span>\n                    </button>\n                </div>\n            </div>\n        </div>\n\n        <style>\n            @keyframes fade-in {\n                from { opacity: 0; transform: translateY(-10px); }\n                to { opacity: 1; transform: translateY(0); }\n            }\n            .animate-fade-in {\n                animation: fade-in 0.5s ease-out forwards;\n            }\n        </style>\n    `,t.classList.remove("hidden"),t.scrollIntoView({behavior:"smooth",block:"nearest"});const d=document.getElementById("cancelOperationBtn");d&&d.addEventListener("click",()=>cancelCurrentOperation());const l=window.JS_SETTINGS&&window.JS_SETTINGS.patienceMessageDelay||4e4;if(t._patienceTimeout=setTimeout(()=>{const e=document.getElementById("patienceMessage");e&&(e.classList.remove("hidden"),e.scrollIntoView({behavior:"smooth",block:"nearest"}))},l),a){let e=0;const n=200,o=1.5,r=95,a=document.getElementById("progressBar"),s=document.getElementById("progressPercentage"),i=()=>{e<r&&(e+=o,e>70&&(e+=.5*o),e>85&&(e+=.3*o),e>r&&(e=r),a&&s&&(a.style.width=`${e}%`,s.textContent=`${Math.round(e)}%`))};t._progressInterval=setInterval(i,n)}}function hideLoading(e="loadingContainer",n=!1){const t=document.getElementById(e);if(t){if(t._progressInterval&&(clearInterval(t._progressInterval),t._progressInterval=null),t._patienceTimeout&&(clearTimeout(t._patienceTimeout),t._patienceTimeout=null),window._currentTaskId=null,window._currentAbortController=null,window._onCancelCallback=null,n){const e=document.getElementById("progressBar"),n=document.getElementById("progressPercentage");if(e&&n)return e.style.width="100%",n.textContent="100%",void setTimeout(()=>{t.classList.add("hidden")},500)}t.classList.add("hidden")}}async function showDownloadButton(e,n,t="downloadContainer",o={}){const r=document.getElementById(t);if(!r)return;let a=n;if(window.REPLACE_REGEX&&window.REPLACE_TO)try{const e=new RegExp(window.REPLACE_REGEX,"i");a=n.replace(e,window.REPLACE_TO)}catch(e){console.warn("Invalid regex pattern:",window.REPLACE_REGEX)}const s=URL.createObjectURL(e),i=o.successTitle||window.SUCCESS_TITLE||"Conversion Complete!",d=o.successMessage||window.SUCCESS_MESSAGE||"Your file is ready to download",l=o.downloadButtonText||window.DOWNLOAD_BUTTON_TEXT||"Download File",c=o.convertAnotherText||window.CONVERT_ANOTHER_TEXT||"Convert another file",u=!1!==o.showConvertAnother;r.innerHTML=`\n        <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-gray-800 dark:to-gray-800 rounded-2xl p-6 sm:p-8 shadow-lg border-2 border-green-200 dark:border-green-800 animate-fade-in">\n            <div class="flex flex-col items-center justify-center space-y-4">\n                \x3c!-- Success Icon --\x3e\n                <div class="relative">\n                    <div class="w-16 h-16 sm:w-20 sm:h-20 bg-green-500 dark:bg-green-600 rounded-full flex items-center justify-center shadow-lg animate-scale-in">\n                        <svg class="w-10 h-10 sm:w-12 sm:h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>\n                        </svg>\n                    </div>\n                    <div class="absolute inset-0 bg-green-400 dark:bg-green-600 rounded-full animate-ping opacity-75"></div>\n                </div>\n\n                \x3c!-- Success Message --\x3e\n                <div class="text-center">\n                    <h3 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-2">${i}</h3>\n                    <p class="text-gray-700 dark:text-gray-200 text-sm sm:text-base mb-4">${d}</p>\n                    <p class="text-xs text-gray-600 dark:text-gray-300 font-mono break-all">${escapeHtml(a)}</p>\n                </div>\n\n                \x3c!-- Download Button --\x3e\n                <button id="downloadButton"\n                        class="group relative bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 px-8 sm:px-12 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 active:scale-95 transition-all duration-200 flex items-center space-x-3">\n                    <svg class="w-6 h-6 group-hover:animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>\n                    </svg>\n                    <span>${l}</span>\n                </button>\n\n                ${u?`\n                \x3c!-- Convert Another Button --\x3e\n                <button id="convertAnotherButton"\n                        class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 font-medium text-sm sm:text-base transition-colors">\n                    ${c}\n                </button>\n                `:""}\n            </div>\n        </div>\n    `,r.classList.remove("hidden"),setTimeout(()=>{r.scrollIntoView({behavior:"smooth",block:"center"})},100);const w=document.getElementById("downloadButton");if(w&&w.addEventListener("click",async()=>{const n=a.includes(".")?a.slice(a.lastIndexOf(".")):"";let t=a;if(window.showSaveFilePicker)try{const o=await window.showSaveFilePicker({suggestedName:a,types:n?[{description:"File",accept:{"*/*":[n]}}]:void 0}),r=await o.createWritable();return await r.write(e),await r.close(),t=o.name||a,w.classList.add("bg-green-600"),void setTimeout(()=>w.classList.remove("bg-green-600"),200)}catch(e){if(e&&"AbortError"===e.name)return}const o=prompt(window.SAVE_AS_PROMPT||"Save file as",a);o&&o.trim()&&(t=o.trim(),n&&!t.toLowerCase().endsWith(n.toLowerCase())&&(t+=n));const r=document.createElement("a");r.href=s,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),w.classList.add("bg-green-600"),setTimeout(()=>w.classList.remove("bg-green-600"),200)}),u){const e=document.getElementById("convertAnotherButton");e&&o.onConvertAnother&&e.addEventListener("click",o.onConvertAnother)}setTimeout(()=>{URL.revokeObjectURL(s)},6e5)}function hideDownload(e="downloadContainer"){const n=document.getElementById(e);n&&n.classList.add("hidden")}function updateProgress(e,n=null){const t=document.getElementById("progressBar"),o=document.getElementById("progressPercentage"),r=document.querySelector("#loadingContainer .text-xs.text-gray-500");if(r&&n&&(r.textContent=n),!t||!o)return;const a=parseFloat(t.style.width)||0;if(a>=e)return t.style.width=`${e}%`,void(o.textContent=`${Math.round(e)}%`);window._progressAnimationId&&cancelAnimationFrame(window._progressAnimationId);const s=a,i=e-s,d=Math.min(2e3,50*i),l=performance.now();window._progressAnimationId=requestAnimationFrame(function e(n){const r=n-l,a=Math.min(r/d,1),c=1-Math.pow(1-a,3),u=s+i*c;t.style.width=`${u}%`,o.textContent=`${Math.round(u)}%`,a<1&&(window._progressAnimationId=requestAnimationFrame(e))})}async function submitAsyncConversion(e){const{apiUrl:n,formData:t,csrfToken:o,originalFileName:r,loadingContainerId:a="loadingContainer",downloadContainerId:s="downloadContainer",errorContainerId:i="converterResult",onSuccess:d,onError:l,onProgress:c,useAsync:u=null}=e;let w=u;if(null===w){const e=t.get("file")||t.get("pdf_file")||t.get("word_file");w=!(!e||!e.size)&&e.size>5242880}const m=new AbortController;window._currentAbortController=m,showLoading(a,{showProgress:!0});const g=document.getElementById(a);g&&g._progressInterval&&(clearInterval(g._progressInterval),g._progressInterval=null);try{const u=await fetch(n,{method:"POST",headers:{"X-CSRFToken":o},body:t,signal:m.signal});if(202===u.status){const n=await u.json(),t=n.task_id,w=n.task_token;if(!t)throw new Error("No task ID received");if(window._currentTaskId=t,window._currentAbortController=null,w&&window.registerTaskToken&&window.registerTaskToken(t,w),window.IS_PREMIUM){const n=document.getElementById("sendToBackgroundBtn");n&&(n.classList.remove("hidden"),n.addEventListener("click",()=>{window.addBackgroundTask&&window.addBackgroundTask(t,window.CONVERSION_TYPE||"",r),fetch("/api/task-background/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":o},body:JSON.stringify({task_id:t,task_token:w})}).catch(()=>{}),window.unregisterTaskForCancellation&&window.unregisterTaskForCancellation(t),window._currentTaskId=null,window._onCancelCallback=null,hideLoading(a),e.onBackground&&e.onBackground()}))}window.registerTaskForCancellation&&window.registerTaskForCancellation(t,w);const m=()=>trackOperationAbandon(t);window.addEventListener("beforeunload",m),window.addEventListener("pagehide",m);const g=()=>{window.removeEventListener("beforeunload",m),window.removeEventListener("pagehide",m)};await pollTaskStatus(t,{onProgress:(e,n)=>{updateProgress(e,n),c&&c(e,n)},onSuccess:async e=>{updateProgress(95,"Downloading result...");const n=await fetch(`/api/tasks/${t}/result/`,{method:"GET",headers:{"X-CSRFToken":o}});if(!n.ok)throw new Error("Failed to download result");const i=await n.blob(),l=e.output_filename||r;updateProgress(100,"Complete!"),hideLoading(a,!0),window.unregisterTaskForCancellation&&window.unregisterTaskForCancellation(t),g(),d?d(i,l):await showDownloadButton(i,l,s);try{await fetch(`/api/tasks/${t}/result/`,{method:"DELETE",headers:{"X-CSRFToken":o}})}catch(e){}},onError:e=>{window.unregisterTaskForCancellation&&window.unregisterTaskForCancellation(t),g(),hideLoading(a);const n=e||"Conversion failed";showError(n,i),l&&l(n)}})}else if(u.ok){updateProgress(95,"Downloading...");const e=await u.blob(),n=u.headers.get("content-disposition");let t=r;if(n){const e=n.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);e&&e[1]&&(t=e[1].replace(/['"]/g,""))}updateProgress(100,"Complete!"),hideLoading(a,!0),d?d(e,t,u):await showDownloadButton(e,t,s)}else{let e="Conversion failed";try{const n=await u.json();e=n.error||n.detail||e}catch(e){}hideLoading(a),showError(e,i),l&&l(e)}}catch(e){if(e&&"AbortError"===e.name)return void hideLoading(a);hideLoading(a);const n=e.message||"An error occurred";showError(n,i),l&&l(n)}}async function pollTaskStatus(e,n,t=null,o=300){null===t&&(t=window.JS_SETTINGS&&window.JS_SETTINGS.pollInterval||2500);const{onProgress:r,onSuccess:a,onError:s}=n;let i=0;const d=async()=>{if(i++,i>o)s("Task timed out. Please try again with a smaller file.");else try{const n=await fetch(`/api/tasks/${e}/status/`),o=await n.json();switch(o.status){case"SUCCESS":r(90,"Preparing download..."),a(o);break;case"FAILURE":s(o.error||"Conversion failed");break;case"REVOKED":s(o.error||"Task was cancelled");break;case"PROGRESS":r(o.progress||0,o.current_step||"Processing..."),setTimeout(d,t);break;case"PENDING":r(0,o.message||"Waiting in queue..."),setTimeout(d,t);break;case"STARTED":r(5,o.message||"Processing started..."),setTimeout(d,t);break;default:setTimeout(d,t)}}catch(e){i<o?setTimeout(d,2*t):s("Lost connection to server")}};d()}function trackOperationAbandon(e){if(e&&navigator.sendBeacon)try{const n=window.getTaskToken?window.getTaskToken(e):null,t=new Blob([JSON.stringify({task_id:e,task_token:n})],{type:"application/json"});navigator.sendBeacon("/api/operation-abandon/",t)&&console.log(`[Analytics] Marked operation as abandoned: ${e}`)}catch(e){console.error("[Analytics] Failed to track abandonment:",e)}}window._currentTaskId=null,window._currentAbortController=null,window._onCancelCallback=null,"undefined"!=typeof window&&(window.formatFileSize=formatFileSize,window.escapeHtml=escapeHtml,window.showError=showError,window.hideError=hideError,window.showLoading=showLoading,window.hideLoading=hideLoading,window.showDownloadButton=showDownloadButton,window.hideDownload=hideDownload,window.updateProgress=updateProgress,window.submitAsyncConversion=submitAsyncConversion,window.pollTaskStatus=pollTaskStatus,window.trackOperationAbandon=trackOperationAbandon,window.cancelCurrentOperation=cancelCurrentOperation);