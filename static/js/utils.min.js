function formatFileSize(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,t)*100)/100+" "+["Bytes","KB","MB","GB"][t]}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function showError(e,t=null){let n=e,o=null,r=null;"object"==typeof e&&null!==e&&(n=e.error||e.message||"An error occurred",o=e.upgrade_url||null,r=e.upgrade_text||null);let s=null;if(t)s=document.getElementById(t);else{const e=["converterResult","editorResult","errorMessage"];for(const t of e)if(s=document.getElementById(t),s)break}let a="";if(o&&r){a=`<a href="${escapeHtml(o)}" class="inline-block mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">${escapeHtml(r)}</a>`}if(!s){const e=document.createElement("div");e.className="bg-red-50 border-2 border-red-200 rounded-xl p-6 shadow-lg animate-fade-in mt-6",e.innerHTML=`\n            <div class="flex items-start space-x-3">\n                <svg class="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                </svg>\n                <div>\n                    <h4 class="font-semibold text-red-800 mb-1">${window.ERROR_TITLE||"Error"}</h4>\n                    <p class="text-red-700 text-sm">${escapeHtml(n)}</p>\n                    ${a}\n                </div>\n            </div>\n        `;const t=document.getElementById("fileInput")||document.getElementById("fileInputDrop");return void(t&&t.parentNode&&t.parentNode.insertBefore(e,t.nextSibling))}const i=`\n        <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6 shadow-lg animate-fade-in">\n            <div class="flex items-start space-x-3">\n                <svg class="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>\n                </svg>\n                <div>\n                    <h4 class="font-semibold text-red-800 mb-1">${window.ERROR_TITLE||"Error"}</h4>\n                    <p class="text-red-700 text-sm">${escapeHtml(n)}</p>\n                    ${a}\n                </div>\n            </div>\n        </div>\n    `;s.innerHTML=i,s.classList.remove("hidden"),"converterResult"===s.id&&s.scrollIntoView({behavior:"smooth",block:"nearest"})}function hideError(e=null){(e?[e]:["converterResult","editorResult","errorMessage"]).forEach(e=>{const t=document.getElementById(e);t&&(t.classList.add("hidden"),t.innerHTML="")})}function showLoading(e="loadingContainer",t={}){const n=document.getElementById(e);if(!n)return;const o=t.title||window.LOADING_TITLE||"Processing your file...",r=t.message||window.LOADING_MESSAGE||"Please wait, this may take a few moments",s=!1!==t.showProgress,a=window.PATIENCE_TITLE||"Everything is going well!",i=window.PATIENCE_MESSAGE||"Large files take a bit longer. Please don't close this page â€” your file is being processed.";n.innerHTML=`\n        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-gray-800 dark:to-gray-900 rounded-2xl p-8 sm:p-12 shadow-lg border-2 border-blue-200 dark:border-gray-700">\n            <div class="flex flex-col items-center justify-center space-y-6">\n                \x3c!-- Animated Spinner --\x3e\n                <div class="relative">\n                    <div class="w-20 h-20 sm:w-24 sm:h-24 border-8 border-blue-200 dark:border-gray-700 border-t-blue-600 dark:border-t-blue-500 rounded-full animate-spin"></div>\n                    <div class="absolute inset-0 flex items-center justify-center">\n                        <svg class="w-10 h-10 sm:w-12 sm:h-12 text-blue-600 dark:text-blue-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>\n                        </svg>\n                    </div>\n                </div>\n\n                \x3c!-- Loading Text --\x3e\n                <div class="text-center">\n                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">${o}</h3>\n                    <p class="text-gray-600 dark:text-gray-300 text-sm sm:text-base mb-4">${r}</p>\n                </div>\n\n                ${s?'\n                \x3c!-- Progress Bar with Percentage --\x3e\n                <div class="w-full max-w-md">\n                    <div class="flex items-center justify-between mb-2">\n                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Progress</span>\n                        <span id="progressPercentage" class="text-sm font-bold text-blue-600 dark:text-blue-400">0%</span>\n                    </div>\n                    <div class="h-3 bg-blue-100 dark:bg-gray-700 rounded-full overflow-hidden shadow-inner">\n                        <div id="progressBar"\n                             class="h-full bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500 dark:from-blue-600 dark:via-purple-600 dark:to-blue-600 rounded-full transition-all duration-300 ease-out"\n                             style="width: 0%">\n                        </div>\n                    </div>\n                    <p id="progressStatusText" class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-center">Processing your file...</p>\n                </div>\n                ':""}\n\n                \x3c!-- Patience Message (hidden initially, shown after 40 seconds) --\x3e\n                <div id="patienceMessage" class="hidden w-full max-w-md animate-fade-in">\n                    <div class="bg-gradient-to-r from-emerald-100 to-teal-100 dark:from-emerald-900/30 dark:to-teal-900/30 border-2 border-emerald-400 dark:border-emerald-700 rounded-xl p-4 sm:p-5 shadow-md">\n                        <div class="flex items-start space-x-3">\n                            <div class="flex-shrink-0">\n                                <div class="w-10 h-10 bg-emerald-500 dark:bg-emerald-600 rounded-full flex items-center justify-center shadow-sm">\n                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>\n                                    </svg>\n                                </div>\n                            </div>\n                            <div>\n                                <h4 class="font-bold text-emerald-800 dark:text-emerald-200 text-base mb-1">${a}</h4>\n                                <p class="text-emerald-700 dark:text-emerald-300 text-sm">${i}</p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <style>\n            @keyframes fade-in {\n                from { opacity: 0; transform: translateY(-10px); }\n                to { opacity: 1; transform: translateY(0); }\n            }\n            .animate-fade-in {\n                animation: fade-in 0.5s ease-out forwards;\n            }\n        </style>\n    `,n.classList.remove("hidden"),n.scrollIntoView({behavior:"smooth",block:"nearest"});const d=window.JS_SETTINGS&&window.JS_SETTINGS.patienceMessageDelay||4e4;if(n._patienceTimeout=setTimeout(()=>{const e=document.getElementById("patienceMessage");e&&(e.classList.remove("hidden"),e.scrollIntoView({behavior:"smooth",block:"nearest"}))},d),s){let e=0;const t=200,o=1.5,r=95,s=document.getElementById("progressBar"),a=document.getElementById("progressPercentage"),i=()=>{e<r&&(e+=o,e>70&&(e+=.5*o),e>85&&(e+=.3*o),e>r&&(e=r),s&&a&&(s.style.width=`${e}%`,a.textContent=`${Math.round(e)}%`))};n._progressInterval=setInterval(i,t)}}function hideLoading(e="loadingContainer",t=!1){const n=document.getElementById(e);if(n){if(n._progressInterval&&(clearInterval(n._progressInterval),n._progressInterval=null),n._patienceTimeout&&(clearTimeout(n._patienceTimeout),n._patienceTimeout=null),t){const e=document.getElementById("progressBar"),t=document.getElementById("progressPercentage");if(e&&t)return e.style.width="100%",t.textContent="100%",void setTimeout(()=>{n.classList.add("hidden")},500)}n.classList.add("hidden")}}async function showDownloadButton(e,t,n="downloadContainer",o={}){const r=document.getElementById(n);if(!r)return;let s=t;if(window.REPLACE_REGEX&&window.REPLACE_TO)try{const e=new RegExp(window.REPLACE_REGEX,"i");s=t.replace(e,window.REPLACE_TO)}catch(e){console.warn("Invalid regex pattern:",window.REPLACE_REGEX)}const a=URL.createObjectURL(e),i=o.successTitle||window.SUCCESS_TITLE||"Conversion Complete!",d=o.successMessage||window.SUCCESS_MESSAGE||"Your file is ready to download",l=o.downloadButtonText||window.DOWNLOAD_BUTTON_TEXT||"Download File",c=o.convertAnotherText||window.CONVERT_ANOTHER_TEXT||"Convert another file",u=!1!==o.showConvertAnother;r.innerHTML=`\n        <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-gray-800 dark:to-gray-800 rounded-2xl p-6 sm:p-8 shadow-lg border-2 border-green-200 dark:border-green-800 animate-fade-in">\n            <div class="flex flex-col items-center justify-center space-y-4">\n                \x3c!-- Success Icon --\x3e\n                <div class="relative">\n                    <div class="w-16 h-16 sm:w-20 sm:h-20 bg-green-500 dark:bg-green-600 rounded-full flex items-center justify-center shadow-lg animate-scale-in">\n                        <svg class="w-10 h-10 sm:w-12 sm:h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>\n                        </svg>\n                    </div>\n                    <div class="absolute inset-0 bg-green-400 dark:bg-green-600 rounded-full animate-ping opacity-75"></div>\n                </div>\n\n                \x3c!-- Success Message --\x3e\n                <div class="text-center">\n                    <h3 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-2">${i}</h3>\n                    <p class="text-gray-700 dark:text-gray-200 text-sm sm:text-base mb-4">${d}</p>\n                    <p class="text-xs text-gray-600 dark:text-gray-300 font-mono break-all">${escapeHtml(s)}</p>\n                </div>\n\n                \x3c!-- Download Button --\x3e\n                <button id="downloadButton"\n                        class="group relative bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 px-8 sm:px-12 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 active:scale-95 transition-all duration-200 flex items-center space-x-3">\n                    <svg class="w-6 h-6 group-hover:animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>\n                    </svg>\n                    <span>${l}</span>\n                </button>\n\n                ${u?`\n                \x3c!-- Convert Another Button --\x3e\n                <button id="convertAnotherButton"\n                        class="text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 font-medium text-sm sm:text-base transition-colors">\n                    ${c}\n                </button>\n                `:""}\n            </div>\n        </div>\n    `,r.classList.remove("hidden"),setTimeout(()=>{r.scrollIntoView({behavior:"smooth",block:"center"})},100);const m=document.getElementById("downloadButton");if(m&&m.addEventListener("click",async()=>{const t=s.includes(".")?s.slice(s.lastIndexOf(".")):"";let n=s;if(window.showSaveFilePicker)try{const o=await window.showSaveFilePicker({suggestedName:s,types:t?[{description:"File",accept:{"*/*":[t]}}]:void 0}),r=await o.createWritable();return await r.write(e),await r.close(),n=o.name||s,m.classList.add("bg-green-600"),void setTimeout(()=>m.classList.remove("bg-green-600"),200)}catch(e){if(e&&"AbortError"===e.name)return}const o=prompt(window.SAVE_AS_PROMPT||"Save file as",s);o&&o.trim()&&(n=o.trim(),t&&!n.toLowerCase().endsWith(t.toLowerCase())&&(n+=t));const r=document.createElement("a");r.href=a,r.download=n,document.body.appendChild(r),r.click(),document.body.removeChild(r),m.classList.add("bg-green-600"),setTimeout(()=>m.classList.remove("bg-green-600"),200)}),u){const e=document.getElementById("convertAnotherButton");e&&o.onConvertAnother&&e.addEventListener("click",o.onConvertAnother)}setTimeout(()=>{URL.revokeObjectURL(a)},6e5)}function hideDownload(e="downloadContainer"){const t=document.getElementById(e);t&&t.classList.add("hidden")}function updateProgress(e,t=null){const n=document.getElementById("progressBar"),o=document.getElementById("progressPercentage"),r=document.querySelector("#loadingContainer .text-xs.text-gray-500");if(r&&t&&(r.textContent=t),!n||!o)return;const s=parseFloat(n.style.width)||0;if(s>=e)return n.style.width=`${e}%`,void(o.textContent=`${Math.round(e)}%`);window._progressAnimationId&&cancelAnimationFrame(window._progressAnimationId);const a=s,i=e-a,d=Math.min(2e3,50*i),l=performance.now();window._progressAnimationId=requestAnimationFrame(function e(t){const r=t-l,s=Math.min(r/d,1),c=1-Math.pow(1-s,3),u=a+i*c;n.style.width=`${u}%`,o.textContent=`${Math.round(u)}%`,s<1&&(window._progressAnimationId=requestAnimationFrame(e))})}async function submitAsyncConversion(e){const{apiUrl:t,formData:n,csrfToken:o,originalFileName:r,loadingContainerId:s="loadingContainer",downloadContainerId:a="downloadContainer",errorContainerId:i="converterResult",onSuccess:d,onError:l,onProgress:c,useAsync:u=null}=e;let m=u;if(null===m){const e=n.get("file")||n.get("pdf_file")||n.get("word_file");m=!(!e||!e.size)&&e.size>5242880}showLoading(s,{showProgress:!0});const w=document.getElementById(s);w&&w._progressInterval&&(clearInterval(w._progressInterval),w._progressInterval=null);try{const e=await fetch(t,{method:"POST",headers:{"X-CSRFToken":o},body:n});if(202===e.status){const t=(await e.json()).task_id;if(!t)throw new Error("No task ID received");window.registerTaskForCancellation&&window.registerTaskForCancellation(t);const n=()=>trackOperationAbandon(t);window.addEventListener("beforeunload",n),window.addEventListener("pagehide",n);const u=()=>{window.removeEventListener("beforeunload",n),window.removeEventListener("pagehide",n)};await pollTaskStatus(t,{onProgress:(e,t)=>{updateProgress(e,t),c&&c(e,t)},onSuccess:async e=>{updateProgress(95,"Downloading result...");const n=await fetch(`/api/tasks/${t}/result/`,{method:"GET",headers:{"X-CSRFToken":o}});if(!n.ok)throw new Error("Failed to download result");const i=await n.blob(),l=e.output_filename||r;updateProgress(100,"Complete!"),hideLoading(s,!0),window.unregisterTaskForCancellation&&window.unregisterTaskForCancellation(t),u(),d?d(i,l):await showDownloadButton(i,l,a);try{await fetch(`/api/tasks/${t}/result/`,{method:"DELETE",headers:{"X-CSRFToken":o}})}catch(e){}},onError:e=>{window.unregisterTaskForCancellation&&window.unregisterTaskForCancellation(t),u(),hideLoading(s);const n=e||"Conversion failed";showError(n,i),l&&l(n)}})}else if(e.ok){updateProgress(95,"Downloading...");const t=await e.blob(),n=e.headers.get("content-disposition");let o=r;if(n){const e=n.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);e&&e[1]&&(o=e[1].replace(/['"]/g,""))}updateProgress(100,"Complete!"),hideLoading(s,!0),d?d(t,o,e):await showDownloadButton(t,o,a)}else{let t="Conversion failed";try{const n=await e.json();t=n.error||n.detail||t}catch(e){}hideLoading(s),showError(t,i),l&&l(t)}}catch(e){hideLoading(s);const t=e.message||"An error occurred";showError(t,i),l&&l(t)}}async function pollTaskStatus(e,t,n=null,o=300){null===n&&(n=window.JS_SETTINGS&&window.JS_SETTINGS.pollInterval||2500);const{onProgress:r,onSuccess:s,onError:a}=t;let i=0;const d=async()=>{if(i++,i>o)a("Task timed out. Please try again with a smaller file.");else try{const t=await fetch(`/api/tasks/${e}/status/`),o=await t.json();switch(o.status){case"SUCCESS":r(90,"Preparing download..."),s(o);break;case"FAILURE":a(o.error||"Conversion failed");break;case"REVOKED":a(o.error||"Task was cancelled");break;case"PROGRESS":r(o.progress||0,o.current_step||"Processing..."),setTimeout(d,n);break;case"PENDING":r(0,o.message||"Waiting in queue..."),setTimeout(d,n);break;case"STARTED":r(5,o.message||"Processing started..."),setTimeout(d,n);break;default:setTimeout(d,n)}}catch(e){i<o?setTimeout(d,2*n):a("Lost connection to server")}};d()}function trackOperationAbandon(e){if(e&&navigator.sendBeacon)try{const t=new Blob([JSON.stringify({task_id:e})],{type:"application/json"});navigator.sendBeacon("/api/operation-abandon/",t)&&console.log(`[Analytics] Marked operation as abandoned: ${e}`)}catch(e){console.error("[Analytics] Failed to track abandonment:",e)}}"undefined"!=typeof window&&(window.formatFileSize=formatFileSize,window.escapeHtml=escapeHtml,window.showError=showError,window.hideError=hideError,window.showLoading=showLoading,window.hideLoading=hideLoading,window.showDownloadButton=showDownloadButton,window.hideDownload=hideDownload,window.updateProgress=updateProgress,window.submitAsyncConversion=submitAsyncConversion,window.pollTaskStatus=pollTaskStatus,window.trackOperationAbandon=trackOperationAbandon);