class ConversionProgressClient{constructor(e,t={}){this.taskId=e,this.options={onProgress:t.onProgress||this.defaultOnProgress,onCompleted:t.onCompleted||this.defaultOnCompleted,onError:t.onError||this.defaultOnError,onConnected:t.onConnected||this.defaultOnConnected,onDisconnected:t.onDisconnected||this.defaultOnDisconnected,reconnectAttempts:t.reconnectAttempts||3,reconnectDelay:t.reconnectDelay||2e3,pingInterval:t.pingInterval||3e4},this.ws=null,this.reconnectCount=0,this.pingTimer=null,this.isConnected=!1}connect(){const e=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/ws/conversion/${this.taskId}/`;console.log(`Connecting to WebSocket: ${e}`);try{this.ws=new WebSocket(e),this.ws.onopen=e=>this.handleOpen(e),this.ws.onmessage=e=>this.handleMessage(e),this.ws.onerror=e=>this.handleError(e),this.ws.onclose=e=>this.handleClose(e)}catch(e){console.error("WebSocket connection error:",e),this.options.onError({type:"connection_error",message:"Failed to establish WebSocket connection",error:e.message})}}handleOpen(e){console.log("WebSocket connected"),this.isConnected=!0,this.reconnectCount=0,this.startPingTimer(),this.options.onConnected({taskId:this.taskId,timestamp:(new Date).toISOString()})}handleMessage(e){try{const t=JSON.parse(e.data);switch(console.log("WebSocket message received:",t),t.type){case"connected":case"pong":break;case"progress":this.options.onProgress({progress:t.progress,message:t.message,status:t.status,taskId:t.task_id});break;case"completed":this.options.onCompleted({downloadUrl:t.download_url,filename:t.filename,fileSize:t.file_size,message:t.message,taskId:t.task_id}),this.disconnect();break;case"error":this.options.onError({type:"conversion_error",message:t.message,error:t.error,taskId:t.task_id}),this.disconnect();break;default:console.warn("Unknown message type:",t.type)}}catch(e){console.error("Error parsing WebSocket message:",e)}}handleError(e){console.error("WebSocket error:",e),this.isConnected=!1,this.options.onError({type:"websocket_error",message:"WebSocket connection error",event:e})}handleClose(e){console.log("WebSocket closed:",e.code,e.reason),this.isConnected=!1,this.stopPingTimer(),this.options.onDisconnected({code:e.code,reason:e.reason,wasClean:e.wasClean}),!e.wasClean&&this.reconnectCount<this.options.reconnectAttempts&&(this.reconnectCount++,console.log(`Reconnecting... Attempt ${this.reconnectCount}/${this.options.reconnectAttempts}`),setTimeout(()=>{this.connect()},this.options.reconnectDelay))}startPingTimer(){this.pingTimer=setInterval(()=>{this.isConnected&&this.ws.readyState===WebSocket.OPEN&&this.send({type:"ping",timestamp:(new Date).toISOString()})},this.options.pingInterval)}stopPingTimer(){this.pingTimer&&(clearInterval(this.pingTimer),this.pingTimer=null)}send(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):console.warn("WebSocket is not open. Cannot send message.")}disconnect(){this.stopPingTimer(),this.ws&&(this.ws.close(1e3,"Client disconnect"),this.ws=null),this.isConnected=!1}defaultOnProgress(e){console.log("Progress:",e.progress+"%",e.message)}defaultOnCompleted(e){console.log("Completed:",e.filename)}defaultOnError(e){console.error("Error:",e.message)}defaultOnConnected(e){console.log("Connected:",e.taskId)}defaultOnDisconnected(e){console.log("Disconnected:",e.code,e.reason)}}class BatchConversionProgressClient{constructor(e,t={}){this.batchId=e,this.options={onProgress:t.onProgress||this.defaultOnProgress,onFileCompleted:t.onFileCompleted||this.defaultOnFileCompleted,onCompleted:t.onCompleted||this.defaultOnCompleted,onError:t.onError||this.defaultOnError,onConnected:t.onConnected||this.defaultOnConnected,onDisconnected:t.onDisconnected||this.defaultOnDisconnected,reconnectAttempts:t.reconnectAttempts||3,reconnectDelay:t.reconnectDelay||2e3,pingInterval:t.pingInterval||3e4},this.ws=null,this.reconnectCount=0,this.pingTimer=null,this.isConnected=!1}connect(){const e=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/ws/batch/${this.batchId}/`;console.log(`Connecting to Batch WebSocket: ${e}`);try{this.ws=new WebSocket(e),this.ws.onopen=e=>this.handleOpen(e),this.ws.onmessage=e=>this.handleMessage(e),this.ws.onerror=e=>this.handleError(e),this.ws.onclose=e=>this.handleClose(e)}catch(e){console.error("Batch WebSocket connection error:",e),this.options.onError({type:"connection_error",message:"Failed to establish WebSocket connection",error:e.message})}}handleOpen(e){console.log("Batch WebSocket connected"),this.isConnected=!0,this.reconnectCount=0,this.startPingTimer(),this.options.onConnected({batchId:this.batchId,timestamp:(new Date).toISOString()})}handleMessage(e){try{const t=JSON.parse(e.data);switch(console.log("Batch WebSocket message:",t),t.type){case"connected":case"pong":break;case"batch_progress":this.options.onProgress({totalFiles:t.total_files,completedFiles:t.completed_files,currentFile:t.current_file,progress:t.progress,message:t.message,status:t.status,batchId:t.batch_id});break;case"file_completed":this.options.onFileCompleted({filename:t.filename,fileIndex:t.file_index,message:t.message,batchId:t.batch_id});break;case"batch_completed":this.options.onCompleted({downloadUrl:t.download_url,totalFiles:t.total_files,successfulFiles:t.successful_files,failedFiles:t.failed_files,message:t.message,batchId:t.batch_id}),this.disconnect();break;case"batch_error":this.options.onError({type:"batch_error",message:t.message,error:t.error,batchId:t.batch_id}),this.disconnect();break;default:console.warn("Unknown batch message type:",t.type)}}catch(e){console.error("Error parsing batch WebSocket message:",e)}}handleError(e){console.error("Batch WebSocket error:",e),this.isConnected=!1,this.options.onError({type:"websocket_error",message:"WebSocket connection error",event:e})}handleClose(e){console.log("Batch WebSocket closed:",e.code,e.reason),this.isConnected=!1,this.stopPingTimer(),this.options.onDisconnected({code:e.code,reason:e.reason,wasClean:e.wasClean}),!e.wasClean&&this.reconnectCount<this.options.reconnectAttempts&&(this.reconnectCount++,console.log(`Reconnecting batch... Attempt ${this.reconnectCount}/${this.options.reconnectAttempts}`),setTimeout(()=>{this.connect()},this.options.reconnectDelay))}startPingTimer(){this.pingTimer=setInterval(()=>{this.isConnected&&this.ws.readyState===WebSocket.OPEN&&this.send({type:"ping",timestamp:(new Date).toISOString()})},this.options.pingInterval)}stopPingTimer(){this.pingTimer&&(clearInterval(this.pingTimer),this.pingTimer=null)}send(e){this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(e))}disconnect(){this.stopPingTimer(),this.ws&&(this.ws.close(1e3,"Client disconnect"),this.ws=null),this.isConnected=!1}defaultOnProgress(e){console.log(`Batch Progress: ${e.completedFiles}/${e.totalFiles} (${e.progress}%)`,e.message)}defaultOnFileCompleted(e){console.log("File completed:",e.filename)}defaultOnCompleted(e){console.log(`Batch completed: ${e.successfulFiles}/${e.totalFiles} successful`)}defaultOnError(e){console.error("Batch error:",e.message)}defaultOnConnected(e){console.log("Batch connected:",e.batchId)}defaultOnDisconnected(e){console.log("Batch disconnected:",e.code,e.reason)}}"undefined"!=typeof window&&(window.ConversionProgressClient=ConversionProgressClient,window.BatchConversionProgressClient=BatchConversionProgressClient);