const PDFJS_VERSION="3.11.174",localPdfSrc="string"==typeof window.PDFJS_LOCAL_PDF?window.PDFJS_LOCAL_PDF:null,localWorkerSrc="string"==typeof window.PDFJS_LOCAL_WORKER?window.PDFJS_LOCAL_WORKER:null,PDFJS_CANDIDATES=[...localPdfSrc?[localPdfSrc]:[],"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js","https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"],PDFJS_WORKER_CANDIDATES=[...localWorkerSrc?[localWorkerSrc]:[],"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js","https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js"];function loadExternalScript(e){return new Promise((t,n)=>{const o=Array.from(document.scripts).find(t=>t.src===e);if(o)return void 0!==window.pdfjsLib?t():(o.addEventListener("load",()=>t(),{once:!0}),void o.addEventListener("error",()=>n(new Error(`Failed to load ${e}`)),{once:!0}));const r=document.createElement("script");r.src=e,r.async=!0,r.crossOrigin="anonymous",r.onload=()=>t(),r.onerror=()=>n(new Error(`Failed to load ${e}`)),document.head.appendChild(r)})}async function ensurePdfJsLoaded(){if(void 0!==window.pdfjsLib)return!0;for(const e of PDFJS_CANDIDATES)try{if(await loadExternalScript(e),void 0!==window.pdfjsLib)break}catch(e){}return void 0!==window.pdfjsLib&&(window.pdfjsLib.GlobalWorkerOptions.workerSrc||(window.pdfjsLib.GlobalWorkerOptions.workerSrc=PDFJS_WORKER_CANDIDATES[0]),!0)}document.addEventListener("DOMContentLoaded",()=>{void 0!==window.pdfjsLib&&(window.pdfjsLib.GlobalWorkerOptions.workerSrc=PDFJS_WORKER_CANDIDATES[0]);const e=document.getElementById("editorForm");if(!e)return;const t=document.getElementById("fileInput"),n=document.getElementById("fileInputDrop"),o=(document.getElementById("selectFileButton"),document.getElementById("pdfPreviewSection")),r=document.getElementById("pdfPreviewContainer"),a=document.getElementById("editButton"),d=document.getElementById("dropZone"),i=document.getElementById("removeFile");let s=null,l=null,c=[],f=null,g=new Map,u=!1;function p(e){e.preventDefault(),e.stopPropagation()}function w(e){d.classList.add("border-blue-500","bg-blue-50"),d.classList.remove("border-gray-300","bg-gray-50")}function m(e){d.classList.remove("border-blue-500","bg-blue-50"),d.classList.add("border-gray-300","bg-gray-50")}async function h(e){if(e&&e.name.toLowerCase().endsWith(".pdf"))if(u)console.log("Organize PDF: Already processing file, ignoring duplicate");else{u=!0;try{if(l=e,t){const n=new DataTransfer;n.items.add(e),t.files=n.files}if(n){const t=new DataTransfer;t.items.add(e),n.files=t.files}const d=document.getElementById("selectedFile"),i=document.getElementById("fileName"),u=document.getElementById("fileSize");d&&i&&u&&(i.textContent=e.name,u.textContent=window.formatFileSize?window.formatFileSize(e.size):`${(e.size/1024/1024).toFixed(2)} MB`,d.classList.remove("hidden")),L(),function(){const e=document.getElementById("errorMessage");e&&(e.classList.add("hidden"),e.textContent="")}(),o&&o.classList.remove("hidden");if(!await ensurePdfJsLoaded()||void 0===window.pdfjsLib)return window.showError("PDF preview engine (PDF.js) is not loaded. Please disable adblock for this site or check that cdnjs/unpkg are not blocked, then refresh the page.","editorResult"),void L();window.pdfjsLib.GlobalWorkerOptions.workerSrc||(window.pdfjsLib.GlobalWorkerOptions.workerSrc=PDFJS_WORKER_CANDIDATES[0]);const p=await e.arrayBuffer();s=await window.pdfjsLib.getDocument({data:p}).promise;if(!await window.validatePdfPageLimit(e))return o&&o.classList.add("hidden"),void(s=null);c=Array.from({length:s.numPages},(e,t)=>t),await async function(){if(!s||!r)return;r.innerHTML="";for(let e=0;e<c.length;e++){const t=c[e];await v(t,e)}}(),function(){if(!r)return;console.log("Organize PDF: Making sortable with HTML5 drag and drop"),g.forEach((e,t)=>{e.forEach(e=>{t.removeEventListener(e.event,e.handler)})}),g.clear();const e=r.querySelectorAll(".pdf-page-card");console.log("Organize PDF: Found cards:",e.length),e.forEach(e=>{if(g.has(e))return;const t=[],n=t=>{console.log("Organize PDF: Drag started"),f=e,e.style.opacity="0.5",e.style.transform="scale(1.05) rotate(2deg)",e.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",e.style.border="2px solid #3b82f6",t.dataTransfer.effectAllowed="move"},o=()=>{console.log("Organize PDF: Drag ended"),f&&(f.style.opacity="1",f.style.transform="",f.style.boxShadow="",f.style.border=""),y(),f=null},a=t=>{if(t.preventDefault(),t.dataTransfer.dropEffect="move",f&&f!==e){const n=e.getBoundingClientRect(),o=n.top+n.height/2;t.clientY<o?r.insertBefore(f,e):r.insertBefore(f,e.nextSibling),E()}},d=e=>{e.preventDefault(),y()};e.addEventListener("dragstart",n),e.addEventListener("dragend",o),e.addEventListener("dragover",a),e.addEventListener("drop",d),t.push({event:"dragstart",handler:n},{event:"dragend",handler:o},{event:"dragover",handler:a},{event:"drop",handler:d}),g.set(e,t)})}(),a&&(a.disabled=!1,a.classList.remove("opacity-50","cursor-not-allowed"))}catch(e){console.error("Error loading PDF:",e),console.error("Error details:",{message:e.message,name:e.name,stack:e.stack});let t="Failed to load PDF file. Please try again.";e.message&&e.message.includes("pdfjsLib")?t="PDF preview engine is not loaded. Please refresh the page and try again.":e.message&&(t=`Failed to load PDF: ${e.message}`),window.showError(t,"errorMessage"),L()}finally{u=!1}}else window.showError(window.SELECT_PDF_FILE||"Please select a PDF file.","errorMessage")}async function v(e,t){let n=null;try{const o=await s.getPage(e+1),a=.3,d=o.getViewport({scale:a}),i=document.createElement("div");i.className="pdf-page-card relative bg-white rounded-lg border-2 border-gray-300 p-2 cursor-move hover:border-blue-500 hover:shadow-md transition-all",i.draggable=!0,i.dataset.pageIndex=e,i.dataset.displayIndex=t,n=document.createElement("canvas"),n.width=d.width,n.height=d.height;const l=n.getContext("2d");await o.render({canvasContext:l,viewport:d}).promise,i.innerHTML=`\n                <div class="absolute top-2 left-2 bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center z-10">\n                    ${t+1}\n                </div>\n                <div class="w-full overflow-hidden rounded">\n                    <canvas class="w-full h-auto"></canvas>\n                </div>\n                <p class="text-xs text-gray-600 text-center mt-2">Page ${e+1}</p>\n            `;const c=i.querySelector("canvas");c.width=n.width,c.height=n.height;c.getContext("2d").drawImage(n,0,0),r.appendChild(i),n=null}catch(t){"undefined"!=typeof console&&console.error&&console.error(`Error rendering page ${e+1}:`,t)}finally{if(n){n.getContext("2d").clearRect(0,0,n.width,n.height),n=null}}}function E(){r.querySelectorAll(".pdf-page-card").forEach((e,t)=>{const n=e.querySelector(".absolute.top-2.left-2");n&&(n.textContent=`${t+1}`),e.dataset.displayIndex=t})}function y(){const e=r.querySelectorAll(".pdf-page-card");c=Array.from(e).map(e=>parseInt(e.dataset.pageIndex)),E(),"undefined"!=typeof console&&console.log&&console.log("Page order updated:",c)}function L(){if(s){try{s.destroy()}catch(e){}s=null}r&&(r.innerHTML=""),c=[],o&&o.classList.add("hidden"),a&&(a.disabled=!0,a.classList.add("opacity-50","cursor-not-allowed"))}if(t&&t.addEventListener("change",e=>{e.target.files&&e.target.files.length>0&&h(e.target.files[0])}),n&&n.addEventListener("change",e=>{e.target.files&&e.target.files.length>0&&h(e.target.files[0])}),d&&(["dragenter","dragover","dragleave","drop"].forEach(e=>{d.addEventListener(e,p,!1)}),["dragenter","dragover"].forEach(e=>{d.addEventListener(e,w,!1)}),["dragleave","drop"].forEach(e=>{d.addEventListener(e,m,!1)}),d.addEventListener("drop",function(e){const t=e.dataTransfer.files;t&&t.length>0&&h(t[0])},!1)),i&&i.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),u=!1,t&&(t.value=""),n&&(n.value=""),l=null,L(),o&&o.classList.add("hidden");const r=document.getElementById("selectedFile");r&&r.classList.add("hidden"),a&&(a.disabled=!0,a.classList.add("opacity-50","cursor-not-allowed"))}),e&&a){let r=!1;a.addEventListener("click",async d=>{if(d.preventDefault(),d.stopPropagation(),r)return console.log("Organize PDF: Already submitting, preventing duplicate"),!1;if(!l||!s)return window.showError(window.SELECT_PDF_FIRST||"Please select a PDF file first.","errorMessage"),!1;if(r=!0,a){a.disabled=!0;const e=a.querySelector("span span")||a;e.dataset.originalText=e.textContent,e.textContent=window.ORGANIZING||"Organizing..."}const i=window.API_URL||e.action||"/api/pdf-organize/organize/",f=new FormData,g=window.FILE_INPUT_NAME||"pdf_file",u=t?.files?.[0]||n?.files?.[0];if(!u)return window.showError(window.SELECT_FILE_MESSAGE||"Please select a file","errorMessage"),void(r=!1);f.append(g,u),f.append("page_order",JSON.stringify(c));const p=document.querySelector("[name=csrfmiddlewaretoken]");p&&f.append("csrfmiddlewaretoken",p.value);try{const r=await fetch(i,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:f});if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error||e.message||`Server error: ${r.status}`)}const a=await r.blob();let d=document.getElementById("resultContainer");d?d.innerHTML="":(d=document.createElement("div"),d.id="resultContainer",d.className="mt-6",e.parentNode.insertBefore(d,e.nextSibling)),window.showDownloadButton(a,l.name,"resultContainer",{successTitle:"Organization Complete!",downloadButtonText:"Download Organized PDF",convertAnotherText:"Organize another file",onConvertAnother:()=>{console.log("Organize PDF: onConvertAnother called"),l=null,s=null,c=[],t&&(t.value=""),n&&(n.value=""),o&&o.classList.add("hidden"),L(),d&&(d.classList.add("hidden"),d.innerHTML=""),window.scrollTo({top:0,behavior:"smooth"}),setTimeout(()=>{const e=document.getElementById("selectFileButton");e&&e.focus({preventScroll:!0})},800)}})}catch(e){window.showError(`${window.FAILED_TO_ORGANIZE||"Failed to organize PDF"}: ${e.message}`,"errorMessage")}finally{if(r=!1,a){a.disabled=!1;const e=a.querySelector("span span")||a;e.dataset.originalText&&(e.textContent=e.dataset.originalText)}}})}});