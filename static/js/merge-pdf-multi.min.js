const PDFJS_VERSION="3.11.174",localPdfSrc="string"==typeof window.PDFJS_LOCAL_PDF?window.PDFJS_LOCAL_PDF:null,localWorkerSrc="string"==typeof window.PDFJS_LOCAL_WORKER?window.PDFJS_LOCAL_WORKER:null,PDFJS_CANDIDATES=[...localPdfSrc?[localPdfSrc]:[],"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js","https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"],PDFJS_WORKER_CANDIDATES=[...localWorkerSrc?[localWorkerSrc]:[],"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js","https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js"];function loadExternalScript(e){return new Promise((t,n)=>{const o=Array.from(document.scripts).find(t=>t.src===e);if(o)return void 0!==window.pdfjsLib?t():(o.addEventListener("load",()=>t(),{once:!0}),void o.addEventListener("error",()=>n(new Error(`Failed to load ${e}`)),{once:!0}));const r=document.createElement("script");r.src=e,r.async=!0,r.crossOrigin="anonymous",r.onload=()=>t(),r.onerror=()=>n(new Error(`Failed to load ${e}`)),document.head.appendChild(r)})}async function ensurePdfJsLoaded(){if(void 0!==window.pdfjsLib)return!0;for(const e of PDFJS_CANDIDATES)try{if(await loadExternalScript(e),void 0!==window.pdfjsLib)break}catch(e){}return void 0!==window.pdfjsLib&&(window.pdfjsLib.GlobalWorkerOptions.workerSrc||(window.pdfjsLib.GlobalWorkerOptions.workerSrc=PDFJS_WORKER_CANDIDATES[0]),!0)}document.addEventListener("DOMContentLoaded",()=>{void 0!==window.pdfjsLib&&(window.pdfjsLib.GlobalWorkerOptions.workerSrc=PDFJS_WORKER_CANDIDATES[0]);const e=document.getElementById("editorForm")||document.getElementById("converterForm");e||console.log("Merge PDF: No form found, but continuing anyway");const t=document.getElementById("pdf_files_input"),n=document.getElementById("selectPdfFilesButton"),o=document.getElementById("addMorePdfFilesButton"),r=document.getElementById("mergeDropZone"),i=document.getElementById("selectedPdfFilesContainer"),d=document.getElementById("selectedPdfFilesList"),s=document.getElementById("pdfFileCount"),a=document.getElementById("pdfPreviewSection"),l=document.getElementById("pdfPreviewContainer"),c=document.getElementById("editButton");console.log("Merge PDF elements found:",{pdfFilesInput:!!t,selectPdfFilesButton:!!n,addMorePdfFilesButton:!!o,mergeDropZone:!!r,selectedPdfFilesContainer:!!i,selectedPdfFilesList:!!d,pdfFileCount:!!s,pdfPreviewSection:!!a,pdfPreviewContainer:!!l,editButton:!!c});let f=[],p=null;if(d&&d.addEventListener("click",e=>{const t=e.target.closest(".remove-file-btn");if(t){e.preventDefault(),e.stopPropagation();const n=t.dataset.fileId||t.getAttribute("data-file-id");n&&function(e){const t="string"==typeof e?parseFloat(e):e,n=f.find(n=>Math.abs(n.id-t)<1e-4||(n.id.toString()===e.toString()||(n.id===t||n.id===e)));if(!n)return;if(n.pdfDoc)try{n.pdfDoc.destroy()}catch(e){}if(n.preview){n.preview.getContext("2d").clearRect(0,0,n.preview.width,n.preview.height)}const o=l?.querySelector(`[data-file-id="${n.id}"]`)||l?.querySelector(`[data-file-id="${e}"]`)||l?.querySelector(`[data-file-id="${t}"]`);o&&o.remove();f=f.filter(n=>!(Math.abs(n.id-t)<1e-4)&&(n.id.toString()!==e.toString()&&(n.id!==t&&n.id!==e))),u(),g(),h()}(n)}}),n?n.addEventListener("click",()=>{console.log("Select PDF files button clicked"),t?.click()}):console.log("Select PDF files button not found"),o?o.addEventListener("click",()=>{console.log("Add more PDF files button clicked"),t?.click()}):console.log("Add more PDF files button not found"),t?.addEventListener("change",async e=>{await new Promise(e=>setTimeout(e,50)),w(e.target.files),e.target.value=""}),r){const t=e=>{e.preventDefault(),e.stopPropagation()};["dragenter","dragover","dragleave","drop"].forEach(e=>{r.addEventListener(e,t,!1)});let n=0;r.addEventListener("dragenter",()=>{n++,r.classList.add("border-blue-500","bg-blue-100","border-4"),r.classList.remove("border-2","border-gray-300","bg-gray-50")}),r.addEventListener("dragover",()=>{r.classList.add("border-blue-500","bg-blue-100","border-4"),r.classList.remove("border-2","border-gray-300","bg-gray-50")}),r.addEventListener("dragleave",()=>{n--,n<=0&&(n=0,r.classList.remove("border-blue-500","bg-blue-100","border-4"),r.classList.add("border-2","border-gray-300","bg-gray-50"))}),r.addEventListener("drop",e=>{n=0,r.classList.remove("border-blue-500","bg-blue-100","border-4"),r.classList.add("border-2","border-gray-300","bg-gray-50");const t=e.dataTransfer,o=t?.files;o&&o.length>0&&w(o)}),e&&(["dragover","drop"].forEach(t=>{e.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation()})}),e.addEventListener("drop",e=>{const t=e.dataTransfer,n=t?.files;n&&n.length>0&&w(n)}))}function w(e){e&&0!==e.length&&(console.log("handleFileSelection called with files:",e),console.log("Before selection - selectedFiles.length:",f.length),Array.from(e).forEach(e=>{if(!e.name.toLowerCase().endsWith(".pdf")){const t=window.FILE_NOT_PDF||"is not a PDF file. Skipping.";return void alert(`"${e.name}" ${t}`)}f.some(t=>t.name===e.name&&t.size===e.size)||f.push({file:e,id:Date.now()+Math.random(),preview:null})}),f.length>10&&(f=f.slice(0,10),alert(window.MAX_FILES_EXCEEDED||"Maximum 10 files allowed. Only the first 10 files will be used.")),console.log("After selection - selectedFiles.length:",f.length),u(),g(),h())}function u(){d&&(d.innerHTML="",f.forEach((e,t)=>{const n=e.file,o=(n.size/1048576).toFixed(2),r=document.createElement("div");r.className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200",r.dataset.fileId=e.id,r.innerHTML=`\n                <div class="flex items-center space-x-3 flex-1 min-w-0">\n                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded flex items-center justify-center">\n                        <span class="text-xs font-bold text-blue-600">${t+1}</span>\n                    </div>\n                    <div class="flex-1 min-w-0">\n                        <p class="text-sm font-medium text-gray-900 truncate">${b(n.name)}</p>\n                        <p class="text-xs text-gray-500">${o} MB</p>\n                    </div>\n                </div>\n                <button type="button"\n                        class="remove-file-btn ml-3 p-1.5 text-red-600 hover:bg-red-50 rounded transition-colors flex-shrink-0"\n                        data-file-id="${e.id}"\n                        aria-label="Remove file">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                    </svg>\n                </button>\n            `,d.appendChild(r)}),s&&(s.textContent=f.length),i&&(f.length>0?i.classList.remove("hidden"):i.classList.add("hidden")))}async function g(){if(l)if(l.innerHTML="",0!==f.length){a&&a.classList.remove("hidden");for(let e=0;e<f.length;e++){const t=f[e];await m(t,e)}v()}else a&&a.classList.add("hidden")}async function m(e,t){const n=document.createElement("div");n.className="pdf-preview-card bg-white rounded-lg border-2 border-gray-200 p-2 cursor-move hover:border-blue-400 transition-colors",n.dataset.fileId=e.id,n.dataset.index=t,n.draggable=!0,n.innerHTML=`\n            <div class="relative">\n                <div class="w-full aspect-[3/4] bg-gray-100 rounded border border-gray-200 flex items-center justify-center overflow-hidden">\n                    <div class="pdf-preview-canvas-container text-center">\n                        <div class="spinner-border text-blue-600" role="status">\n                            <span class="sr-only">Loading...</span>\n                        </div>\n                    </div>\n                </div>\n                <div class="absolute top-2 left-2 bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">\n                    ${t+1}\n                </div>\n            </div>\n            <p class="text-xs text-gray-600 mt-2 truncate" title="${b(e.file.name)}">\n                ${b(e.file.name)}\n            </p>\n        `,l.appendChild(n);let o=null;try{if(!await ensurePdfJsLoaded()||void 0===window.pdfjsLib){console.error("PDF.js not loaded for preview generation");return void(n.querySelector(".pdf-preview-canvas-container").innerHTML=`<p class="text-xs text-red-600">${window.ERROR_LOADING_PREVIEW||"Error loading preview"}</p>`)}window.pdfjsLib.GlobalWorkerOptions.workerSrc||(window.pdfjsLib.GlobalWorkerOptions.workerSrc=PDFJS_WORKER_CANDIDATES[0]);const t=await e.file.arrayBuffer();o=await window.pdfjsLib.getDocument({data:t}).promise;const r=await o.getPage(1),i=r.getViewport({scale:.5}),d=document.createElement("canvas");d.width=i.width,d.height=i.height;const s=d.getContext("2d");await r.render({canvasContext:s,viewport:i}).promise;const a=n.querySelector(".pdf-preview-canvas-container");a.innerHTML="",a.appendChild(d),e.preview=d,e.pdfDoc=o}catch(e){console.error("Error loading PDF preview:",e);if(n.querySelector(".pdf-preview-canvas-container").innerHTML=`<p class="text-xs text-red-600">${window.ERROR_LOADING_PREVIEW||"Error loading preview"}</p>`,o)try{o.destroy()}catch(e){}}}async function g(){if(l)if(l.innerHTML="",0!==f.length){a&&a.classList.remove("hidden");for(let e=0;e<f.length;e++){const t=f[e];await m(t,e)}v()}else a&&a.classList.add("hidden")}async function m(e,t){const n=document.createElement("div");n.className="pdf-preview-card bg-white rounded-lg border-2 border-gray-200 p-2 cursor-move hover:border-blue-400 transition-colors",n.dataset.fileId=e.id,n.dataset.index=t,n.draggable=!0,n.innerHTML=`\n        <div class="relative">\n            <div class="w-full aspect-[3/4] bg-gray-100 rounded border border-gray-200 flex items-center justify-center overflow-hidden">\n                <div class="pdf-preview-canvas-container text-center">\n                    <div class="spinner-border text-blue-600" role="status">\n                        <span class="sr-only">Loading...</span>\n                    </div>\n                </div>\n            </div>\n            <div class="absolute top-2 left-2 bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">\n                ${t+1}\n            </div>\n        </div>\n        <p class="text-xs text-gray-600 mt-2 truncate" title="${b(e.file.name)}">\n            ${b(e.file.name)}\n        </p>\n    `,l.appendChild(n);let o=null;try{if(!await ensurePdfJsLoaded()||void 0===window.pdfjsLib){console.error("PDF.js not loaded for preview generation");return void(n.querySelector(".pdf-preview-canvas-container").innerHTML=`<p class="text-xs text-red-600">${window.ERROR_LOADING_PREVIEW||"Error loading preview"}</p>`)}window.pdfjsLib.GlobalWorkerOptions.workerSrc||(window.pdfjsLib.GlobalWorkerOptions.workerSrc=PDFJS_WORKER_CANDIDATES[0]);const t=await e.file.arrayBuffer();o=await window.pdfjsLib.getDocument({data:t}).promise;const r=await o.getPage(1),i=r.getViewport({scale:.5}),d=document.createElement("canvas");d.width=i.width,d.height=i.height;const s=d.getContext("2d");await r.render({canvasContext:s,viewport:i}).promise;const a=n.querySelector(".pdf-preview-canvas-container");a.innerHTML="",a.appendChild(d),e.preview=d,e.pdfDoc=o}catch(e){"undefined"!=typeof console&&console.error&&console.error("Error loading PDF preview:",e);if(n.querySelector(".pdf-preview-canvas-container").innerHTML=`<p class="text-xs text-red-600">${window.ERROR_LOADING_PREVIEW||"Error loading preview"}</p>`,o)try{o.destroy()}catch(e){}}}function v(){l.querySelectorAll(".pdf-preview-card").forEach(e=>{e.addEventListener("dragstart",t=>{p=e,e.style.opacity="0.5",t.dataTransfer.effectAllowed="move"}),e.addEventListener("dragend",()=>{e.style.opacity="1",p=null}),e.addEventListener("dragover",t=>{if(t.preventDefault(),t.dataTransfer.dropEffect="move",p&&p!==e){const n=e.getBoundingClientRect(),o=n.top+n.height/2;t.clientY<o?e.parentNode.insertBefore(p,e):e.parentNode.insertBefore(p,e.nextSibling)}}),e.addEventListener("drop",e=>{e.preventDefault(),function(){const e=Array.from(l.querySelectorAll(".pdf-preview-card")),t=e.map(e=>e.dataset.fileId);f.sort((e,n)=>t.indexOf(e.id.toString())-t.indexOf(n.id.toString())),e.forEach((e,t)=>{const n=e.querySelector(".absolute .bg-blue-600");n&&(n.textContent=t+1),e.dataset.index=t}),u()}()})})}function h(){const e=f.length>=2;c&&(c.disabled=!e,e?c.classList.remove("opacity-50","cursor-not-allowed"):c.classList.add("opacity-50","cursor-not-allowed")),o&&(f.length>0&&f.length<10?o.classList.remove("hidden"):o.classList.add("hidden"))}const b=window.escapeHtml||function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML};function E(){window.hideDownload("downloadContainer")}function y(){const e=document.getElementById("editorResult");e&&e.classList.add("hidden")}function L(t){c&&(c.disabled=t);e.querySelectorAll("input, select, textarea, button").forEach(e=>{e!==c&&(e.disabled=t)})}e.addEventListener("submit",async n=>{if(n.preventDefault(),n.stopPropagation(),await new Promise(e=>setTimeout(e,100)),0===f.length&&t&&t.files.length>0&&(console.log("Fallback: Processing files from input directly"),w(t.files),await new Promise(e=>setTimeout(e,50))),console.log("Form submit - selectedFiles.length:",f.length),console.log("Form submit - selectedFiles:",f),f.length<2)return void window.showError("Please select at least 2 PDF files to merge.","editorResult");if(f.length>10)return void window.showError("Maximum 10 PDF files allowed.","editorResult");const o=window.API_URL||e.action||"/api/pdf-organize/merge/",r=new FormData,i=document.querySelector("[name=csrfmiddlewaretoken]")?.value||window.CSRF_TOKEN;if(i&&r.append("csrfmiddlewaretoken",i),f.forEach((e,t)=>{const n=e.file;r.append("pdf_files",n,n.name)}),f.length!==Array.from(r.getAll("pdf_files")).length)throw new Error("File count mismatch in FormData");r.append("order","upload"),y(),E(),window.showLoading("loadingContainer"),L(!0);try{const e=await fetch(o,{method:"POST",body:r,headers:{"X-CSRFToken":i,"X-Requested-With":"XMLHttpRequest"}}),t=await e.blob();if(!e.ok)try{const e=await t.text(),n=JSON.parse(e);throw new Error(n.error||window.ERROR_MESSAGE||"Failed to merge PDFs. Please try again.")}catch{throw new Error(window.ERROR_MESSAGE||"Failed to merge PDFs. Please try again.")}const n=e.headers.get("Content-Disposition");let d="merged.pdf";if(n){const e=n.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);e&&e[1]&&(d=e[1].replace(/['"]/g,""))}const s=f[0]?.file?.name||"merged",a=new RegExp(window.REPLACE_REGEX||"\\.pdf$","i"),l=window.REPLACE_TO||"_merged.pdf",c=s.replace(a,l);window.hideLoading("loadingContainer"),window.showDownloadButton(t,c,"downloadContainer",{successTitle:window.SUCCESS_TITLE||"Editing Complete!",downloadButtonText:window.DOWNLOAD_BUTTON_TEXT||"Download File",convertAnotherText:window.EDIT_ANOTHER_TEXT||"Edit another file",onConvertAnother:()=>{const e=document.getElementById("selectedFile");e&&e.classList.add("hidden");const t=document.getElementById("fileInput");t&&(t.value="");const n=document.getElementById("pdfPreviewSection");n&&n.classList.add("hidden");const o=document.getElementById("selectedPdfFilesContainer");o&&o.classList.add("hidden"),f=[],u(),h(),E(),y(),L(!1),requestAnimationFrame(()=>{window.scrollTo(0,0),setTimeout(()=>{const e=document.getElementById("selectPdfFilesButton");e&&e.focus({preventScroll:!0})},100)})}}),L(!1)}catch(e){console.error("Error merging PDFs:",e),window.hideLoading("loadingContainer"),window.showError(e.message||"An error occurred while merging PDFs. Please try again.","editorResult"),L(!1)}}),h()});