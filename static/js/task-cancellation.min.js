!function(){"use strict";let e=new Set,n=new Set,t=new Map,o=null;function a(e){let n=null;if(document.cookie&&""!==document.cookie){const t=document.cookie.split(";");for(let o=0;o<t.length;o++){const a=t[o].trim();if(a.substring(0,e.length+1)===e+"="){n=decodeURIComponent(a.substring(e.length+1));break}}}return n}async function s(){if(0===e.size)return;console.log(`[Task Cancel] Cancelling ${e.size} active task(s)`);const n=Array.from(e).map(e=>async function(e){try{const n=document.querySelector("[name=csrfmiddlewaretoken]")?.value||document.querySelector('meta[name="csrf-token"]')?.content||a("csrftoken"),t=window.getTaskToken?window.getTaskToken(e):null,o=await fetch("/api/cancel-task/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":n},body:JSON.stringify({task_id:e,task_token:t})}),s=await o.json();return o.ok?(console.log(`[Task Cancel] Cancelled task: ${e}`,s),!0):(console.warn(`[Task Cancel] Failed to cancel task: ${e}`,s),!1)}catch(n){return console.error(`[Task Cancel] Error cancelling task: ${e}`,n),!1}}(e));await Promise.all(n),e.clear()}function c(){const t=Array.from(e).filter(e=>!n.has(e));if(t.length>0&&navigator.sendBeacon){const e=document.querySelector("[name=csrfmiddlewaretoken]")?.value||document.querySelector('meta[name="csrf-token"]')?.content||a("csrftoken");t.forEach(n=>{const t=window.getTaskToken?window.getTaskToken(n):null,o=new Blob([JSON.stringify({task_id:n,task_token:t,csrfmiddlewaretoken:e})],{type:"application/json"});navigator.sendBeacon("/api/cancel-task/",o)}),console.log(`[Task Cancel] Sent cancellation beacons for ${t.length} task(s), skipped ${n.size} background task(s)`)}}window.registerTaskForCancellation=function(n,o){n&&(e.add(n),o&&t.set(n,o),console.log(`[Task Cancel] Registered task: ${n}`))},window.registerTaskToken=function(e,n){e&&n&&t.set(e,n)},window.getTaskToken=function(e){return t.get(e)},window.unregisterTaskForCancellation=function(o){o&&(e.delete(o),n.delete(o),t.delete(o),console.log(`[Task Cancel] Unregistered task: ${o}`))},window.markTaskAsBackground=function(t){t&&(n.add(t),e.delete(t),console.log(`[Task Cancel] Moved task to background: ${t}`))},window.addEventListener("beforeunload",c),window.addEventListener("pagehide",c),document.addEventListener("visibilitychange",function(){document.hidden?o=setTimeout(()=>{console.log("[Task Cancel] Page hidden for too long, cancelling tasks"),s()},6e4):o&&(clearTimeout(o),o=null)}),window.addEventListener("blur",function(){"hidden"in document||(o=setTimeout(()=>{s()},6e4))}),window.addEventListener("focus",function(){o&&(clearTimeout(o),o=null)}),console.log("[Task Cancel] Task cancellation system initialized"),window.addEventListener("pagehide",()=>{o&&clearTimeout(o)})}();