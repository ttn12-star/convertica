!function(){"use strict";let e=new Set,n=null;function t(e){let n=null;if(document.cookie&&""!==document.cookie){const t=document.cookie.split(";");for(let o=0;o<t.length;o++){const a=t[o].trim();if(a.substring(0,e.length+1)===e+"="){n=decodeURIComponent(a.substring(e.length+1));break}}}return n}async function o(){if(0===e.size)return;console.log(`[Task Cancel] Cancelling ${e.size} active task(s)`);const n=Array.from(e).map(e=>async function(e){try{const n=document.querySelector("[name=csrfmiddlewaretoken]")?.value||document.querySelector('meta[name="csrf-token"]')?.content||t("csrftoken"),o=await fetch("/api/cancel-task/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":n},body:JSON.stringify({task_id:e})}),a=await o.json();return o.ok?(console.log(`[Task Cancel] Cancelled task: ${e}`,a),!0):(console.warn(`[Task Cancel] Failed to cancel task: ${e}`,a),!1)}catch(n){return console.error(`[Task Cancel] Error cancelling task: ${e}`,n),!1}}(e));await Promise.all(n),e.clear()}function a(){if(e.size>0&&navigator.sendBeacon){const n=document.querySelector("[name=csrfmiddlewaretoken]")?.value||document.querySelector('meta[name="csrf-token"]')?.content||t("csrftoken"),o=Array.from(e);o.forEach(e=>{const t=new Blob([JSON.stringify({task_id:e,csrfmiddlewaretoken:n})],{type:"application/json"});navigator.sendBeacon("/api/cancel-task/",t)}),console.log(`[Task Cancel] Sent cancellation beacons for ${o.length} task(s)`)}}window.registerTaskForCancellation=function(n){n&&(e.add(n),console.log(`[Task Cancel] Registered task: ${n}`))},window.unregisterTaskForCancellation=function(n){n&&(e.delete(n),console.log(`[Task Cancel] Unregistered task: ${n}`))},window.addEventListener("beforeunload",a),window.addEventListener("pagehide",a),document.addEventListener("visibilitychange",function(){document.hidden?n=setTimeout(()=>{console.log("[Task Cancel] Page hidden for too long, cancelling tasks"),o()},6e4):n&&(clearTimeout(n),n=null)}),window.addEventListener("blur",function(){"hidden"in document||(n=setTimeout(()=>{o()},6e4))}),window.addEventListener("focus",function(){n&&(clearTimeout(n),n=null)}),console.log("[Task Cancel] Task cancellation system initialized"),window.addEventListener("pagehide",()=>{n&&clearTimeout(n)})}();