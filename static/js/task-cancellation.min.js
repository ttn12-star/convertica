!function(){"use strict";let e=new Set,n=new Set,o=new Map,t=null;function a(){return document.querySelector('meta[name="csrf-token"]')?.content||document.querySelector("[name=csrfmiddlewaretoken]")?.value||null}async function s(){if(0===e.size)return;console.log(`[Task Cancel] Cancelling ${e.size} active task(s)`);const n=Array.from(e).map(e=>async function(e){try{const n=a(),o=window.getTaskToken?window.getTaskToken(e):null,t=await fetch("/api/cancel-task/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":n},body:JSON.stringify({task_id:e,task_token:o})}),s=await t.json();return t.ok?(console.log(`[Task Cancel] Cancelled task: ${e}`,s),!0):(console.warn(`[Task Cancel] Failed to cancel task: ${e}`,s),!1)}catch(n){return console.error(`[Task Cancel] Error cancelling task: ${e}`,n),!1}}(e));await Promise.all(n),e.clear()}function i(){const o=Array.from(e).filter(e=>!n.has(e));if(o.length>0&&navigator.sendBeacon){const e=a();o.forEach(n=>{const o=window.getTaskToken?window.getTaskToken(n):null,t=new Blob([JSON.stringify({task_id:n,task_token:o,csrfmiddlewaretoken:e})],{type:"application/json"});navigator.sendBeacon("/api/cancel-task/",t)}),console.log(`[Task Cancel] Sent cancellation beacons for ${o.length} task(s), skipped ${n.size} background task(s)`)}}window.registerTaskForCancellation=function(n,t){n&&(e.add(n),t&&o.set(n,t),console.log(`[Task Cancel] Registered task: ${n}`))},window.registerTaskToken=function(e,n){e&&n&&o.set(e,n)},window.getTaskToken=function(e){return o.get(e)},window.unregisterTaskForCancellation=function(t){t&&(e.delete(t),n.delete(t),o.delete(t),console.log(`[Task Cancel] Unregistered task: ${t}`))},window.markTaskAsBackground=function(o){o&&(n.add(o),e.delete(o),console.log(`[Task Cancel] Moved task to background: ${o}`))},window.addEventListener("beforeunload",i),window.addEventListener("pagehide",i),document.addEventListener("visibilitychange",function(){document.hidden?t=setTimeout(()=>{console.log("[Task Cancel] Page hidden for too long, cancelling tasks"),s()},6e4):t&&(clearTimeout(t),t=null)}),window.addEventListener("blur",function(){"hidden"in document||(t=setTimeout(()=>{s()},6e4))}),window.addEventListener("focus",function(){t&&(clearTimeout(t),t=null)}),console.log("[Task Cancel] Task cancellation system initialized"),window.addEventListener("pagehide",()=>{t&&clearTimeout(t)})}();