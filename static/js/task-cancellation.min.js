!function(){"use strict";let e=new Set,n=new Set,t=null;function o(e){let n=null;if(document.cookie&&""!==document.cookie){const t=document.cookie.split(";");for(let o=0;o<t.length;o++){const a=t[o].trim();if(a.substring(0,e.length+1)===e+"="){n=decodeURIComponent(a.substring(e.length+1));break}}}return n}async function a(){if(0===e.size)return;console.log(`[Task Cancel] Cancelling ${e.size} active task(s)`);const n=Array.from(e).map(e=>async function(e){try{const n=document.querySelector("[name=csrfmiddlewaretoken]")?.value||document.querySelector('meta[name="csrf-token"]')?.content||o("csrftoken"),t=await fetch("/api/cancel-task/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":n},body:JSON.stringify({task_id:e})}),a=await t.json();return t.ok?(console.log(`[Task Cancel] Cancelled task: ${e}`,a),!0):(console.warn(`[Task Cancel] Failed to cancel task: ${e}`,a),!1)}catch(n){return console.error(`[Task Cancel] Error cancelling task: ${e}`,n),!1}}(e));await Promise.all(n),e.clear()}function c(){const t=Array.from(e).filter(e=>!n.has(e));if(t.length>0&&navigator.sendBeacon){const e=document.querySelector("[name=csrfmiddlewaretoken]")?.value||document.querySelector('meta[name="csrf-token"]')?.content||o("csrftoken");t.forEach(n=>{const t=new Blob([JSON.stringify({task_id:n,csrfmiddlewaretoken:e})],{type:"application/json"});navigator.sendBeacon("/api/cancel-task/",t)}),console.log(`[Task Cancel] Sent cancellation beacons for ${t.length} task(s), skipped ${n.size} background task(s)`)}}window.registerTaskForCancellation=function(n){n&&(e.add(n),console.log(`[Task Cancel] Registered task: ${n}`))},window.unregisterTaskForCancellation=function(t){t&&(e.delete(t),n.delete(t),console.log(`[Task Cancel] Unregistered task: ${t}`))},window.markTaskAsBackground=function(t){t&&(n.add(t),e.delete(t),console.log(`[Task Cancel] Moved task to background: ${t}`))},window.addEventListener("beforeunload",c),window.addEventListener("pagehide",c),document.addEventListener("visibilitychange",function(){document.hidden?t=setTimeout(()=>{console.log("[Task Cancel] Page hidden for too long, cancelling tasks"),a()},6e4):t&&(clearTimeout(t),t=null)}),window.addEventListener("blur",function(){"hidden"in document||(t=setTimeout(()=>{a()},6e4))}),window.addEventListener("focus",function(){t&&(clearTimeout(t),t=null)}),console.log("[Task Cancel] Task cancellation system initialized"),window.addEventListener("pagehide",()=>{t&&clearTimeout(t)})}();