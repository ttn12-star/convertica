class HTMLToPDFConverter{constructor(){this.htmlContentForm=document.getElementById("htmlContentForm"),this.urlForm=document.getElementById("urlForm"),this.htmlContentTab=document.getElementById("htmlContentTab"),this.urlTab=document.getElementById("urlTab"),this.progressSection=document.getElementById("progressSection"),this.progressBar=document.getElementById("progressBar"),this.progressPercent=document.getElementById("progressPercent"),this.progressMessage=document.getElementById("progressMessage"),this.resultSection=document.getElementById("resultSection"),this.downloadLink=document.getElementById("downloadLink"),this.convertAnotherBtn=document.getElementById("convertAnother"),this.currentMode="html",this.isPremium=!1,this.init()}init(){this.checkPremiumStatus(),this.htmlContentTab.addEventListener("click",()=>this.switchToHTMLMode()),this.urlTab.addEventListener("click",()=>this.switchToURLMode()),this.htmlContentForm.addEventListener("submit",t=>this.handleHTMLSubmit(t)),this.urlForm.addEventListener("submit",t=>this.handleURLSubmit(t)),this.convertAnotherBtn.addEventListener("click",()=>this.resetForm());document.getElementById("htmlContent").addEventListener("input",()=>this.updateCharCounter())}checkPremiumStatus(){fetch("/api/user-info/").then(t=>t.json()).then(t=>{this.isPremium=t.is_premium||!1,this.htmlMaxCharsFree=t.limits?.html_to_pdf_max_chars_free||1e4,this.htmlMaxCharsPremium=t.limits?.html_to_pdf_max_chars_premium||5e5,this.updateCharCounter()}).catch(t=>{console.log("Could not check premium status:",t),this.htmlMaxCharsFree=1e4,this.htmlMaxCharsPremium=5e5})}switchToHTMLMode(){this.currentMode="html",this.htmlContentForm.classList.remove("hidden"),this.urlForm.classList.add("hidden"),this.htmlContentTab.classList.add("bg-white","text-gray-900","shadow-sm"),this.htmlContentTab.classList.remove("text-gray-500"),this.urlTab.classList.remove("bg-white","text-gray-900","shadow-sm"),this.urlTab.classList.add("text-gray-500")}switchToURLMode(){this.currentMode="url",this.htmlContentForm.classList.add("hidden"),this.urlForm.classList.remove("hidden"),this.urlTab.classList.add("bg-white","text-gray-900","shadow-sm"),this.urlTab.classList.remove("text-gray-500"),this.htmlContentTab.classList.remove("bg-white","text-gray-900","shadow-sm"),this.htmlContentTab.classList.add("text-gray-500")}updateCharCounter(){const t=document.getElementById("htmlContent");if(!t)return;const e=t.value.length;let s=t.parentNode.querySelector(".char-counter");s||(s=document.createElement("div"),s.className="text-sm text-gray-500 mt-1 char-counter",t.parentNode.appendChild(s));const r=this.isPremium?this.htmlMaxCharsPremium||5e5:this.htmlMaxCharsFree||1e4;s.textContent=`${e.toLocaleString()} / ${r.toLocaleString()} characters`,e>r?(s.classList.add("text-red-500"),s.classList.remove("text-gray-500")):(s.classList.remove("text-red-500"),s.classList.add("text-gray-500"))}async handleHTMLSubmit(t){t.preventDefault();const e=document.getElementById("htmlContent").value.trim();if(!e)return void this.showError("Please enter HTML content to convert");const s=this.isPremium?this.htmlMaxCharsPremium||5e5:this.htmlMaxCharsFree||1e4;if(e.length>s)return void this.showError(`HTML content exceeds ${s.toLocaleString()} character limit`);if(!this.validateHTMLContent(e))return;this.showProgress();const r=new FormData(this.htmlContentForm);this.updateProgress(10,"Converting HTML to PDF...");try{const t=await fetch("/api/html-to-pdf/",{method:"POST",body:r,headers:{"X-CSRFToken":this.htmlContentForm.querySelector("[name=csrfmiddlewaretoken]").value}});if(!t.ok){const e=await t.json();throw new Error(e.error||"Conversion failed")}this.updateProgress(50,"Processing PDF...");const e=await t.blob(),s=t.headers.get("Content-Disposition");let o="converted.pdf";if(s){const t=s.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);t&&t[1]&&(o=t[1].replace(/['"]/g,""))}const n=window.URL.createObjectURL(e);this.updateProgress(100,"Conversion completed!"),this.showResult({download_url:n,filename:o})}catch(t){this.showError(t.message),this.hideProgress()}}async handleURLSubmit(t){t.preventDefault();if(!document.getElementById("url").value.trim())return void this.showError("Please enter a URL to convert");this.showProgress();const e=new FormData(this.urlForm);this.updateProgress(10,"Fetching web page...");try{const t=await fetch("/api/url-to-pdf/",{method:"POST",body:e,headers:{"X-CSRFToken":this.urlForm.querySelector("[name=csrfmiddlewaretoken]").value}});if(!t.ok){const e=await t.json();throw new Error(e.error||"Conversion failed")}this.updateProgress(50,"Processing PDF...");const s=await t.blob(),r=t.headers.get("Content-Disposition");let o="converted.pdf";if(r){const t=r.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);t&&t[1]&&(o=t[1].replace(/['"]/g,""))}const n=window.URL.createObjectURL(s);this.updateProgress(100,"Conversion completed!"),this.showResult({download_url:n,filename:o})}catch(t){this.showError(t.message),this.hideProgress()}}validateHTMLContent(t){return/<script[\s>]/i.test(t)?(this.showError("HTML contains <script> tags which cannot be processed for security reasons"),!1):/\son\w+\s*=|href\s*=\s*["']javascript:/i.test(t)?(this.showError("HTML contains javascript: event handlers which cannot be processed for security reasons"),!1):/vbscript:/i.test(t)?(this.showError("HTML contains vbscript: which cannot be processed for security reasons"),!1):/<iframe[\s>]/i.test(t)?(this.showError("HTML contains <iframe> tags which cannot be processed for security reasons"),!1):!/<(object|embed)[\s>]/i.test(t)||(this.showError("HTML contains <object> or <embed> tags which cannot be processed for security reasons"),!1)}showProgress(){this.progressSection.classList.remove("hidden"),this.resultSection.classList.add("hidden"),this.updateProgress(0,"Starting conversion..."),this.htmlContentForm.querySelector('button[type="submit"]').disabled=!0,this.urlForm.querySelector('button[type="submit"]').disabled=!0}updateProgress(t,e){this.progressBar.style.width=`${t}%`,this.progressPercent.textContent=`${t}%`,this.progressMessage.textContent=e}hideProgress(){this.progressSection.classList.add("hidden"),this.htmlContentForm.querySelector('button[type="submit"]').disabled=!1,this.urlForm.querySelector('button[type="submit"]').disabled=!1}showResult(t){if(this.hideProgress(),this.resultSection.classList.remove("hidden"),t.download_url){let e="converted.pdf";if("html"===this.currentMode){const t=document.getElementById("filename").value;e=t.endsWith(".pdf")?t:`${t}.pdf`}else{const t=document.getElementById("urlFilename").value;e=t.endsWith(".pdf")?t:`${t}.pdf`}this.downloadLink.href=t.download_url,this.downloadLink.download=e}}showError(t){const e=document.createElement("div");e.className="fixed top-4 right-4 bg-red-50 border border-red-200 rounded-lg p-4 shadow-lg z-50",e.innerHTML=`\n            <div class="flex items-center space-x-3">\n                <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />\n                </svg>\n                <div>\n                    <h3 class="text-sm font-medium text-red-900">Error</h3>\n                    <p class="text-sm text-red-700">${t}</p>\n                </div>\n                <button type="button" class="text-red-500 hover:text-red-700" onclick="this.parentElement.parentElement.remove()">\n                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />\n                    </svg>\n                </button>\n            </div>\n        `,document.body.appendChild(e),setTimeout(()=>{e.parentElement&&e.remove()},5e3)}resetForm(){this.hideProgress(),this.resultSection.classList.add("hidden"),this.htmlContentForm.reset(),this.urlForm.reset(),this.progressBar.style.width="0%",this.progressPercent.textContent="0%",this.progressMessage.textContent="Please wait while we convert your content to PDF...";const t=document.querySelector(".char-counter");t&&t.remove()}}document.addEventListener("DOMContentLoaded",()=>{new HTMLToPDFConverter});