document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("fileInput"),t=document.getElementById("fileInputDrop"),n=document.getElementById("pageNumberCanvas"),a=document.getElementById("pageNumberPageSelector"),i=document.getElementById("pageNumberPreviewSection"),s=document.getElementById("pageNumberSettingsSection"),d=document.getElementById("position"),o=document.getElementById("font_size"),r=document.getElementById("start_number"),l=document.getElementById("format_str");if(!(n&&a&&i&&s))return;let c=null,u=1,g=1.2;function m(){if("undefined"!=typeof pdfjsLib&&!pdfjsLib.GlobalWorkerOptions.workerSrc){const e="string"==typeof window.PDFJS_LOCAL_WORKER?window.PDFJS_LOCAL_WORKER:null;pdfjsLib.GlobalWorkerOptions.workerSrc=e||"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"}}async function f(e){if(!c)return;const t=await c.getPage(e),a=t.getViewport({scale:1});g=function(e){const t=n.parentElement.clientWidth-32,a=window.innerHeight>768?600:400,i=t/e.width,s=a/e.height;return Math.min(i,s,2)}(a);const i=t.getViewport({scale:g}),s=n.getContext("2d");n.width=i.width,n.height=i.height;const u={canvasContext:s,viewport:i};await t.render(u).promise;const m=d?.value||"bottom-center",f=parseInt(o?.value||"12",10)||12,p=function(e,t){const n=parseInt(r?.value||"1",10)||1,a=l?.value?.trim()||"{page}",i=n+(e-1);try{return a.replace("{page}",i).replace("{total}",t)}catch(e){return`${i} / ${t}`}}(e,c.numPages);console.log("Drawing page number:",{pageNum:e,text:p,position:m,fontSize:f,scale:g}),s.save(),s.fillStyle="#1f2937",s.font=f*g+"px Helvetica",s.textBaseline="alphabetic";const h=s.measureText(p).width,{x:w,y:v}=function(e,t,n,a,i){const s=36*g;let d,o;return d=e.includes("top")?s+a:n-s,o=e.includes("left")?s:e.includes("right")?t-s-i:t/2-i/2,{x:o,y:d}}(m,i.width,i.height,f*g,h);console.log("Text position:",{x:w,y:v,textWidth:h,canvasWidth:n.width,canvasHeight:n.height}),s.fillText(p,w,v),s.restore()}function p(e){window.showError(e,"editorResult"),i.classList.add("hidden"),s.classList.add("hidden")}async function h(e){try{if(function(){const e=document.getElementById("editorResult");e&&(e.classList.add("hidden"),e.innerHTML="")}(),"undefined"==typeof pdfjsLib)return void p("Unable to load PDF preview. Please refresh the page or disable browser extensions that may block scripts, then try again.");if(m(),"function"==typeof window.validatePdfPageLimit){if(!await window.validatePdfPageLimit(e))return i.classList.add("hidden"),void s.classList.add("hidden")}const t=await e.arrayBuffer(),n=pdfjsLib.getDocument({data:t});c=await n.promise,i.classList.remove("hidden"),s.classList.remove("hidden"),function(e){a.innerHTML="";for(let t=1;t<=e;t++){const e=document.createElement("option");e.value=t,e.textContent=`${t}`,a.appendChild(e)}u=1,a.value="1"}(c.numPages),await f(u)}catch(e){console.error("Failed to render PDF preview",e),i.classList.add("hidden"),s.classList.add("hidden");let t="Failed to load PDF file. Please try again.";e&&e.message&&(t=e.message.includes("Invalid PDF")?"Invalid PDF file. Please select a valid PDF file.":e.message.includes("password")?"This PDF is password protected. Please unlock it first.":e.message.includes("network")||e.message.includes("fetch")?"Network error. Please check your connection and try again.":e.message.includes("pages")&&e.message.includes("maximum")?e.message:`Error: ${e.message}`),p(t)}}m(),a.addEventListener("change",async e=>{u=parseInt(e.target.value,10)||1,await f(u)}),[d,o,r,l].forEach(e=>{e&&(e.addEventListener("input",()=>f(u)),e.addEventListener("change",()=>f(u)))});[e,t].forEach(n=>{n&&n.addEventListener("change",()=>{const n=e?.files?.[0]||t?.files?.[0]||null;n&&"application/pdf"===n.type?h(n):(i.classList.add("hidden"),s.classList.add("hidden"))})});const w=document.querySelectorAll(".format-preset");w.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.format;l&&(l.value=t,w.forEach(e=>{e.classList.remove("bg-blue-500","text-white","border-blue-500"),e.classList.add("bg-gray-100","border-gray-300")}),e.classList.remove("bg-gray-100","border-gray-300"),e.classList.add("bg-blue-500","text-white","border-blue-500"),c&&f(u))})});[d,o,r,l].forEach(e=>{e&&(e.addEventListener("input",()=>{c&&f(u)}),e.addEventListener("change",()=>{c&&f(u)}))}),a&&a.addEventListener("change",e=>{u=parseInt(e.target.value,10),c&&f(u)})});