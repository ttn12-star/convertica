document.addEventListener("DOMContentLoaded",()=>{const e="3.11.174",t="string"==typeof window.PDFJS_LOCAL_PDF?window.PDFJS_LOCAL_PDF:null,n="string"==typeof window.PDFJS_LOCAL_WORKER?window.PDFJS_LOCAL_WORKER:null,o=[...t?[t]:[],`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${e}/pdf.min.js`,`https://unpkg.com/pdfjs-dist@${e}/build/pdf.min.js`],i=[...n?[n]:[],`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${e}/pdf.worker.min.js`,`https://unpkg.com/pdfjs-dist@${e}/build/pdf.worker.min.js`];function d(e){return new Promise((t,n)=>{const o=Array.from(document.scripts).find(t=>t.src===e);if(o)return void 0!==window.pdfjsLib?t():(o.addEventListener("load",()=>t(),{once:!0}),void o.addEventListener("error",()=>n(new Error(`Failed to load ${e}`)),{once:!0}));const i=document.createElement("script");i.src=e,i.async=!0,i.crossOrigin="anonymous",i.onload=()=>t(),i.onerror=()=>n(new Error(`Failed to load ${e}`)),document.head.appendChild(i)})}void 0!==window.pdfjsLib&&(window.pdfjsLib.GlobalWorkerOptions.workerSrc=i[0]);const a=document.getElementById("editorForm");if(!a)return;const r=document.getElementById("fileInput"),s=document.getElementById("fileInputDrop"),l=(document.getElementById("selectFileButton"),document.getElementById("pdfPreviewSection")),c=document.getElementById("pdfCanvas"),h=(document.getElementById("pdfCanvasContainer"),document.getElementById("cropSelection")),u=document.getElementById("cropOverlay"),w=document.getElementById("cropOverlayTop"),g=document.getElementById("cropOverlayRight"),m=document.getElementById("cropOverlayBottom"),p=document.getElementById("cropOverlayLeft"),f=document.getElementById("cropReadyIndicator"),y=document.getElementById("pageSelector"),E=document.getElementById("editButton"),v=document.getElementById("editorResult");let x=null,L=1,C=0,M=1,B=0,I=0,b=0,_=0,D=null,R=!1,F=0,A=0,P=!1,O=0,S=0;async function T(e){try{k(),l.classList.remove("hidden");if(!await async function(){if(void 0!==window.pdfjsLib)return!0;for(const e of o)try{if(await d(e),void 0!==window.pdfjsLib)break}catch(e){}return void 0!==window.pdfjsLib&&(window.pdfjsLib.GlobalWorkerOptions.workerSrc||(window.pdfjsLib.GlobalWorkerOptions.workerSrc=i[0]),!0)}()||void 0===window.pdfjsLib)return window.showError("PDF preview engine (PDF.js) is not loaded. Please disable adblock for this site or check that cdnjs/unpkg are not blocked, then refresh the page.","editorResult"),l.classList.add("hidden"),void k();window.pdfjsLib.GlobalWorkerOptions.workerSrc||(window.pdfjsLib.GlobalWorkerOptions.workerSrc=i[0]);const t=await e.arrayBuffer();x=await window.pdfjsLib.getDocument({data:t}).promise,C=x.numPages;if(!await window.validatePdfPageLimit(e))return l.classList.add("hidden"),void k();y.innerHTML="";const n=window.PAGE_LABEL||"Page";for(let e=1;e<=C;e++){const t=document.createElement("option");t.value=e,t.textContent=`${n} ${e}`,y.appendChild(t)}L=1,await j(1),E&&(E.disabled=!1,E.classList.remove("opacity-50","cursor-not-allowed"))}catch(e){window.showError(window.FAILED_TO_LOAD_PDF||"Failed to load PDF file. Please try again.","editorResult"),"undefined"!=typeof console&&console.error&&console.error("Error loading PDF:",e)}}function k(){if(x){try{x.destroy()}catch(e){}x=null}if(L=1,C=0,D=null,R=!1,P=!1,c){c.getContext("2d").clearRect(0,0,c.width,c.height)}}async function j(e){if(x)try{const t=await x.getPage(e),n=t.getViewport({scale:1}),o=700,i=600/n.width,d=o/n.height;M=Math.min(i,d,1);const a=t.getViewport({scale:M});b=a.width,_=a.height,c.width=b,c.height=_,B=n.width,I=n.height;const r={canvasContext:c.getContext("2d"),viewport:a};await t.render(r).promise,$()}catch(e){window.showError("Failed to render PDF page.","editorResult"),"undefined"!=typeof console&&console.error&&console.error("Error rendering page:",e)}}function $(){const e=c.getBoundingClientRect(),t=e.width,n=e.height,o=.05*t,i=.05*n,d=o,a=i,r=t-2*o,s=n-2*i;D={x:d,y:a,width:r,height:s},J(d,a,r,s),V(d,a,r,s),q(),E&&(E.disabled=!1,E.classList.remove("opacity-50","cursor-not-allowed")),f&&(f.textContent=window.CROP_AREA_READY||"Crop area ready! Drag the box to move it, drag from outside to create a new selection, or use handles to resize.",f.classList.remove("hidden"))}r&&r.addEventListener("change",e=>{e.target.files&&e.target.files.length>0&&T(e.target.files[0])}),s&&s.addEventListener("change",e=>{e.target.files&&e.target.files.length>0&&T(e.target.files[0])}),y.addEventListener("change",async e=>{L=parseInt(e.target.value),await j(L)});const X=document.getElementById("pagesAll"),Y=document.getElementById("pagesCurrent"),N=document.getElementById("pagesCustom"),z=document.getElementById("pagesCustomInput");X&&X.addEventListener("change",()=>{z&&(z.disabled=!0,z.value="")}),Y&&Y.addEventListener("change",()=>{z&&(z.disabled=!0,z.value="")}),N&&z&&N.addEventListener("change",()=>{z.disabled=!1,z.focus()});let G=0,W=0,H=!1;function U(e,t,n){if(!x)return;const o=c.getBoundingClientRect(),i=e-o.left,d=t-o.top;if(n===h){if(!D||D.width<=0||D.height<=0)return;return P=!0,O=i-D.x,S=d-D.y,void(c.style.cursor="grabbing")}if(!(n&&n.classList&&n.classList.contains("crop-handle"))){if(D&&D.width>0&&D.height>0){if(i>=D.x&&i<=D.x+D.width&&d>=D.y&&d<=D.y+D.height)return P=!0,O=i-D.x,S=d-D.y,void(c.style.cursor="grabbing")}R=!0,F=i,A=d,c.style.cursor="crosshair",D={x:i,y:d,width:0,height:0},h.classList.remove("hidden"),J(i,d,0,0),f&&(f.textContent=window.DRAG_TO_SELECT||"Drag to select crop area...",f.classList.remove("hidden"))}}function J(e,t,n,o){const i=c.getBoundingClientRect(),d=i.width,a=i.height;e=Math.max(0,Math.min(e,d)),t=Math.max(0,Math.min(t,a)),n<0&&(e+=n,n=Math.abs(n)),o<0&&(t+=o,o=Math.abs(o)),n=Math.min(n,d-e),o=Math.min(o,a-t),h.style.left=`${e}px`,h.style.top=`${t}px`,h.style.width=`${n}px`,h.style.height=`${o}px`,h.classList.remove("hidden"),V(e,t,n,o)}function V(e,t,n,o){u&&!h.classList.contains("hidden")&&D?(u.classList.remove("hidden"),w.style.left="0px",w.style.top="0px",w.style.width=`${b}px`,w.style.height=`${t}px`,g.style.left=`${e+n}px`,g.style.top=`${t}px`,g.style.width=b-e-n+"px",g.style.height=`${o}px`,m.style.left="0px",m.style.top=`${t+o}px`,m.style.width=`${b}px`,m.style.height=_-t-o+"px",p.style.left="0px",p.style.top=`${t}px`,p.style.width=`${e}px`,p.style.height=`${o}px`):u&&u.classList.add("hidden")}function q(){if(!D)return void(E&&(E.disabled=!0,E.classList.add("opacity-50","cursor-not-allowed")));const e=B/b,t=I/_,n=D.x*e,o=(_-D.y-D.height)*t,i=D.width*e,d=D.height*t,a=document.getElementById("x"),r=document.getElementById("y"),s=document.getElementById("width"),l=document.getElementById("height");a&&(a.value=n.toFixed(2)),r&&(r.value=o.toFixed(2)),s&&(s.value=i.toFixed(2)),l&&(l.value=d.toFixed(2)),E&&s&&s.value&&parseFloat(s.value)>0?(E.disabled=!1,E.classList.remove("opacity-50","cursor-not-allowed")):E&&(E.disabled=!0,E.classList.add("opacity-50","cursor-not-allowed"))}c.addEventListener("mousemove",e=>{if(!x)return;const t=c.getBoundingClientRect();if(G=e.clientX-t.left,W=e.clientY-t.top,!R&&!P&&D&&D.width>0&&D.height>0){const t=h.querySelectorAll(".crop-handle");let n=!1;for(const o of t){const t=o.getBoundingClientRect();if(e.clientX>=t.left&&e.clientX<=t.right&&e.clientY>=t.top&&e.clientY<=t.bottom){n=!0;break}}G>=D.x&&G<=D.x+D.width&&W>=D.y&&W<=D.y+D.height&&!n?H||(c.style.cursor="move",H=!0):H&&(c.style.cursor="crosshair",H=!1)}}),document.addEventListener("touchmove",e=>{if(!x)return;const t=e.touches[0];if(!t)return;const n=c.getBoundingClientRect(),o=t.clientX-n.left,i=t.clientY-n.top;if(R||P){if(P&&D){let e=o-O,t=i-S;e=Math.max(0,Math.min(e,b-D.width)),t=Math.max(0,Math.min(t,_-D.height)),D.x=e,D.y=t,J(e,t,D.width,D.height),V(e,t,D.width,D.height)}else if(R){let e=Math.min(F,o),t=Math.min(A,i),n=Math.abs(o-F),d=Math.abs(i-A);D={x:e,y:t,width:n,height:d},J(e,t,n,d),V(e,t,n,d),q()}e.preventDefault()}},{passive:!1}),document.addEventListener("touchend",()=>{R&&!P?(R=!1,c.style.cursor="crosshair",D&&(D.width<10||D.height<10)?($(),f&&(f.textContent=window.SELECTION_TOO_SMALL||"Selection too small. Full page selected. Drag to create a new selection or drag the box to move it.")):D&&(q(),f&&(f.textContent=window.CROP_AREA_SELECTED||'Crop area selected! Drag the box to move it or use handles to resize. Click "Crop PDF" when ready.'))):P&&(P=!1,c.style.cursor=H?"move":"crosshair",D&&(q(),f&&(f.textContent=window.CROP_AREA_MOVED||'Crop area moved! Drag again to reposition or use handles to resize. Click "Crop PDF" when ready.')))}),c.addEventListener("mouseleave",()=>{c.style.cursor="crosshair",H=!1}),h&&(h.addEventListener("mousedown",e=>{U(e.clientX,e.clientY,h),e.preventDefault(),e.stopPropagation()}),h.addEventListener("touchstart",e=>{const t=e.touches[0];if(!t)return;const n=h.getBoundingClientRect(),o=t.clientX-n.left,i=t.clientY-n.top;o>=0&&o<=n.width&&i>=0&&i<=n.height&&(U(t.clientX,t.clientY,h),e.preventDefault(),e.stopPropagation())},{passive:!1})),c.addEventListener("mousedown",e=>{U(e.clientX,e.clientY,e.target),e.preventDefault()}),c.addEventListener("touchstart",e=>{const t=e.touches[0];if(!t)return;const n=c.getBoundingClientRect(),o=t.clientX-n.left,i=t.clientY-n.top;o>=0&&o<=n.width&&i>=0&&i<=n.height&&(U(t.clientX,t.clientY,e.target),e.preventDefault())},{passive:!1}),document.addEventListener("mousemove",e=>{if(!x)return;const t=c.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top;if(P&&D){let e=n-O,t=o-S;const i=c.getBoundingClientRect(),d=i.width,a=i.height;return e=Math.max(0,Math.min(e,d-D.width)),t=Math.max(0,Math.min(t,a-D.height)),D.x=e,D.y=t,J(e,t,D.width,D.height),V(e,t,D.width,D.height),void q()}if(R&&!P){const e=Math.min(F,n),t=Math.max(F,n),i=Math.min(A,o),d=t-e,a=Math.max(A,o)-i,r=c.getBoundingClientRect(),s=r.width,l=r.height,h=Math.max(0,Math.min(e,s-d)),u=Math.max(0,Math.min(i,l-a)),w=Math.min(d,s-h),g=Math.min(a,l-u);D={x:h,y:u,width:w,height:g},J(h,u,w,g),V(h,u,w,g),q()}}),document.addEventListener("mouseup",e=>{R&&!P?(R=!1,c.style.cursor="crosshair",D&&(D.width<10||D.height<10)?($(),f&&(f.textContent=window.SELECTION_TOO_SMALL||"Selection too small. Full page selected. Drag to create a new selection or drag the box to move it.")):D&&(q(),f&&(f.textContent=window.CROP_AREA_SELECTED||'Crop area selected! Drag the box to move it or use handles to resize. Click "Crop PDF" when ready.'))):P&&(P=!1,c.style.cursor=H?"move":"crosshair",D&&(q(),f&&(f.textContent=window.CROP_AREA_MOVED||'Crop area moved! Drag again to reposition or use handles to resize. Click "Crop PDF" when ready.')))});const K=h.querySelectorAll(".crop-handle");let Q=null,Z=0,ee=0,te=null;function ne(){window.hideDownload("downloadContainer")}function oe(e){E&&(E.disabled=e);a.querySelectorAll("input, select, textarea, button").forEach(t=>{t!==E&&(t.disabled=e)})}K.forEach(e=>{e.addEventListener("mousedown",t=>{if(t.stopPropagation(),!D)return;Q=e;const n=c.getBoundingClientRect();Z=t.clientX-n.left,ee=t.clientY-n.top,te={...D}}),e.addEventListener("touchstart",t=>{t.stopPropagation();const n=t.touches[0];if(!n||!D)return;Q=e;const o=c.getBoundingClientRect();Z=n.clientX-o.left,ee=n.clientY-o.top,te={...D},t.preventDefault()},{passive:!1})}),document.addEventListener("mousemove",e=>{if(!Q||!te)return;const t=c.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=n-Z,d=o-ee;let a=te.x,r=te.y,s=te.width,l=te.height;const h=Q.className.split(" ").find(e=>"crop-handle"!==e);"nw"===h?(a=Math.max(0,te.x+i),r=Math.max(0,te.y+d),s=te.width-i,l=te.height-d):"ne"===h?(r=Math.max(0,te.y+d),s=te.width+i,l=te.height-d):"sw"===h?(a=Math.max(0,te.x+i),s=te.width-i,l=te.height+d):"se"===h?(s=te.width+i,l=te.height+d):"n"===h?(r=Math.max(0,te.y+d),l=te.height-d):"s"===h?l=te.height+d:"w"===h?(a=Math.max(0,te.x+i),s=te.width-i):"e"===h&&(s=te.width+i),a=Math.max(0,Math.min(a,b)),r=Math.max(0,Math.min(r,_)),s=Math.max(10,Math.min(s,b-a)),l=Math.max(10,Math.min(l,_-r)),D={x:a,y:r,width:s,height:l},J(a,r,s,l),V(a,r,s,l),q()}),document.addEventListener("mouseup",e=>{Q&&(D&&D.width>0&&D.height>0&&q(),Q=null,te=null)}),document.addEventListener("touchmove",e=>{if(!Q||!te)return;const t=e.touches[0];if(!t)return;const n=c.getBoundingClientRect(),o=t.clientX-n.left,i=t.clientY-n.top,d=o-Z,a=i-ee;let r=te.x,s=te.y,l=te.width,h=te.height;const u=Q.className.split(" ").find(e=>"crop-handle"!==e);"nw"===u?(r=Math.max(0,te.x+d),s=Math.max(0,te.y+a),l=te.width-d,h=te.height-a):"ne"===u?(s=Math.max(0,te.y+a),l=te.width+d,h=te.height-a):"sw"===u?(r=Math.max(0,te.x+d),l=te.width-d,h=te.height+a):"se"===u?(l=te.width+d,h=te.height+a):"n"===u?(s=Math.max(0,te.y+a),h=te.height-a):"s"===u?h=te.height+a:"w"===u?(r=Math.max(0,te.x+d),l=te.width-d):"e"===u&&(l=te.width+d),r=Math.max(0,Math.min(r,b)),s=Math.max(0,Math.min(s,_)),l=Math.max(10,Math.min(l,b-r)),h=Math.max(10,Math.min(h,_-s)),D={x:r,y:s,width:l,height:h},J(r,s,l,h),V(r,s,l,h),q(),e.preventDefault()},{passive:!1}),document.addEventListener("touchend",e=>{Q&&(D&&D.width>0&&D.height>0&&q(),Q=null,te=null)}),a.addEventListener("submit",async e=>{if(e.preventDefault(),!D||!document.getElementById("width").value)return void window.showError("Please select the crop area by dragging on the PDF. The blue highlighted area will be kept.","editorResult");const t=new FormData,n=window.FILE_INPUT_NAME||"pdf_file",o=r?.files&&r.files.length>0?r.files:s?.files&&s.files.length>0?s.files:null,i=Boolean(window.BATCH_ENABLED&&window.IS_PREMIUM&&o&&o.length>1&&window.BATCH_API_URL&&window.BATCH_FIELD_NAME),d=o?.[0]||null;if(!d)return void window.showError(window.SELECT_FILE_MESSAGE||"Please select a file","editorResult");if(i){const e=window.BATCH_FIELD_NAME;Array.from(o).forEach(n=>{t.append(e,n)})}else t.append(n,d);const a=document.getElementById("x").value,c=document.getElementById("y").value,h=document.getElementById("width").value,u=document.getElementById("height").value;if(!(a&&c&&h&&u))return void window.showError("Please adjust the crop area first.","editorResult");t.append("x",parseFloat(a).toFixed(2)),t.append("y",parseFloat(c).toFixed(2)),t.append("width",parseFloat(h).toFixed(2)),t.append("height",parseFloat(u).toFixed(2));document.getElementById("pagesAll");const w=document.getElementById("pagesCurrent"),g=document.getElementById("pagesCustom"),m=document.getElementById("pagesCustomInput");let p="all";p=w&&w.checked?L.toString():g&&g.checked&&m&&m.value.trim()?m.value.trim():"all",t.append("pages",p);const f=document.getElementById("scaleToPageSize");f&&f.checked?t.append("scale_to_page_size","true"):t.append("scale_to_page_size","false"),v&&v.classList.add("hidden"),ne(),window.showLoading("loadingContainer",{showProgress:!i}),oe(!0);try{const e=i?window.BATCH_API_URL:window.API_URL,n=await fetch(e,{method:"POST",headers:{"X-CSRFToken":window.CSRF_TOKEN},body:t});if(!n.ok){const e=await n.json().catch(()=>({}));throw e.error?new Error(e.error):new Error("API returned error but no error message")}const o=await n.blob();window.hideLoading("loadingContainer");const a=n.headers.get("content-disposition");let r=i?"convertica.zip":d.name;if(a){const e=a.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);e&&e[1]&&(r=e[1].replace(/['"]/g,""))}window.showDownloadButton(o,r,"downloadContainer",{successTitle:window.SUCCESS_TITLE||"Editing Complete!",downloadButtonText:window.DOWNLOAD_BUTTON_TEXT||"Download File",convertAnotherText:window.EDIT_ANOTHER_TEXT||"Edit another file",onConvertAnother:()=>{const e=document.getElementById("selectedFile");e&&e.classList.add("hidden");const t=document.getElementById("fileInput");t&&(t.value="");const n=document.getElementById("fileInputDrop");n&&(n.value=""),ne(),k(),l&&l.classList.add("hidden"),window.scrollTo({top:0,behavior:"smooth"}),setTimeout(()=>{const e=document.getElementById("selectFileButton");e&&e.focus({preventScroll:!0})},800)}}),oe(!1)}catch(e){window.hideLoading("loadingContainer"),window.showError(e.message||window.ERROR_MESSAGE,"editorResult"),oe(!1)}})});