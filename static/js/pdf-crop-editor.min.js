document.addEventListener("DOMContentLoaded",()=>{const e="3.11.174",t="string"==typeof window.PDFJS_LOCAL_PDF?window.PDFJS_LOCAL_PDF:null,n="string"==typeof window.PDFJS_LOCAL_WORKER?window.PDFJS_LOCAL_WORKER:null,o=[...t?[t]:[],`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${e}/pdf.min.js`,`https://unpkg.com/pdfjs-dist@${e}/build/pdf.min.js`],i=[...n?[n]:[],`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${e}/pdf.worker.min.js`,`https://unpkg.com/pdfjs-dist@${e}/build/pdf.worker.min.js`];function d(e){return new Promise((t,n)=>{const o=Array.from(document.scripts).find(t=>t.src===e);if(o)return void 0!==window.pdfjsLib?t():(o.addEventListener("load",()=>t(),{once:!0}),void o.addEventListener("error",()=>n(new Error(`Failed to load ${e}`)),{once:!0}));const i=document.createElement("script");i.src=e,i.async=!0,i.crossOrigin="anonymous",i.onload=()=>t(),i.onerror=()=>n(new Error(`Failed to load ${e}`)),document.head.appendChild(i)})}void 0!==window.pdfjsLib&&(window.pdfjsLib.GlobalWorkerOptions.workerSrc=i[0]);const a=document.getElementById("editorForm");if(!a)return;const r=document.getElementById("fileInput"),s=document.getElementById("fileInputDrop"),l=(document.getElementById("selectFileButton"),document.getElementById("pdfPreviewSection")),c=document.getElementById("pdfCanvas"),h=document.getElementById("pdfCanvasContainer"),u=document.getElementById("cropSelection"),w=document.getElementById("cropOverlay"),g=document.getElementById("cropOverlayTop"),m=document.getElementById("cropOverlayRight"),p=document.getElementById("cropOverlayBottom"),f=document.getElementById("cropOverlayLeft"),y=document.getElementById("cropReadyIndicator"),E=document.getElementById("pageSelector"),v=document.getElementById("editButton"),x=document.getElementById("editorResult");let L=null,C=1,M=0,B=1,b=0,I=0,_=0,D=0,R=null,A=!1,F=0,P=0,O=!1,S=0,T=0;async function k(e){try{j(),l.classList.remove("hidden");if(!await async function(){if(void 0!==window.pdfjsLib)return!0;for(const e of o)try{if(await d(e),void 0!==window.pdfjsLib)break}catch(e){}return void 0!==window.pdfjsLib&&(window.pdfjsLib.GlobalWorkerOptions.workerSrc||(window.pdfjsLib.GlobalWorkerOptions.workerSrc=i[0]),!0)}()||void 0===window.pdfjsLib)return window.showError("PDF preview engine (PDF.js) is not loaded. Please disable adblock for this site or check that cdnjs/unpkg are not blocked, then refresh the page.","editorResult"),l.classList.add("hidden"),void j();window.pdfjsLib.GlobalWorkerOptions.workerSrc||(window.pdfjsLib.GlobalWorkerOptions.workerSrc=i[0]);const t=await e.arrayBuffer();L=await window.pdfjsLib.getDocument({data:t}).promise,M=L.numPages;if(!await window.validatePdfPageLimit(e))return l.classList.add("hidden"),void j();E.innerHTML="";const n=window.PAGE_LABEL||"Page";for(let e=1;e<=M;e++){const t=document.createElement("option");t.value=e,t.textContent=`${n} ${e}`,E.appendChild(t)}C=1,await $(1),v&&(v.disabled=!1,v.classList.remove("opacity-50","cursor-not-allowed"))}catch(e){window.showError(window.FAILED_TO_LOAD_PDF||"Failed to load PDF file. Please try again.","editorResult"),"undefined"!=typeof console&&console.error&&console.error("Error loading PDF:",e)}}function j(){if(L){try{L.destroy()}catch(e){}L=null}if(C=1,M=0,R=null,A=!1,O=!1,c){c.getContext("2d").clearRect(0,0,c.width,c.height)}}async function $(e){if(L)try{const t=await L.getPage(e),n=t.getViewport({scale:1}),o=700,i=600/n.width,d=o/n.height;B=Math.min(i,d,1);const a=t.getViewport({scale:B});_=a.width,D=a.height,c.width=_,c.height=D,b=n.width,I=n.height;const r={canvasContext:c.getContext("2d"),viewport:a};await t.render(r).promise,X()}catch(e){window.showError("Failed to render PDF page.","editorResult"),"undefined"!=typeof console&&console.error&&console.error("Error rendering page:",e)}}function X(){const e=c.getBoundingClientRect(),t=e.width,n=e.height,o=.05*t,i=.05*n,d=o,a=i,r=t-2*o,s=n-2*i;R={x:d,y:a,width:r,height:s},V(d,a,r,s),q(d,a,r,s),K(),v&&(v.disabled=!1,v.classList.remove("opacity-50","cursor-not-allowed")),y&&(y.textContent=window.CROP_AREA_READY||"Crop area ready! Drag the box to move it, drag from outside to create a new selection, or use handles to resize.",y.classList.remove("hidden"))}r&&r.addEventListener("change",e=>{e.target.files&&e.target.files.length>0&&k(e.target.files[0])}),s&&s.addEventListener("change",e=>{e.target.files&&e.target.files.length>0&&k(e.target.files[0])}),E.addEventListener("change",async e=>{C=parseInt(e.target.value),await $(C)});const Y=document.getElementById("pagesAll"),N=document.getElementById("pagesCurrent"),z=document.getElementById("pagesCustom"),G=document.getElementById("pagesCustomInput");Y&&Y.addEventListener("change",()=>{G&&(G.disabled=!0,G.value="")}),N&&N.addEventListener("change",()=>{G&&(G.disabled=!0,G.value="")}),z&&G&&z.addEventListener("change",()=>{G.disabled=!1,G.focus()});let W=0,H=0,U=!1;function J(e,t,n){if(!L)return;const o=c.getBoundingClientRect(),i=e-o.left,d=t-o.top;if(n===u){if(!R||R.width<=0||R.height<=0)return;return O=!0,S=i-R.x,T=d-R.y,void(c.style.cursor="grabbing")}if(!(n&&n.classList&&n.classList.contains("crop-handle"))){if(R&&R.width>0&&R.height>0){if(i>=R.x&&i<=R.x+R.width&&d>=R.y&&d<=R.y+R.height)return O=!0,S=i-R.x,T=d-R.y,void(c.style.cursor="grabbing")}A=!0,F=i,P=d,c.style.cursor="crosshair",R={x:i,y:d,width:0,height:0},u.classList.remove("hidden"),V(i,d,0,0),y&&(y.textContent=window.DRAG_TO_SELECT||"Drag to select crop area...",y.classList.remove("hidden"))}}function V(e,t,n,o){const i=c.getBoundingClientRect(),d=i.width,a=i.height;e=Math.max(0,Math.min(e,d)),t=Math.max(0,Math.min(t,a)),n<0&&(e+=n,n=Math.abs(n)),o<0&&(t+=o,o=Math.abs(o)),n=Math.min(n,d-e),o=Math.min(o,a-t),u.style.left=`${e}px`,u.style.top=`${t}px`,u.style.width=`${n}px`,u.style.height=`${o}px`,u.classList.remove("hidden"),q(e,t,n,o)}function q(e,t,n,o){w&&!u.classList.contains("hidden")&&R?(w.classList.remove("hidden"),g.style.left="0px",g.style.top="0px",g.style.width=`${_}px`,g.style.height=`${t}px`,m.style.left=`${e+n}px`,m.style.top=`${t}px`,m.style.width=_-e-n+"px",m.style.height=`${o}px`,p.style.left="0px",p.style.top=`${t+o}px`,p.style.width=`${_}px`,p.style.height=D-t-o+"px",f.style.left="0px",f.style.top=`${t}px`,f.style.width=`${e}px`,f.style.height=`${o}px`):w&&w.classList.add("hidden")}function K(){if(!R)return void(v&&(v.disabled=!0,v.classList.add("opacity-50","cursor-not-allowed")));const e=b/_,t=I/D,n=R.x*e,o=(D-R.y-R.height)*t,i=R.width*e,d=R.height*t,a=document.getElementById("x"),r=document.getElementById("y"),s=document.getElementById("width"),l=document.getElementById("height");a&&(a.value=n.toFixed(2)),r&&(r.value=o.toFixed(2)),s&&(s.value=i.toFixed(2)),l&&(l.value=d.toFixed(2)),v&&s&&s.value&&parseFloat(s.value)>0?(v.disabled=!1,v.classList.remove("opacity-50","cursor-not-allowed")):v&&(v.disabled=!0,v.classList.add("opacity-50","cursor-not-allowed"))}c.addEventListener("mousemove",e=>{if(!L)return;const t=c.getBoundingClientRect();if(W=e.clientX-t.left,H=e.clientY-t.top,!A&&!O&&R&&R.width>0&&R.height>0){const t=u.querySelectorAll(".crop-handle");let n=!1;for(const o of t){const t=o.getBoundingClientRect();if(e.clientX>=t.left&&e.clientX<=t.right&&e.clientY>=t.top&&e.clientY<=t.bottom){n=!0;break}}W>=R.x&&W<=R.x+R.width&&H>=R.y&&H<=R.y+R.height&&!n?U||(c.style.cursor="move",U=!0):U&&(c.style.cursor="crosshair",U=!1)}}),document.addEventListener("touchmove",e=>{if(!L)return;if(!A&&!O)return;const t=e.touches[0];if(!t)return;if(!h)return;const n=c.getBoundingClientRect(),o=t.clientX-n.left,i=t.clientY-n.top;if(O&&R){let e=o-S,t=i-T;e=Math.max(0,Math.min(e,_-R.width)),t=Math.max(0,Math.min(t,D-R.height)),R.x=e,R.y=t,V(e,t,R.width,R.height),q(e,t,R.width,R.height)}else if(A){let e=Math.min(F,o),t=Math.min(P,i),n=Math.abs(o-F),d=Math.abs(i-P);R={x:e,y:t,width:n,height:d},V(e,t,n,d),q(e,t,n,d),K()}e.preventDefault()},{passive:!1}),document.addEventListener("touchend",()=>{A&&!O?(A=!1,c.style.cursor="crosshair",R&&(R.width<10||R.height<10)?(X(),y&&(y.textContent=window.SELECTION_TOO_SMALL||"Selection too small. Full page selected. Drag to create a new selection or drag the box to move it.")):R&&(K(),y&&(y.textContent=window.CROP_AREA_SELECTED||'Crop area selected! Drag the box to move it or use handles to resize. Click "Crop PDF" when ready.'))):O&&(O=!1,c.style.cursor=U?"move":"crosshair",R&&(K(),y&&(y.textContent=window.CROP_AREA_MOVED||'Crop area moved! Drag again to reposition or use handles to resize. Click "Crop PDF" when ready.')))}),c.addEventListener("mouseleave",()=>{c.style.cursor="crosshair",U=!1}),u&&(u.addEventListener("mousedown",e=>{J(e.clientX,e.clientY,u),e.preventDefault(),e.stopPropagation()}),u.addEventListener("touchstart",e=>{const t=e.touches[0];if(!t)return;const n=u.getBoundingClientRect(),o=t.clientX-n.left,i=t.clientY-n.top;o>=0&&o<=n.width&&i>=0&&i<=n.height&&(J(t.clientX,t.clientY,u),e.preventDefault(),e.stopPropagation())},{passive:!1})),c.addEventListener("mousedown",e=>{J(e.clientX,e.clientY,e.target),e.preventDefault()}),c.addEventListener("touchstart",e=>{const t=e.touches[0];if(!t)return;const n=c.getBoundingClientRect(),o=t.clientX-n.left,i=t.clientY-n.top;o>=0&&o<=n.width&&i>=0&&i<=n.height&&(J(t.clientX,t.clientY,e.target),e.preventDefault())},{passive:!1}),document.addEventListener("mousemove",e=>{if(!L)return;const t=c.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top;if(O&&R){let e=n-S,t=o-T;const i=c.getBoundingClientRect(),d=i.width,a=i.height;return e=Math.max(0,Math.min(e,d-R.width)),t=Math.max(0,Math.min(t,a-R.height)),R.x=e,R.y=t,V(e,t,R.width,R.height),q(e,t,R.width,R.height),void K()}if(A&&!O){const e=Math.min(F,n),t=Math.max(F,n),i=Math.min(P,o),d=t-e,a=Math.max(P,o)-i,r=c.getBoundingClientRect(),s=r.width,l=r.height,h=Math.max(0,Math.min(e,s-d)),u=Math.max(0,Math.min(i,l-a)),w=Math.min(d,s-h),g=Math.min(a,l-u);R={x:h,y:u,width:w,height:g},V(h,u,w,g),q(h,u,w,g),K()}}),document.addEventListener("mouseup",e=>{A&&!O?(A=!1,c.style.cursor="crosshair",R&&(R.width<10||R.height<10)?(X(),y&&(y.textContent=window.SELECTION_TOO_SMALL||"Selection too small. Full page selected. Drag to create a new selection or drag the box to move it.")):R&&(K(),y&&(y.textContent=window.CROP_AREA_SELECTED||'Crop area selected! Drag the box to move it or use handles to resize. Click "Crop PDF" when ready.'))):O&&(O=!1,c.style.cursor=U?"move":"crosshair",R&&(K(),y&&(y.textContent=window.CROP_AREA_MOVED||'Crop area moved! Drag again to reposition or use handles to resize. Click "Crop PDF" when ready.')))});const Q=u.querySelectorAll(".crop-handle");let Z=null,ee=0,te=0,ne=null;function oe(){window.hideDownload("downloadContainer")}function ie(e){v&&(v.disabled=e);a.querySelectorAll("input, select, textarea, button").forEach(t=>{t!==v&&(t.disabled=e)})}Q.forEach(e=>{e.addEventListener("mousedown",t=>{if(t.stopPropagation(),!R)return;Z=e;const n=c.getBoundingClientRect();ee=t.clientX-n.left,te=t.clientY-n.top,ne={...R}}),e.addEventListener("touchstart",t=>{t.stopPropagation();const n=t.touches[0];if(!n||!R)return;Z=e;const o=c.getBoundingClientRect();ee=n.clientX-o.left,te=n.clientY-o.top,ne={...R},t.preventDefault()},{passive:!1})}),document.addEventListener("mousemove",e=>{if(!Z||!ne)return;const t=c.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=n-ee,d=o-te;let a=ne.x,r=ne.y,s=ne.width,l=ne.height;const h=Z.className.split(" ").find(e=>"crop-handle"!==e);"nw"===h?(a=Math.max(0,ne.x+i),r=Math.max(0,ne.y+d),s=ne.width-i,l=ne.height-d):"ne"===h?(r=Math.max(0,ne.y+d),s=ne.width+i,l=ne.height-d):"sw"===h?(a=Math.max(0,ne.x+i),s=ne.width-i,l=ne.height+d):"se"===h?(s=ne.width+i,l=ne.height+d):"n"===h?(r=Math.max(0,ne.y+d),l=ne.height-d):"s"===h?l=ne.height+d:"w"===h?(a=Math.max(0,ne.x+i),s=ne.width-i):"e"===h&&(s=ne.width+i),a=Math.max(0,Math.min(a,_)),r=Math.max(0,Math.min(r,D)),s=Math.max(10,Math.min(s,_-a)),l=Math.max(10,Math.min(l,D-r)),R={x:a,y:r,width:s,height:l},V(a,r,s,l),q(a,r,s,l),K()}),document.addEventListener("mouseup",e=>{Z&&(R&&R.width>0&&R.height>0&&K(),Z=null,ne=null)}),document.addEventListener("touchmove",e=>{if(!Z||!ne)return;const t=e.touches[0];if(!t)return;const n=c.getBoundingClientRect(),o=t.clientX-n.left,i=t.clientY-n.top,d=o-ee,a=i-te;let r=ne.x,s=ne.y,l=ne.width,h=ne.height;const u=Z.className.split(" ").find(e=>"crop-handle"!==e);"nw"===u?(r=Math.max(0,ne.x+d),s=Math.max(0,ne.y+a),l=ne.width-d,h=ne.height-a):"ne"===u?(s=Math.max(0,ne.y+a),l=ne.width+d,h=ne.height-a):"sw"===u?(r=Math.max(0,ne.x+d),l=ne.width-d,h=ne.height+a):"se"===u?(l=ne.width+d,h=ne.height+a):"n"===u?(s=Math.max(0,ne.y+a),h=ne.height-a):"s"===u?h=ne.height+a:"w"===u?(r=Math.max(0,ne.x+d),l=ne.width-d):"e"===u&&(l=ne.width+d),r=Math.max(0,Math.min(r,_)),s=Math.max(0,Math.min(s,D)),l=Math.max(10,Math.min(l,_-r)),h=Math.max(10,Math.min(h,D-s)),R={x:r,y:s,width:l,height:h},V(r,s,l,h),q(r,s,l,h),K(),e.preventDefault()},{passive:!1}),document.addEventListener("touchend",e=>{Z&&(R&&R.width>0&&R.height>0&&K(),Z=null,ne=null)}),a.addEventListener("submit",async e=>{if(e.preventDefault(),!R||!document.getElementById("width").value)return void window.showError("Please select the crop area by dragging on the PDF. The blue highlighted area will be kept.","editorResult");const t=new FormData,n=window.FILE_INPUT_NAME||"pdf_file",o=r?.files&&r.files.length>0?r.files:s?.files&&s.files.length>0?s.files:null,i=Boolean(window.BATCH_ENABLED&&window.IS_PREMIUM&&o&&o.length>1&&window.BATCH_API_URL&&window.BATCH_FIELD_NAME),d=o?.[0]||null;if(!d)return void window.showError(window.SELECT_FILE_MESSAGE||"Please select a file","editorResult");if(i){const e=window.BATCH_FIELD_NAME;Array.from(o).forEach(n=>{t.append(e,n)})}else t.append(n,d);const a=document.getElementById("x").value,c=document.getElementById("y").value,h=document.getElementById("width").value,u=document.getElementById("height").value;if(!(a&&c&&h&&u))return void window.showError("Please adjust the crop area first.","editorResult");t.append("x",parseFloat(a).toFixed(2)),t.append("y",parseFloat(c).toFixed(2)),t.append("width",parseFloat(h).toFixed(2)),t.append("height",parseFloat(u).toFixed(2));document.getElementById("pagesAll");const w=document.getElementById("pagesCurrent"),g=document.getElementById("pagesCustom"),m=document.getElementById("pagesCustomInput");let p="all";p=w&&w.checked?C.toString():g&&g.checked&&m&&m.value.trim()?m.value.trim():"all",t.append("pages",p);const f=document.getElementById("scaleToPageSize");f&&f.checked?t.append("scale_to_page_size","true"):t.append("scale_to_page_size","false"),x&&x.classList.add("hidden"),oe(),window.showLoading("loadingContainer",{showProgress:!i}),ie(!0),window._onCancelCallback=()=>{window.hideLoading("loadingContainer"),ie(!1)};const y=new AbortController;window._currentAbortController=y;try{const e=i?window.BATCH_API_URL:window.API_URL,n=await fetch(e,{method:"POST",headers:{"X-CSRFToken":window.CSRF_TOKEN},body:t,signal:y.signal});if(!n.ok){const e=await n.json().catch(()=>({}));throw e.error?new Error(e.error):new Error("API returned error but no error message")}const o=await n.blob();window.hideLoading("loadingContainer");const a=n.headers.get("content-disposition");let r=i?"convertica.zip":d.name;if(a){const e=a.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);e&&e[1]&&(r=e[1].replace(/['"]/g,""))}window.showDownloadButton(o,r,"downloadContainer",{successTitle:window.SUCCESS_TITLE||"Editing Complete!",downloadButtonText:window.DOWNLOAD_BUTTON_TEXT||"Download File",convertAnotherText:window.EDIT_ANOTHER_TEXT||"Edit another file",onConvertAnother:()=>{const e=document.getElementById("selectedFile");e&&e.classList.add("hidden");const t=document.getElementById("fileInput");t&&(t.value="");const n=document.getElementById("fileInputDrop");n&&(n.value=""),oe(),j(),l&&l.classList.add("hidden"),window.scrollTo({top:0,behavior:"smooth"}),setTimeout(()=>{const e=document.getElementById("selectFileButton");e&&e.focus({preventScroll:!0})},800)}}),ie(!1)}catch(e){if(e&&"AbortError"===e.name)return;window.hideLoading("loadingContainer"),window.showError(e.message||window.ERROR_MESSAGE,"editorResult"),ie(!1)}})});