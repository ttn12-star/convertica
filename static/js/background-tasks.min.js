!function(){"use strict";const e="convertica_bg_tasks";let t=null;function n(){try{return JSON.parse(localStorage.getItem(e))||[]}catch(e){return[]}}function o(t){localStorage.setItem(e,JSON.stringify(t))}function r(e){const t=n().filter(t=>t.taskId!==e);o(t),c(),0===t.filter(e=>"processing"===e.status).length&&a()}function s(){t||(t=setInterval(i,5e3),i())}function a(){t&&(clearInterval(t),t=null)}async function i(){let e=n(),t=!1;const r=Date.now(),s=e.length;e=e.filter(e=>r-e.startedAt<3e6||"success"===e.status),e.length!==s&&(t=!0);const i=e.filter(e=>"processing"===e.status);if(0===i.length)return t&&o(e),c(),void a();for(const e of i)try{const n=await fetch(`/api/tasks/${e.taskId}/status/`);if(!n.ok)continue;const o=await n.json();"SUCCESS"===o.status?(e.status="success",e.outputFilename=o.output_filename||e.originalFilename,t=!0,e.notified||(e.notified=!0,d(window.BG_TASK_DONE_TEXT||"File is ready!",e.outputFilename,"success",e.taskId))):"FAILURE"!==o.status&&"REVOKED"!==o.status||(e.status="error",e.error=o.error||"Conversion failed",t=!0,e.notified||(e.notified=!0,d(window.BG_TASK_ERROR_TEXT||"Conversion failed",e.error,"error")))}catch(e){}t&&o(e),c()}function d(e,t,n,o){const r=function(){let e=document.getElementById("bgTaskToastContainer");return e||(e=document.createElement("div"),e.id="bgTaskToastContainer",e.className="fixed top-20 right-4 z-[100] flex flex-col gap-3 max-w-sm",e.style.pointerEvents="none",document.body.appendChild(e)),e}(),s={success:"bg-green-50 dark:bg-green-900/40 border-green-300 dark:border-green-700",error:"bg-red-50 dark:bg-red-900/40 border-red-300 dark:border-red-700",info:"bg-blue-50 dark:bg-blue-900/40 border-blue-300 dark:border-blue-700"},a={success:"text-green-600 dark:text-green-400",error:"text-red-600 dark:text-red-400",info:"text-blue-600 dark:text-blue-400"},i={success:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',error:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>',info:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'},d="success"===n&&o?`<button data-bg-download="${o}" class="mt-2 inline-flex items-center gap-1 text-xs font-semibold text-green-700 dark:text-green-300 hover:underline" style="pointer-events:auto">\n                 <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>\n                 ${window.DOWNLOAD_BUTTON_TEXT||"Download"}\n               </button>`:"",c=document.createElement("div");c.className=`${s[n]||s.info} border rounded-xl p-4 shadow-lg animate-fade-in`,c.style.pointerEvents="auto",c.innerHTML=`\n            <div class="flex items-start gap-3">\n                <svg class="w-5 h-5 flex-shrink-0 mt-0.5 ${a[n]||a.info}" fill="none" stroke="currentColor" viewBox="0 0 24 24">${i[n]||i.info}</svg>\n                <div class="flex-1 min-w-0">\n                    <p class="font-semibold text-sm text-gray-900 dark:text-gray-100">${l(e)}</p>\n                    <p class="text-xs text-gray-600 dark:text-gray-300 truncate">${l(t)}</p>\n                    ${d}\n                </div>\n                <button class="flex-shrink-0 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" data-toast-close>\n                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>\n                </button>\n            </div>\n        `,r.appendChild(c),c.querySelector("[data-toast-close]").addEventListener("click",()=>c.remove());const g=c.querySelector("[data-bg-download]");g&&g.addEventListener("click",()=>u(g.dataset.bgDownload)),setTimeout(()=>{c.parentNode&&(c.style.opacity="0",c.style.transition="opacity 0.3s ease-out",setTimeout(()=>c.remove(),300))},15e3)}function l(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}function c(){const e=document.getElementById("bgTasksBadge"),t=document.getElementById("bgTasksIndicator"),o=document.getElementById("bgTasksDropdown");if(!t)return;const s=n(),a=s.filter(e=>"processing"===e.status),i=(s.filter(e=>"success"===e.status),s.filter(e=>"error"===e.status),s.length);if(0===i)return t.classList.add("hidden"),void(o&&o.classList.add("hidden"));if(t.classList.remove("hidden"),e&&(a.length>0?(e.textContent=a.length,e.classList.remove("hidden")):e.classList.add("hidden")),!o)return;const d=o.querySelector("#bgTasksList");if(!d)return;if(0===i)return void(d.innerHTML=`<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">${window.BG_NO_TASKS_TEXT||"No background tasks"}</p>`);let c="";for(const e of s){const t=l(e.outputFilename||e.originalFilename||"File");"processing"===e.status?c+=`\n                    <div class="flex items-center gap-3 py-2 px-1">\n                        <div class="w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin flex-shrink-0"></div>\n                        <span class="text-sm text-gray-700 dark:text-gray-300 truncate flex-1">${t}</span>\n                    </div>`:"success"===e.status?c+=`\n                    <div class="flex items-center gap-3 py-2 px-1">\n                        <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>\n                        <span class="text-sm text-gray-700 dark:text-gray-300 truncate flex-1">${t}</span>\n                        <button data-bg-download="${e.taskId}" class="text-xs font-semibold text-green-600 dark:text-green-400 hover:underline flex-shrink-0">${window.DOWNLOAD_BUTTON_TEXT||"Download"}</button>\n                        <button data-bg-remove="${e.taskId}" class="text-gray-400 hover:text-red-500 transition-colors flex-shrink-0">\n                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>\n                        </button>\n                    </div>`:"error"===e.status&&(c+=`\n                    <div class="flex items-center gap-3 py-2 px-1">\n                        <svg class="w-4 h-4 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>\n                        <span class="text-sm text-red-600 dark:text-red-400 truncate flex-1" title="${l(e.error)}">${t}</span>\n                        <button data-bg-remove="${e.taskId}" class="text-gray-400 hover:text-red-500 transition-colors flex-shrink-0">\n                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>\n                        </button>\n                    </div>`)}d.innerHTML=c,d.querySelectorAll("[data-bg-download]").forEach(e=>{e.addEventListener("click",()=>u(e.dataset.bgDownload))}),d.querySelectorAll("[data-bg-remove]").forEach(e=>{e.addEventListener("click",()=>{r(e.dataset.bgRemove);const t=document.querySelector("[name=csrfmiddlewaretoken]")?.value||document.querySelector('meta[name="csrf-token"]')?.content||"";fetch(`/api/tasks/${e.dataset.bgRemove}/result/`,{method:"DELETE",headers:{"X-CSRFToken":t}}).catch(()=>{})})})}async function u(e){if(e)try{const t=document.querySelector("[name=csrfmiddlewaretoken]")?.value||document.querySelector('meta[name="csrf-token"]')?.content||"",n=await fetch(`/api/tasks/${e}/result/`,{headers:{"X-CSRFToken":t}});if(!n.ok)return d(window.BG_TASK_ERROR_TEXT||"Download failed","File may have expired","error"),void r(e);const o=await n.blob(),s=n.headers.get("content-disposition");let a="convertica_file";if(s){const e=s.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);e&&e[1]&&(a=e[1].replace(/['"]/g,""))}const i=URL.createObjectURL(o),l=document.createElement("a");l.href=i,l.download=a,document.body.appendChild(l),l.click(),document.body.removeChild(l),setTimeout(()=>URL.revokeObjectURL(i),6e4),r(e),fetch(`/api/tasks/${e}/result/`,{method:"DELETE",headers:{"X-CSRFToken":t}}).catch(()=>{})}catch(e){d(window.BG_TASK_ERROR_TEXT||"Download failed",e.message||"","error")}}function g(){!function(){const e=document.getElementById("bgTasksIndicator"),t=document.getElementById("bgTasksDropdown");e&&t&&(e.addEventListener("click",e=>{e.stopPropagation(),t.classList.contains("hidden")?(t.classList.remove("hidden"),c()):t.classList.add("hidden")}),document.addEventListener("click",n=>{t.contains(n.target)||e.contains(n.target)||t.classList.add("hidden")}))}(),c();n().some(e=>"processing"===e.status)&&s()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",g):g(),window.addBackgroundTask=function(e,t,r){if(!e)return;const a=n();a.some(t=>t.taskId===e)||(a.push({taskId:e,conversionType:t||"",originalFilename:r||"",outputFilename:"",startedAt:Date.now(),status:"processing",error:"",notified:!1}),o(a),window.markTaskAsBackground&&window.markTaskAsBackground(e),d(window.BG_TASK_SENT_TEXT||"Task running in background",r,"info"),c(),s())},window.removeBackgroundTask=r,window.getBackgroundTasks=function(){return n()}}();