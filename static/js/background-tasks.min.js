!function(){"use strict";const e="convertica_bg_tasks";let t=null;function n(){try{return JSON.parse(localStorage.getItem(e))||[]}catch(e){return[]}}function o(t){localStorage.setItem(e,JSON.stringify(t))}function s(e,t=null){if(t)return t;if(window.getTaskToken){const t=window.getTaskToken(e);if(t)return t}const o=n().find(t=>t.taskId===e);return o?.taskToken||null}function r(e){const t=n().filter(t=>t.taskId!==e);o(t),u(),0===t.filter(e=>"processing"===e.status).length&&i()}function a(){t||(t=setInterval(d,5e3),d())}function i(){t&&(clearInterval(t),t=null)}async function d(){let e=n(),t=!1;const r=Date.now(),a=e.length;e=e.filter(e=>r-e.startedAt<3e6||"success"===e.status),e.length!==a&&(t=!0);const d=e.filter(e=>"processing"===e.status);if(0===d.length)return t&&o(e),u(),void i();for(const e of d)try{const n={},o=s(e.taskId,e.taskToken);o&&(n["X-Task-Token"]=o,e.taskToken!==o&&(e.taskToken=o,t=!0));const r=await fetch(`/api/tasks/${e.taskId}/status/`,{headers:n});if(!r.ok)continue;const a=await r.json();"SUCCESS"===a.status?(e.status="success",e.outputFilename=a.output_filename||e.originalFilename,t=!0,e.notified||(e.notified=!0,l(window.BG_TASK_DONE_TEXT||"File is ready!",e.outputFilename,"success",e.taskId))):"FAILURE"!==a.status&&"REVOKED"!==a.status||(e.status="error",e.error=a.error||"Conversion failed",t=!0,e.notified||(e.notified=!0,l(window.BG_TASK_ERROR_TEXT||"Conversion failed",e.error,"error")))}catch(e){}t&&o(e),u()}function l(e,t,n,o){const s=function(){let e=document.getElementById("bgTaskToastContainer");return e||(e=document.createElement("div"),e.id="bgTaskToastContainer",e.className="fixed top-20 right-4 z-[100] flex flex-col gap-3 max-w-sm",e.style.pointerEvents="none",document.body.appendChild(e)),e}(),r={success:"bg-green-50 dark:bg-green-900/40 border-green-300 dark:border-green-700",error:"bg-red-50 dark:bg-red-900/40 border-red-300 dark:border-red-700",info:"bg-blue-50 dark:bg-blue-900/40 border-blue-300 dark:border-blue-700"},a={success:"text-green-600 dark:text-green-400",error:"text-red-600 dark:text-red-400",info:"text-blue-600 dark:text-blue-400"},i={success:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',error:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>',info:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>'},d="success"===n&&o?`<button data-bg-download="${o}" class="mt-2 inline-flex items-center gap-1 text-xs font-semibold text-green-700 dark:text-green-300 hover:underline" style="pointer-events:auto">\n                 <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>\n                 ${window.DOWNLOAD_BUTTON_TEXT||"Download"}\n               </button>`:"",l=document.createElement("div");l.className=`${r[n]||r.info} border rounded-xl p-4 shadow-lg animate-fade-in`,l.style.pointerEvents="auto",l.innerHTML=`\n            <div class="flex items-start gap-3">\n                <svg class="w-5 h-5 flex-shrink-0 mt-0.5 ${a[n]||a.info}" fill="none" stroke="currentColor" viewBox="0 0 24 24">${i[n]||i.info}</svg>\n                <div class="flex-1 min-w-0">\n                    <p class="font-semibold text-sm text-gray-900 dark:text-gray-100">${c(e)}</p>\n                    <p class="text-xs text-gray-600 dark:text-gray-300 truncate">${c(t)}</p>\n                    ${d}\n                </div>\n                <button class="flex-shrink-0 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors" data-toast-close>\n                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>\n                </button>\n            </div>\n        `,s.appendChild(l),l.querySelector("[data-toast-close]").addEventListener("click",()=>l.remove());const u=l.querySelector("[data-bg-download]");u&&u.addEventListener("click",()=>k(u.dataset.bgDownload)),setTimeout(()=>{l.parentNode&&(l.style.opacity="0",l.style.transition="opacity 0.3s ease-out",setTimeout(()=>l.remove(),300))},15e3)}function c(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}function u(){const e=document.getElementById("bgTasksBadge"),t=document.getElementById("bgTasksIndicator"),o=document.getElementById("bgTasksDropdown");if(!t)return;const a=n(),i=a.filter(e=>"processing"===e.status),d=(a.filter(e=>"success"===e.status),a.filter(e=>"error"===e.status),a.length);if(0===d)return t.classList.add("hidden"),void(o&&o.classList.add("hidden"));if(t.classList.remove("hidden"),e&&(i.length>0?(e.textContent=i.length,e.classList.remove("hidden")):e.classList.add("hidden")),!o)return;const l=o.querySelector("#bgTasksList");if(!l)return;if(0===d)return void(l.innerHTML=`<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">${window.BG_NO_TASKS_TEXT||"No background tasks"}</p>`);let u="";for(const e of a){const t=c(e.outputFilename||e.originalFilename||"File");"processing"===e.status?u+=`\n                    <div class="flex items-center gap-3 py-2 px-1">\n                        <div class="w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin flex-shrink-0"></div>\n                        <span class="text-sm text-gray-700 dark:text-gray-300 truncate flex-1">${t}</span>\n                    </div>`:"success"===e.status?u+=`\n                    <div class="flex items-center gap-3 py-2 px-1">\n                        <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>\n                        <span class="text-sm text-gray-700 dark:text-gray-300 truncate flex-1">${t}</span>\n                        <button data-bg-download="${e.taskId}" class="text-xs font-semibold text-green-600 dark:text-green-400 hover:underline flex-shrink-0">${window.DOWNLOAD_BUTTON_TEXT||"Download"}</button>\n                        <button data-bg-remove="${e.taskId}" class="text-gray-400 hover:text-red-500 transition-colors flex-shrink-0">\n                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>\n                        </button>\n                    </div>`:"error"===e.status&&(u+=`\n                    <div class="flex items-center gap-3 py-2 px-1">\n                        <svg class="w-4 h-4 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>\n                        <span class="text-sm text-red-600 dark:text-red-400 truncate flex-1" title="${c(e.error)}">${t}</span>\n                        <button data-bg-remove="${e.taskId}" class="text-gray-400 hover:text-red-500 transition-colors flex-shrink-0">\n                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>\n                        </button>\n                    </div>`)}l.innerHTML=u,l.querySelectorAll("[data-bg-download]").forEach(e=>{e.addEventListener("click",()=>k(e.dataset.bgDownload))}),l.querySelectorAll("[data-bg-remove]").forEach(e=>{e.addEventListener("click",()=>{r(e.dataset.bgRemove);const t={"X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]")?.value||document.querySelector('meta[name="csrf-token"]')?.content||""},n=s(e.dataset.bgRemove);n&&(t["X-Task-Token"]=n),fetch(`/api/tasks/${e.dataset.bgRemove}/result/`,{method:"DELETE",headers:t}).catch(()=>{})})})}async function k(e){if(e)try{const t=document.querySelector("[name=csrfmiddlewaretoken]")?.value||document.querySelector('meta[name="csrf-token"]')?.content||"",n=s(e),o={"X-CSRFToken":t};n&&(o["X-Task-Token"]=n);const a=await fetch(`/api/tasks/${e}/result/`,{headers:o});if(!a.ok)return l(window.BG_TASK_ERROR_TEXT||"Download failed","File may have expired","error"),void r(e);const i=await a.blob(),d=a.headers.get("content-disposition");let c="convertica_file";if(d){const e=d.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);e&&e[1]&&(c=e[1].replace(/['"]/g,""))}const u=URL.createObjectURL(i),k=document.createElement("a");k.href=u,k.download=c,document.body.appendChild(k),k.click(),document.body.removeChild(k),setTimeout(()=>URL.revokeObjectURL(u),6e4),r(e);const g={"X-CSRFToken":t};n&&(g["X-Task-Token"]=n),fetch(`/api/tasks/${e}/result/`,{method:"DELETE",headers:g}).catch(()=>{})}catch(e){l(window.BG_TASK_ERROR_TEXT||"Download failed",e.message||"","error")}}function g(){!function(){const e=document.getElementById("bgTasksIndicator"),t=document.getElementById("bgTasksDropdown");e&&t&&(e.addEventListener("click",e=>{e.stopPropagation(),t.classList.contains("hidden")?(t.classList.remove("hidden"),u()):t.classList.add("hidden")}),document.addEventListener("click",n=>{t.contains(n.target)||e.contains(n.target)||t.classList.add("hidden")}))}(),u();n().some(e=>"processing"===e.status)&&a()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",g):g(),window.addBackgroundTask=function(e,t,r,i=null){if(!e)return;const d=n();d.some(t=>t.taskId===e)||(d.push({taskId:e,conversionType:t||"",originalFilename:r||"",outputFilename:"",taskToken:s(e,i)||"",startedAt:Date.now(),status:"processing",error:"",notified:!1}),o(d),window.markTaskAsBackground&&window.markTaskAsBackground(e),l(window.BG_TASK_SENT_TEXT||"Task running in background",r,"info"),u(),a())},window.removeBackgroundTask=r,window.getBackgroundTasks=function(){return n()}}();