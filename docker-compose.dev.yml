# Development override for docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  web:
    build:
      context: .
      dockerfile: ci/Dockerfile
      target: production  # Use production stage but override command for dev
    entrypoint: []  # Override ENTRYPOINT from Dockerfile
    command:
      - /bin/sh
      - -c
      - |
        if [ ! -L /app/src ] && [ ! -d /app/src ]; then ln -s /app/utils_site/src /app/src; fi &&
        python manage.py collectstatic --noinput &&
        python manage.py migrate &&
        python manage.py runserver 0.0.0.0:8000
    volumes:
      - .:/app  # Mount source code for hot reload
      - ./staticfiles:/app/staticfiles
      - ./media:/app/media
      - ./logs:/app/logs
    environment:
          - DEBUG=True
          - DATABASE_ENGINE=sqlite3  # Use SQLite for development
          - USE_WHITENOISE=True  # Use WhiteNoise in development (simpler than Nginx)
          - EMAIL_BACKEND=${EMAIL_BACKEND:-django.core.mail.backends.console.EmailBackend}
          - EMAIL_HOST=${EMAIL_HOST:-smtp.gmail.com}
          - EMAIL_PORT=${EMAIL_PORT:-587}
          - EMAIL_USE_TLS=${EMAIL_USE_TLS:-True}
          - EMAIL_USE_SSL=${EMAIL_USE_SSL:-False}
          - EMAIL_HOST_USER=${EMAIL_HOST_USER:-}
          - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD:-}
          - DEFAULT_FROM_EMAIL=${DEFAULT_FROM_EMAIL:-noreply@convertica.net}
          - CONTACT_EMAIL=${CONTACT_EMAIL:-info@convertica.net}
          - HCAPTCHA_SITE_KEY=${HCAPTCHA_SITE_KEY:-}
          - HCAPTCHA_SECRET_KEY=${HCAPTCHA_SECRET_KEY:-}
          - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
          - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
    ports:
      - "8000:8000"
      - "5678:5678"  # Debug port

  # Disable Nginx in development (use WhiteNoise instead)
  nginx:
    profiles:
      - production  # Only start with --profile production

  celery:
    volumes:
      - .:/app  # Mount source code for hot reload
    environment:
      - DEBUG=True
      - DATABASE_ENGINE=sqlite3

  celery-beat:
    volumes:
      - .:/app
    environment:
      - DEBUG=True
      - DATABASE_ENGINE=sqlite3
