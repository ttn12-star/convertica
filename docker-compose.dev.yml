# Development override for docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# Resource limits match production server: 2 vCPUs, 4GB RAM
# This helps catch memory/CPU issues before deployment

services:
  db:
    deploy:
      resources:
        limits:
          cpus: '0.5'  # Increased for dev testing
          memory: 512M  # Increased for dev testing
        reservations:
          cpus: '0.2'
          memory: 256M

  redis:
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

  web:
    build:
      context: .
      dockerfile: ci/Dockerfile
      target: production  # Use production stage but override command for dev
    entrypoint: []  # Override ENTRYPOINT from Dockerfile
    command:
      - /bin/sh
      - -c
      - |
        if [ ! -L /app/src ] && [ ! -d /app/src ]; then ln -s /app/utils_site/src /app/src; fi &&
        mkdir -p /app/media/async_temp &&
        python manage.py migrate &&
        python manage.py collectstatic --noinput &&
        python manage.py runserver 0.0.0.0:8003
    volumes:
      - .:/app  # Mount source code for hot reload
      - ./staticfiles:/app/staticfiles
      - ./media:/app/media
      - ./logs:/app/logs
    env_file:
      - .env
    ports:
      - "8003:8003"
    deploy:
      resources:
        limits:
          cpus: '1.5'  # Match production regular worker
          memory: 2.5G  # Match production regular worker
        reservations:
          cpus: '0.75'
          memory: 1.25G

  # Dev Celery Worker - matches production regular worker
  celery:
    build:
      context: .
      dockerfile: ci/Dockerfile
    command: celery -A utils_site worker --loglevel=info --concurrency=1 --pool=solo -Q premium,regular,maintenance,default
    volumes:
      - .:/app  # Mount source code for hot reload
      - ./logs:/app/logs
      - ./media:/app/media
    env_file:
      - .env
    depends_on:
      - db
      - redis
    deploy:
      resources:
        limits:
          cpus: '1.5'  # Match production regular worker
          memory: 2.5G  # Match production regular worker
        reservations:
          cpus: '0.75'
          memory: 1.25G

  # Dev Premium Worker - minimal resources like production
  celery-premium:
    build:
      context: .
      dockerfile: ci/Dockerfile
    command: celery -A utils_site worker --loglevel=info --concurrency=1 --pool=solo -Q premium
    volumes:
      - .:/app  # Mount source code for hot reload
      - ./logs:/app/logs
      - ./media:/app/media
    env_file:
      - .env
    depends_on:
      - db
      - redis
    deploy:
      resources:
        limits:
          cpus: '0.5'  # Match production premium worker
          memory: 1G   # Match production premium worker
        reservations:
          cpus: '0.25'
          memory: 512M

    profiles: ["premium-dev"]


  # Disable Nginx in development (use WhiteNoise instead)
  nginx:
    profiles:
      - production  # Only start with --profile production

  # Celery Beat for development
  celery-beat:
    build:
      context: .
      dockerfile: ci/Dockerfile
    command: >
      sh -c "
      export DJANGO_SETTINGS_MODULE=utils_site.settings &&
      export PYTHONPATH=/app:$PYTHONPATH &&
      celery -A utils_site beat --loglevel=info --schedule=/tmp/celerybeat-schedule
      "
    volumes:
      - .:/app  # Mount source code for hot reload
      - ./logs:/app/logs
      - celerybeat-data:/tmp  # Persist beat schedule
    env_file:
      - .env
    depends_on:
      - db
      - redis
    deploy:
      resources:
        limits:
          cpus: '0.2'  # Increased from 0.1
          memory: 128M  # Increased from 64M
        reservations:
          cpus: '0.1'
          memory: 64M

volumes:
  celerybeat-data:
