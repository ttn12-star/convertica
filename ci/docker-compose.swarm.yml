# Docker Swarm configuration overlay
# Usage: docker stack deploy -c docker-compose.yml -c ci/docker-compose.prod.yml -c ci/docker-compose.swarm.yml convertica
#
# This file adds Swarm-specific features:
# - Rolling updates (zero-downtime deploys)
# - Automatic restart policies
# - Replicas configuration

services:
  nginx:
    # Swarm ignores depends_on, services start based on restart policy
    depends_on: []
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 5s
        failure_action: rollback
        order: start-first
        monitor: 30s
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s

  web:
    # Swarm ignores depends_on, services start based on restart policy
    depends_on: []
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first  # Start new container before stopping old one
        monitor: 60s        # Monitor for 60s before considering update successful
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 3
        window: 120s
      # Resource limits are already in docker-compose.prod.yml

  celery:
    # Swarm ignores depends_on, services start based on restart policy
    depends_on: []
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: stop-first  # For workers, stop old first to avoid duplicate task processing
        monitor: 30s
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 3
        window: 120s

  celery-beat:
    # Swarm ignores depends_on, services start based on restart policy
    depends_on: []
    deploy:
      mode: replicated
      replicas: 1  # Must be 1 - only one beat scheduler allowed
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: stop-first  # Stop old first to avoid duplicate scheduled tasks
        monitor: 30s
      rollback_config:
        parallelism: 1
        delay: 5s
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 3
        window: 120s

  db:
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: stop-first
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
        window: 120s

  redis:
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: stop-first
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 5
        window: 120s

  autoheal:
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: any
        delay: 5s

  docker-monitor:
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: any
        delay: 5s
