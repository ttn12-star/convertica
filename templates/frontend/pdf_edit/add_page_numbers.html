{% extends "frontend/edit_pdf_generic.html" %}
{% load i18n static %}

{% block edit_options %}
  <!-- Preview Section - hidden until file is selected -->
  <div id="pageNumberPreviewSection" class="hidden mb-6">
    <div class="bg-gray-50 rounded-xl p-5 sm:p-6 border border-gray-200">
      <div class="flex items-center justify-between gap-4 mb-4">
        <h3 class="text-lg font-bold text-gray-900">{% trans "Preview Page Numbers" %}</h3>
        <div class="flex items-center gap-2">
          <label for="pageNumberPageSelector" class="text-sm font-semibold text-gray-700">
            {% trans "Select page" %}
          </label>
          <select id="pageNumberPageSelector"
                  class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900 text-sm">
          </select>
        </div>
      </div>

      <div class="relative bg-white border-2 border-gray-300 rounded-lg p-2 sm:p-4 overflow-hidden flex justify-center items-center" style="max-height: 70vh; min-height: 300px;">
        <div class="relative w-full h-full flex justify-center items-center">
          <canvas id="pageNumberCanvas" class="border border-gray-200 shadow-lg max-w-full max-h-full" style="display: block; width: auto; height: auto;"></canvas>
        </div>
      </div>

      <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
        <p class="text-xs text-blue-800">
          {% trans "Preview shows how page numbers will appear on your PDF. Adjust settings below to see real-time changes." %}
        </p>
      </div>
    </div>
  </div>

  <!-- Settings Section - hidden until file is selected -->
  <div id="pageNumberSettingsSection" class="hidden">
    <div class="bg-gray-50 rounded-xl p-5 sm:p-6 border border-gray-200">
      <h3 class="text-lg font-bold mb-4 text-gray-900">{% trans "Page Number Settings" %}</h3>

      <div class="space-y-4">
        <!-- Position -->
        <div>
          <label for="position" class="block text-sm font-semibold text-gray-700 mb-2">
            {% trans "Position" %}
          </label>
          <select id="position" name="position"
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900">
            <option value="bottom-center">{% trans "Bottom Center" %}</option>
            <option value="bottom-left">{% trans "Bottom Left" %}</option>
            <option value="bottom-right">{% trans "Bottom Right" %}</option>
            <option value="top-center">{% trans "Top Center" %}</option>
            <option value="top-left">{% trans "Top Left" %}</option>
            <option value="top-right">{% trans "Top Right" %}</option>
          </select>
        </div>

        <!-- Font Size -->
        <div>
          <label for="font_size" class="block text-sm font-semibold text-gray-700 mb-2">
            {% trans "Font Size" %} (8-72)
          </label>
          <input type="number"
                 id="font_size"
                 name="font_size"
                 value="12"
                 min="8"
                 max="72"
                 class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900">
        </div>

        <!-- Start Number -->
        <div>
          <label for="start_number" class="block text-sm font-semibold text-gray-700 mb-2">
            {% trans "Starting Page Number" %}
          </label>
          <input type="number"
                 id="start_number"
                 name="start_number"
                 value="1"
                 min="1"
                 class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900">
        </div>

        <!-- Custom Format -->
        <div>
          <label for="format_str" class="block text-sm font-semibold text-gray-700 mb-2">
            {% trans "Custom Format" %}
          </label>

        <!-- Quick Format Buttons -->
          <div class="grid grid-cols-2 gap-2 mb-3">
            <button type="button"
                    class="format-preset px-3 py-2 text-xs bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-300 rounded-lg transition-colors"
                    data-format="{page}">
              {% trans "Simple" %}<br>
              <span class="text-gray-500">1, 2, 3...</span>
            </button>
            <button type="button"
                    class="format-preset px-3 py-2 text-xs bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-300 rounded-lg transition-colors"
                    data-format="Page {page}">
              {% trans "With text" %}<br>
              <span class="text-gray-500">Page 1, Page 2...</span>
            </button>
            <button type="button"
                    class="format-preset px-3 py-2 text-xs bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-300 rounded-lg transition-colors"
                    data-format="{page} of {total}">
              {% trans "With total" %}<br>
              <span class="text-gray-500">1 of 10, 2 of 10...</span>
            </button>
            <button type="button"
                    class="format-preset px-3 py-2 text-xs bg-gray-100 hover:bg-blue-100 border border-gray-300 hover:border-blue-300 rounded-lg transition-colors"
                    data-format="({page})">
              {% trans "In brackets" %}<br>
              <span class="text-gray-500">(1), (2), (3)...</span>
            </button>
          </div>

          <input type="text"
                 id="format_str"
                 name="format_str"
                 value="{page}"
                 placeholder="e.g., {page}, Page {page} of {total}"
                 class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900">
          <p class="mt-1.5 text-xs text-gray-500">
            {% trans "Use {page} for page number, {total} for total pages. Click presets above or enter custom format." %}
          </p>
        </div>

        <!-- Pages to Add Numbers -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-3">
            {% trans "Apply to pages" %}
          </label>
          <div class="space-y-3">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="radio"
                     name="pagesOption"
                     id="pageNumbersPagesAll"
                     value="all"
                     checked
                     class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
              <span class="text-sm text-gray-700">{% trans "All pages" %}</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="radio"
                     name="pagesOption"
                     id="pageNumbersPagesCurrent"
                     value="current"
                     class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
              <span class="text-sm text-gray-700">{% trans "Current page only" %}</span>
            </label>
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="radio"
                     name="pagesOption"
                     id="pageNumbersPagesCustom"
                     value="custom"
                     class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
              <span class="text-sm text-gray-700">{% trans "Custom pages:" %}</span>
            </label>
            <input type="text"
                   id="pageNumbersPagesCustomInput"
                   name="pagesCustom"
                   placeholder="1,3,5 or 1-5"
                   disabled
                   class="ml-6 w-full sm:w-auto min-w-[200px] px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed"
                   pattern="^[\d,\- ]+$">
            <p class="ml-6 text-xs text-gray-500">
              {% trans "Enter specific pages like '1,3,5' or '1-5'" %}
            </p>
          </div>
          <input type="hidden" id="pages" name="pages" value="all">
        </div>
      </div>
    </div>
  </div>
{% endblock %}

<!-- Preview Section - placed after edit_options -->
<div id="pageNumberPreviewSection" class="hidden mb-6">
  <div class="bg-gray-50 rounded-xl p-5 sm:p-6 border border-gray-200">
    <div class="flex items-center justify-between gap-4 mb-4">
      <h3 class="text-lg font-bold text-gray-900">{% trans "Preview Page Numbers" %}</h3>
      <div class="flex items-center gap-2">
        <label for="pageNumberPageSelector" class="text-sm font-semibold text-gray-700">
          {% trans "Select page" %}
        </label>
        <select id="pageNumberPageSelector"
                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900 text-sm">
        </select>
      </div>
    </div>

    <div class="relative bg-white border-2 border-gray-300 rounded-lg p-4 overflow-hidden flex justify-center items-center" style="max-height: 85vh; min-height: 400px;">
      <div class="relative inline-block" style="max-width: 100%; max-height: 100%;">
        <canvas id="pageNumberCanvas" class="border border-gray-200 shadow-lg" style="max-width: 100%; max-height: 100%; display: block;"></canvas>
      </div>
    </div>

    <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
      <p class="text-xs text-blue-800">
        {% trans "Preview shows how page numbers will appear on your PDF. Adjust settings below to see real-time changes." %}
      </p>
    </div>
  </div>
</div>

{% block help_section %}
  <div class="mt-8 sm:mt-10 bg-gradient-to-br from-blue-50 to-purple-50 border border-blue-200 rounded-xl p-5 sm:p-7" style="font-family: 'Inter', 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
    <h2 class="text-lg sm:text-xl font-bold mb-4 text-gray-900" style="font-family: 'Poppins', sans-serif; font-weight: 700; letter-spacing: -0.02em;">
      {% trans "How it works" %}
    </h2>
    <ol class="list-decimal list-inside space-y-2.5 text-sm sm:text-base text-gray-700" style="font-family: 'Inter', sans-serif; font-weight: 500; line-height: 1.7;">
      <li>{% trans "Select your PDF file using the button above or drag and drop it into the zone below" %}</li>
      <li>{% trans "Choose the position, font size, starting number, and format for adding page numbers to PDF" %}</li>
      <li>{% trans "Preview how the page numbers will look on your PDF using the live preview" %}</li>
      <li>{% trans "Select which pages to add numbers to: all pages, current page only, or specific pages" %}</li>
      <li>{% trans "Click the add page numbers button to process your PDF and add page numbers" %}</li>
      <li>{% trans "Download your PDF file with page numbers added using the download button" %}</li>
    </ol>
    <div class="mt-4 pt-4 border-t border-blue-200">
      <p class="text-xs sm:text-sm text-gray-600">
        <strong>{% trans "Note:" %}</strong> {% blocktrans with max_pages=conversion_limits.max_free_pdf_pages %}PDF files with up to {{ max_pages }} pages are supported for adding page numbers. For larger files, please split them into smaller parts. The page numbers will be added according to your selected position, format, and font size.{% endblocktrans %}
      </p>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- Load PDF.js before other scripts -->
  <script
    id="pdfjs-pagenumbers-script"
    src="{% static 'vendor/pdfjs/3.11.174/pdf.min.js' %}"
    crossorigin="anonymous"
    nonce="{{ csp_nonce }}">
  </script>
  <script nonce="{{ csp_nonce }}">
    (function() {
      var script = document.getElementById('pdfjs-pagenumbers-script');
      if (script) {
        script.addEventListener('error', function() {
          var fallback = document.createElement('script');
          fallback.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
          fallback.crossOrigin = 'anonymous';
          document.head.appendChild(fallback);
        });
      }
    })();
  </script>
  <script nonce="{{ csp_nonce }}">
    window.API_URL = "{{ api_url|escapejs }}";
    window.CSRF_TOKEN = "{{ csrf_token }}";
    window.SELECT_FILE_MESSAGE = "{{ select_file_message|escapejs }}";
    window.FILE_INPUT_NAME = "{{ file_input_name|escapejs }}";
    window.REPLACE_REGEX = "{{ replace_regex|escapejs }}";
    window.REPLACE_TO = "{{ replace_to|escapejs }}";
    window.ERROR_MESSAGE = "{{ error_message|default:'Editing failed. Please try again.'|escapejs }}";
    window.PDFJS_LOCAL_PDF = "{% static 'vendor/pdfjs/3.11.174/pdf.min.js' %}";
    window.PDFJS_LOCAL_WORKER = "{% static 'vendor/pdfjs/3.11.174/pdf.worker.min.js' %}";
    window.LOADING_TITLE = "{% filter escapejs %}{% trans 'Processing your file...' %}{% endfilter %}";
    window.LOADING_MESSAGE = "{% filter escapejs %}{% trans 'Please wait, this may take a few moments' %}{% endfilter %}";
    window.SUCCESS_TITLE = "{% filter escapejs %}{% trans 'Editing Complete!' %}{% endfilter %}";
    window.SUCCESS_MESSAGE = "{% filter escapejs %}{% trans 'Your file is ready to download' %}{% endfilter %}";
    window.DOWNLOAD_BUTTON_TEXT = "{% filter escapejs %}{% trans 'Download File' %}{% endfilter %}";
    window.EDIT_ANOTHER_TEXT = "{% filter escapejs %}{% trans 'Edit another file' %}{% endfilter %}";
    window.ERROR_TITLE = "{% filter escapejs %}{% trans 'Error' %}{% endfilter %}";
    window.MAX_FREE_PDF_PAGES = {{ conversion_limits.max_free_pdf_pages }};
    {% if PAYMENTS_ENABLED %}
      window.PAGE_LIMIT_ERROR = "{% filter escapejs %}{% trans 'PDF has %(page_count)d pages (limit: %(max_pages)d). You can split your file into smaller parts or get a 1-day Premium subscription for just $1 to process larger files with much higher limits!' %}{% endfilter %}";
      window.PREMIUM_LINK = "{% if user.is_authenticated %}{% url 'frontend:pricing' %}{% else %}{% url 'users:login' %}?next={% url 'frontend:pricing' %}{% endif %}";
    {% else %}
      window.PAGE_LIMIT_ERROR = "{% filter escapejs %}{% trans 'PDF has %(page_count)d pages (limit: %(max_pages)d). Please split your file into smaller parts.' %}{% endfilter %}";
      window.PREMIUM_LINK = "";
    {% endif %}
    /* eslint-disable */
    window.IS_PREMIUM = "{{ is_premium|yesno:'true,false'|escapejs }}" === "true";
    /* eslint-enable */
    window.PATIENCE_TITLE = "{% filter escapejs %}{% trans 'Everything is going well!' %}{% endfilter %}";
    window.PATIENCE_MESSAGE = "{% filter escapejs %}{% trans 'Large files take a bit longer. Please do not close this page â€” your file is being processed.' %}{% endfilter %}";
  </script>
  <script src="{% static 'js/utils.js' %}" nonce="{{ csp_nonce }}"></script>
  <script src="{% static 'js/task-cancellation.js' %}" nonce="{{ csp_nonce }}"></script>
  <script src="{% static 'js/file-input-handler.js' %}" nonce="{{ csp_nonce }}"></script>
  <script src="{% static 'js/pdf-editor.js' %}" nonce="{{ csp_nonce }}"></script>
  <script src="{% static 'js/page-number-preview.js' %}" nonce="{{ csp_nonce }}"></script>
{% endblock %}
