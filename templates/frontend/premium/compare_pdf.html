{% extends "base.html" %}
{% load i18n static minified_static %}

{% block title %}{{ page_title }}{% endblock %}
{% block meta_title %}{{ page_title }}{% endblock %}
{% block description %}{{ page_description }}{% endblock %}
{% block keywords %}{{ page_keywords|default:"compare pdf files, pdf diff tool, visual pdf comparison" }}{% endblock %}
{% block og_title %}{{ page_title }}{% endblock %}
{% block og_description %}{{ page_description }}{% endblock %}
{% block twitter_title %}{{ page_title }}{% endblock %}
{% block twitter_description %}{{ page_description }}{% endblock %}

{% block structured_data %}
  {{ block.super }}
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "{{ header_text|default:page_title }}",
      "description": "{{ page_description }}",
      "url": "{{ site_current_url }}",
      "applicationCategory": "UtilityApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "6",
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock"
      },
      "inLanguage": "{{ LANGUAGE_CODE }}"
    }
  </script>
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "HowTo",
      "name": "{{ header_text|default:page_title }}",
      "description": "{{ page_description }}",
      "step": [
        {
          "@type": "HowToStep",
          "position": 1,
          "name": "{% filter escapejs %}{% trans 'Upload two PDF files' %}{% endfilter %}",
          "text": "{% filter escapejs %}{% trans 'Select the base PDF and the comparison PDF.' %}{% endfilter %}"
        },
        {
          "@type": "HowToStep",
          "position": 2,
          "name": "{% filter escapejs %}{% trans 'Set sensitivity' %}{% endfilter %}",
          "text": "{% filter escapejs %}{% trans 'Adjust diff sensitivity to control change detection strictness.' %}{% endfilter %}"
        },
        {
          "@type": "HowToStep",
          "position": 3,
          "name": "{% filter escapejs %}{% trans 'Review and export' %}{% endfilter %}",
          "text": "{% filter escapejs %}{% trans 'Review changes page-by-page. Export report files only if you need to share or archive them.' %}{% endfilter %}"
        }
      ],
      "totalTime": "PT2M"
    }
  </script>
  {% if page_faq %}
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
          {% for item in page_faq %}
            {
              "@type": "Question",
              "name": "{{ item.question|escapejs }}",
              "acceptedAnswer": {
                "@type": "Answer",
                "text": "{{ item.answer|striptags|escapejs }}"
              }
            }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ]
      }
    </script>
  {% endif %}
{% endblock %}

{% block content %}
  <div class="max-w-4xl mx-auto my-6 sm:my-8 lg:my-12 px-4 sm:px-6 text-gray-900">
    {% include "frontend/includes/breadcrumbs.html" %}

    <div class="text-center mb-8 sm:mb-10 pt-4 sm:pt-0">
      <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-3 sm:mb-4 text-gray-900">{{ header_text }}</h1>
      <p class="text-sm sm:text-base text-gray-600 max-w-2xl mx-auto">{{ page_subtitle }}</p>
    </div>

    <form id="compareForm"
          method="post"
          enctype="multipart/form-data"
          class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 lg:p-10 border border-gray-200 text-gray-900">
      {% csrf_token %}

      <div class="mb-6 p-4 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-lg">
        <h2 class="text-sm font-semibold text-amber-800 mb-1">{% trans "Premium Feature" %}</h2>
        <p class="text-xs text-amber-700">
          {% trans "Review page-by-page differences in your browser. Export Markdown/JSON and images only if needed." %}
        </p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 mb-6">
        <div>
          <label for="pdfFile1" class="block text-sm font-semibold text-gray-700 mb-2">
            {% trans "Base PDF" %}
          </label>
          <input id="pdfFile1"
                 type="file"
                 name="pdf_file_1"
                 accept=".pdf,application/pdf"
                 required
                 class="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm file:mr-3 file:rounded-md file:border-0 file:bg-amber-600 file:px-3 file:py-1.5 file:text-xs file:font-semibold file:text-white hover:file:bg-amber-700">
        </div>
        <div>
          <label for="pdfFile2" class="block text-sm font-semibold text-gray-700 mb-2">
            {% trans "Compare PDF" %}
          </label>
          <input id="pdfFile2"
                 type="file"
                 name="pdf_file_2"
                 accept=".pdf,application/pdf"
                 required
                 class="block w-full rounded-lg border border-gray-300 px-3 py-2 text-sm file:mr-3 file:rounded-md file:border-0 file:bg-amber-600 file:px-3 file:py-1.5 file:text-xs file:font-semibold file:text-white hover:file:bg-amber-700">
        </div>
      </div>

      <div class="mb-8">
        <div class="flex items-center justify-between mb-2">
          <label for="diffThreshold" class="text-sm font-semibold text-gray-700">
            {% trans "Diff Sensitivity" %}
          </label>
          <span id="diffThresholdValue" class="text-sm font-semibold text-amber-700">32</span>
        </div>
        <input id="diffThreshold"
               type="range"
               name="diff_threshold"
               min="5"
               max="80"
               value="32"
               class="w-full accent-amber-600">
        <p class="text-xs text-gray-500 mt-2">
          {% trans "Lower value catches smaller visual changes. Higher value highlights only major differences." %}
        </p>
      </div>

      <div class="text-center">
        <button type="submit"
                id="compareButton"
                class="inline-block px-12 sm:px-16 py-3.5 sm:py-4 font-bold text-lg sm:text-xl rounded-2xl shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 active:scale-95 bg-amber-600 text-white hover:bg-amber-700">
          <span class="flex items-center justify-center space-x-3">
            <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9H6a2 2 0 00-2 2v7a2 2 0 002 2h4m4-11h4a2 2 0 012 2v7a2 2 0 01-2 2h-4m-4-11v11m0 0l-2-2m2 2l2-2"></path>
            </svg>
            <span>{% trans "Compare PDFs" %}</span>
          </span>
        </button>
      </div>
    </form>

    <div id="loadingContainer" class="hidden mt-6"></div>
    <div id="downloadContainer" class="hidden mt-6"></div>
    <div id="converterResult" class="hidden mt-6"></div>
    <div id="comparisonPreview" class="hidden mt-8 sm:mt-10">
      <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
        <div class="px-5 sm:px-7 py-5 border-b border-gray-200 bg-gradient-to-r from-amber-50 to-orange-50">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
              <h2 class="text-xl sm:text-2xl font-bold text-gray-900">
                {% trans "Comparison Report" %}
              </h2>
              <p id="compareSummaryGeneratedAt" class="text-sm text-gray-600 mt-1"></p>
            </div>
            <button id="compareDownloadButton"
                    type="button"
                    class="inline-flex items-center justify-center px-5 py-2.5 rounded-xl bg-amber-600 text-white font-semibold hover:bg-amber-700 transition-colors focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2">
              {% trans "Export Report" %}
            </button>
          </div>
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mt-5">
            <div class="rounded-xl border border-amber-200 bg-white p-3">
              <p class="text-xs uppercase tracking-wide text-gray-500">{% trans "Pages" %}</p>
              <p id="compareSummaryPages" class="text-lg font-bold text-gray-900 mt-1">0</p>
            </div>
            <div class="rounded-xl border border-amber-200 bg-white p-3">
              <p class="text-xs uppercase tracking-wide text-gray-500">{% trans "Overall change" %}</p>
              <p id="compareSummaryChange" class="text-lg font-bold text-amber-700 mt-1">0%</p>
            </div>
            <div class="rounded-xl border border-amber-200 bg-white p-3">
              <p class="text-xs uppercase tracking-wide text-gray-500">{% trans "Words added" %}</p>
              <p id="compareSummaryWordsAdded" class="text-lg font-bold text-emerald-700 mt-1">0</p>
            </div>
            <div class="rounded-xl border border-amber-200 bg-white p-3">
              <p class="text-xs uppercase tracking-wide text-gray-500">{% trans "Words removed" %}</p>
              <p id="compareSummaryWordsRemoved" class="text-lg font-bold text-rose-700 mt-1">0</p>
            </div>
          </div>
        </div>

        <div class="p-5 sm:p-7">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="flex items-center gap-2">
              <button id="comparePrevButton"
                      type="button"
                      class="px-3 py-2 rounded-lg border border-gray-300 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-colors">
                {% trans "Previous" %}
              </button>
              <span id="comparePageIndicator" class="text-sm font-semibold text-gray-700">{% trans "Page 1 of 1" %}</span>
              <button id="compareNextButton"
                      type="button"
                      class="px-3 py-2 rounded-lg border border-gray-300 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-colors">
                {% trans "Next" %}
              </button>
            </div>
            <div id="compareViewSwitch" class="inline-flex flex-wrap rounded-xl bg-gray-100 p-1 gap-1">
              <button type="button"
                      data-view="diff"
                      class="compare-view-btn px-3 py-1.5 rounded-lg text-sm font-semibold bg-white text-amber-700 shadow-sm">
                {% trans "Diff overlay" %}
              </button>
              <button type="button"
                      data-view="base"
                      class="compare-view-btn px-3 py-1.5 rounded-lg text-sm font-semibold text-gray-700 hover:bg-white">
                {% trans "Base" %}
              </button>
              <button type="button"
                      data-view="compare"
                      class="compare-view-btn px-3 py-1.5 rounded-lg text-sm font-semibold text-gray-700 hover:bg-white">
                {% trans "Updated" %}
              </button>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 xl:grid-cols-12 gap-5">
            <div class="xl:col-span-8">
              <div id="compareMainViewport"
                   class="rounded-xl border border-gray-200 bg-gray-50 p-3 min-h-[320px] flex items-center justify-center relative overflow-hidden">
                <div id="compareMainLoading"
                     class="hidden absolute inset-0 bg-white/70 backdrop-blur-[1px] items-center justify-center text-sm font-semibold text-gray-600">
                  {% trans "Loading page preview..." %}
                </div>
                <img id="compareMainImage"
                     alt="{% trans 'PDF page comparison preview' %}"
                     class="hidden max-h-[72vh] w-auto rounded-md shadow-md border border-gray-200 bg-white">
                <p id="compareMainEmpty" class="text-sm text-gray-500 text-center px-6">
                  {% trans "Run comparison to preview page-by-page differences." %}
                </p>
              </div>
              <div id="comparePageMeta"
                   class="mt-3 rounded-xl border border-gray-200 bg-white p-3 text-sm text-gray-700"></div>
            </div>

            <div class="xl:col-span-4">
              <h3 class="text-sm font-bold text-gray-900 mb-2">{% trans "Pages overview" %}</h3>
              <div id="comparePageList"
                   class="max-h-[520px] overflow-auto rounded-xl border border-gray-200 divide-y divide-gray-100 bg-white"></div>
            </div>
          </div>

          <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="rounded-xl border border-gray-200 p-3 bg-white">
              <h3 class="text-sm font-semibold text-gray-800 mb-2">{% trans "Base page" %}</h3>
              <img id="compareBaseImage"
                   alt="{% trans 'Base PDF page' %}"
                   class="w-full rounded-md border border-gray-200 bg-gray-50">
            </div>
            <div class="rounded-xl border border-gray-200 p-3 bg-white">
              <h3 class="text-sm font-semibold text-gray-800 mb-2">{% trans "Updated page" %}</h3>
              <img id="compareUpdatedImage"
                   alt="{% trans 'Updated PDF page' %}"
                   class="w-full rounded-md border border-gray-200 bg-gray-50">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-8 sm:mt-10 bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-5 sm:p-7">
      <h2 class="text-lg sm:text-xl font-bold mb-4 text-gray-900">
        {% trans "How Compare Two PDFs works" %}
      </h2>
      <ol class="list-decimal list-inside space-y-2.5 text-sm sm:text-base text-gray-700 leading-relaxed">
        <li>{% trans "Upload the original PDF and the updated PDF version." %}</li>
        <li>{% trans "Adjust diff sensitivity to match your review needs." %}</li>
        <li>{% trans "Run comparison, review page-by-page changes on screen, and download ZIP reports if needed." %}</li>
      </ol>
      <p class="text-xs sm:text-sm text-gray-600 mt-4">
        {% trans "Tip: Keep page sizes and orientation consistent for clearer visual diff output." %}
      </p>
    </div>

    {% include "frontend/includes/seo_content.html" with content_title=page_content_title content_body=page_content_body %}
    {% include "frontend/includes/seo_benefits.html" with benefits=page_benefits benefits_title=benefits_title %}
    {% include "frontend/includes/seo_tips.html" with tips=page_tips tips_title=tips_title %}
    {% include "frontend/includes/seo_faq.html" with faq=page_faq faq_title=faq_title %}

    {% if related_tools %}
      {% include "frontend/includes/related_tools.html" with tools=related_tools %}
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
  <script nonce="{{ csp_nonce }}">
    window.COMPARE_API_URL = "{{ api_url|escapejs }}";
    window.CSRF_TOKEN = "{{ csrf_token }}";
    window.COMPARE_ERROR_MESSAGE = "{% filter escapejs %}{% trans 'Comparison failed. Please try again.' %}{% endfilter %}";
    window.COMPARE_FILE_MESSAGE = "{% filter escapejs %}{% trans 'Please select two PDF files.' %}{% endfilter %}";
    window.COMPARE_ARCHIVE_ERROR_MESSAGE = "{% filter escapejs %}{% trans 'Could not read comparison archive. Please try again.' %}{% endfilter %}";
    window.COMPARE_REPORT_MISSING_MESSAGE = "{% filter escapejs %}{% trans 'Comparison report is incomplete. Please run the comparison again.' %}{% endfilter %}";
    window.COMPARE_NO_PAGES_MESSAGE = "{% filter escapejs %}{% trans 'No pages found in comparison report.' %}{% endfilter %}";
    window.COMPARE_STATUS_PRESENT = "{% filter escapejs %}{% trans 'Compared' %}{% endfilter %}";
    window.COMPARE_STATUS_ADDED = "{% filter escapejs %}{% trans 'Added in updated PDF' %}{% endfilter %}";
    window.COMPARE_STATUS_MISSING = "{% filter escapejs %}{% trans 'Missing in updated PDF' %}{% endfilter %}";
    window.COMPARE_STATUS_UNKNOWN = "{% filter escapejs %}{% trans 'Status unknown' %}{% endfilter %}";
    window.COMPARE_PAGE_TEXT = "{% filter escapejs %}{% trans 'Page' %}{% endfilter %}";
    window.COMPARE_OF_TEXT = "{% filter escapejs %}{% trans 'of' %}{% endfilter %}";
    window.COMPARE_CHANGED_PIXELS_TEXT = "{% filter escapejs %}{% trans 'Changed pixels' %}{% endfilter %}";
    window.COMPARE_TOTAL_PIXELS_TEXT = "{% filter escapejs %}{% trans 'Total pixels' %}{% endfilter %}";
    window.COMPARE_VISUAL_CHANGE_TEXT = "{% filter escapejs %}{% trans 'Visual change' %}{% endfilter %}";
    window.COMPARE_WORDS_ADDED_TEXT = "{% filter escapejs %}{% trans 'Words added' %}{% endfilter %}";
    window.COMPARE_WORDS_REMOVED_TEXT = "{% filter escapejs %}{% trans 'Words removed' %}{% endfilter %}";
    window.COMPARE_TEXT_SIMILARITY_TEXT = "{% filter escapejs %}{% trans 'Text similarity' %}{% endfilter %}";
    window.COMPARE_DOWNLOAD_REPORT_TEXT = "{% filter escapejs %}{% trans 'Export Report' %}{% endfilter %}";
    window.COMPARE_DOWNLOAD_IN_PROGRESS_TEXT = "{% filter escapejs %}{% trans 'Preparing report export...' %}{% endfilter %}";
    window.COMPARE_DOWNLOAD_FAILED_TEXT = "{% filter escapejs %}{% trans 'Failed to export report.' %}{% endfilter %}";
    window.COMPARE_LOADING_PAGE_TEXT = "{% filter escapejs %}{% trans 'Loading page preview...' %}{% endfilter %}";
  </script>
  <script src="{% minified_static 'js/utils.js' %}" nonce="{{ csp_nonce }}"></script>
  <script src="{% static 'vendor/jszip/3.10.1/jszip.min.js' %}" nonce="{{ csp_nonce }}"></script>
  <script src="{% minified_static 'js/pdf-compare.js' %}" nonce="{{ csp_nonce }}"></script>
{% endblock %}
