{% load static %}
{% load i18n %}
{% load minified_static %}
<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
{% get_current_language_bidi as LANGUAGE_BIDI %}
<html lang="{{ LANGUAGE_CODE }}" dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}" data-is-premium="{% if user.is_authenticated and user.is_premium_active %}true{% else %}false{% endif %}" class="scroll-smooth">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Primary Meta Tags -->
    <title>{% block title %}Convertica – Online PDF ↔ Word Converter{% endblock %}</title>
    <meta name="title" content="{% block meta_title %}{{ page_title|default:_('Convertica – Online PDF ↔ Word Converter') }}{% endblock %}">
    <meta name="description" content="{% block description %}{% trans "Fast, simple and secure online PDF to Word and Word to PDF converter. No installations required." %}{% endblock %}">
    <meta name="keywords" content="{% block keywords %}{% trans "PDF to Word, Word to PDF, PDF converter, DOCX converter, online converter, free converter" %}{% endblock %}">
    <meta name="author" content="Convertica">
    <meta name="robots" content="{% block robots %}index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1{% endblock %}">
    <meta name="language" content="{{ LANGUAGE_CODE }}">
    <meta name="revisit-after" content="7 days">
    <meta name="theme-color" content="#2563eb">
    <meta name="format-detection" content="telephone=no">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ site_current_url }}">
    <meta property="og:title" content="{% block og_title %}{{ page_title|default:_('Convertica – Online PDF ↔ Word Converter') }}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{{ page_description|default:_('Fast, simple and secure online PDF to Word and Word to PDF converter. No installations required.') }}{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{{ site_base_url }}{% static 'images/og-image.jpg' %}{% endblock %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="{% block og_image_alt %}Convertica - Online PDF Tools{% endblock %}">
    <meta property="og:locale" content="{% if LANGUAGE_CODE == 'ru' %}ru_RU{% elif LANGUAGE_CODE == 'pl' %}pl_PL{% elif LANGUAGE_CODE == 'hi' %}hi_IN{% elif LANGUAGE_CODE == 'es' %}es_ES{% elif LANGUAGE_CODE == 'id' %}id_ID{% else %}en_US{% endif %}">
    <meta property="og:site_name" content="Convertica">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ site_current_url }}">
    <meta property="twitter:title" content="{% block twitter_title %}{{ page_title|default:_('Convertica – Online PDF ↔ Word Converter') }}{% endblock %}">
    <meta property="twitter:description" content="{% block twitter_description %}{{ page_description|default:_('Fast, simple and secure online PDF to Word and Word to PDF converter. No installations required.') }}{% endblock %}">
    <meta property="twitter:image" content="{% block twitter_image %}{{ site_base_url }}{% static 'images/og-image.jpg' %}{% endblock %}">

    <!-- Canonical URL (without query parameters) -->
    {% with default_home='/'|add:default_language_code|add:'/' %}
      {% if request.path == '/' or request.path == default_home %}
          <!-- For root homepage and default-language homepage, canonical points to root -->
        <link rel="canonical" href="{{ site_base_url }}/">
      {% else %}
          <!-- For all other pages, canonical points to current URL without query parameters -->
        <link rel="canonical" href="{{ site_base_url }}{{ request.path }}">
      {% endif %}
    {% endwith %}

    <!-- Prevent indexing of pages with lang parameter (duplicates) -->
    {% if request.GET.lang %}
      <meta name="robots" content="noindex, follow">
    {% endif %}
    <!-- Preconnect to external domains (for analytics and CDN) -->
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://challenges.cloudflare.com">
    <link rel="preconnect" href="https://challenges.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://mc.yandex.ru">
    <link rel="preconnect" href="https://mc.yandex.ru" crossorigin>
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.google-analytics.com">
    <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>

    <!-- Critical resources preload -->
    <link rel="preload" href="{% static 'css/tailwind.css' %}" as="style">
    <link rel="preload" href="{% static 'js/utils.js' %}" as="script">

    <!-- Self-hosted fonts (300ms faster than Google Fonts CDN) -->
    <!-- Preload critical fonts for better FCP -->
    <link rel="preload" href="{% static 'fonts/inter/inter-v13-latin_cyrillic-regular.woff2' %}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="{% static 'fonts/inter/inter-v13-latin_cyrillic-600.woff2' %}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="{% static 'fonts/poppins/poppins-v20-latin-regular.woff2' %}" as="font" type="font/woff2" crossorigin>
    <!-- Load fonts CSS asynchronously (non-blocking) -->
    <link rel="stylesheet" href="{% static 'css/fonts.css' %}" media="print" onload="this.media='all';this.onload=null">
    <noscript><link rel="stylesheet" href="{% static 'css/fonts.css' %}"></noscript>

    <!-- Google Fonts (DISABLED - using self-hosted for better performance) -->
    <!--
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"></noscript>
    -->

    <!-- Hreflang -->
    {% for link in hreflangs %}
      <link rel="alternate" hreflang="{{ link.code }}" href="{{ link.url }}">
    {% endfor %}

    <!-- Favicon -->
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'favicon-16x16.png' %}">
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'favicon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'favicon-192x192.png' %}">
    <link rel="manifest" href="{% static 'site.webmanifest' %}">
    <meta name="application-name" content="Convertica">
    <meta name="apple-mobile-web-app-title" content="Convertica">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <script>
      (function() {
        try {
          var html = document.documentElement;
          var isPremium = html && html.dataset && html.dataset.isPremium === 'true';
          if (!isPremium) {
            html.classList.remove('dark');
            return;
          }
          var storedTheme = localStorage.getItem('convertica_theme');
          if (storedTheme === 'dark') {
            html.classList.add('dark');
            // Add dark-mode class to body as soon as it's available
            // This runs synchronously in <head>, so body doesn't exist yet
            // We'll add it via a tiny script right after <body> tag
            window.__darkModeEnabled = true;
          } else {
            html.classList.remove('dark');
            window.__darkModeEnabled = false;
          }
        } catch (e) {
        }
      })();
    </script>

    <!-- Critical CSS - Inline for instant rendering without FOUC -->
    <style>{% include "frontend/includes/critical.css" %}</style>

    <!-- Preload full stylesheets for faster loading -->
    <link rel="preload" href="{% static 'css/tailwind.css' %}" as="style">
    <link rel="preload" href="{% static 'css/dark-mode-helpers.css' %}" as="style">
    <link rel="preload" href="{% static 'css/mobile-optimizations.css' %}" as="style">

    <!-- Load full stylesheets asynchronously with fallback (non-blocking) -->
    <link rel="stylesheet" href="{% static 'css/tailwind.css' %}" media="print" onload="this.media='all';document.documentElement.classList.add('css-loaded');this.onload=null">
    <noscript><link rel="stylesheet" href="{% static 'css/tailwind.css' %}"></noscript>

    <link rel="stylesheet" href="{% static 'css/dark-mode-helpers.css' %}" media="print" onload="this.media='all';this.onload=null">
    <noscript><link rel="stylesheet" href="{% static 'css/dark-mode-helpers.css' %}"></noscript>

    <link rel="stylesheet" href="{% static 'css/mobile-optimizations.css' %}" media="print" onload="this.media='all';this.onload=null">
    <noscript><link rel="stylesheet" href="{% static 'css/mobile-optimizations.css' %}"></noscript>

    <!-- Custom Animations -->
    <style>
      @keyframes progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes scaleIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
      @keyframes ping {75%,100%{transform:scale(2);opacity:0;}}

      .animate-progress { animation: progress 2s linear infinite; background-size: 200% 100%; }
      .animate-fade-in { animation: fadeIn 0.5s ease-out; }
      .animate-scale-in { animation: scaleIn 0.3s ease-out; }
      .shadow-3xl { box-shadow: 0 35px 60px -12px rgba(0, 0, 0, 0.25); }

      html, body { overflow-x: hidden; max-width: 100%; width: 100%; }

      /* Smooth transitions for theme switching */
      html {
        transition: background-color 0.2s ease;
      }

      body {
        transition: background-color 0.2s ease, color 0.2s ease;
      }

      body { color: #111827; background-color: #ffffff; }
      html.dark body { color: #f3f4f6; background-color: #111827; }

      p, span, div, h1, h2, h3, h4, h5, h6, a, li, label, button, input, select, textarea { color: inherit; }

      img, video, iframe, embed, object { max-width: 100%; height: auto; }

      @media (max-width: 640px) { .absolute { max-width: calc(100vw - 1rem); } }
    </style>

    <!-- Structured Data -->
    {% block structured_data %}
      <!-- BreadcrumbList Schema -->
      {% if breadcrumbs_schema %}
        <script type="application/ld+json">
          {
            "@context": "https://schema.org",
            "@type": "BreadcrumbList",
            "itemListElement": [
              {% for breadcrumb in breadcrumbs_schema %}
                {
                  "@type": "ListItem",
                  "position": {{ forloop.counter }},
                  "name": "{{ breadcrumb.name|escapejs }}",
                  "item": "{{ site_base_url }}{{ breadcrumb.url }}"
                }{% if not forloop.last %},{% endif %}
              {% endfor %}
            ]
          }
        </script>
      {% endif %}
    {% endblock %}
    <!-- Cloudflare Turnstile (Anti-spam) -->
    {% if turnstile_site_key %}
      <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    {% endif %}


    {% block extra_head %}{% endblock %}

  </head>
  <body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 antialiased pt-24 sm:pt-24 md:pt-[72px]">
    <script>
      // Apply dark-mode class to body immediately if dark theme is enabled
      // This runs synchronously right after <body> tag to prevent white flash
      if (window.__darkModeEnabled) {
        document.body.classList.add('dark-mode');
      }
    </script>
    <!-- Global JS Settings from Django -->
    <script>
      window.JS_SETTINGS = {
        patienceMessageDelay: Number("{{ js_settings.patience_message_delay|default:40|escapejs }}") * 1000,
        pollInterval: Number("{{ js_settings.poll_interval|default:2500|escapejs }}")
      };
    </script>

    {% include "frontend/includes/header.html" %}

    <!-- Messages -->
    {% if messages %}
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} mb-4 p-4 rounded-lg border flex items-center justify-between
                      {% if message.tags == 'success' %}bg-green-50 border-green-200 text-green-800 dark:bg-green-900/30 dark:border-green-700 dark:text-green-200{% endif %}
                      {% if message.tags == 'error' %}bg-red-50 border-red-200 text-red-800 dark:bg-red-900/30 dark:border-red-700 dark:text-red-200{% endif %}
                      {% if message.tags == 'warning' %}bg-yellow-50 border-yellow-200 text-yellow-800 dark:bg-yellow-900/30 dark:border-yellow-700 dark:text-yellow-200{% endif %}
                      {% if message.tags == 'info' %}bg-blue-50 border-blue-200 text-blue-800 dark:bg-blue-900/30 dark:border-blue-700 dark:text-blue-200{% endif %}
                     ">
            <div class="flex items-center">
              {% if message.tags == 'success' %}
                <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
              {% elif message.tags == 'error' %}
                <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
              {% else %}
                <svg class="w-5 h-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
              {% endif %}
              <span>{{ message }}</span>
            </div>
            <button type="button" class="ml-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200" onclick="this.parentElement.remove()">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8 min-h-screen bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100">
      {% block content %}{% endblock %}
    </main>

    {% include "frontend/includes/footer.html" %}
    {% include "frontend/includes/cookie_banner.html" %}

    <script src="{% minified_static 'js/cookie-consent.js' %}" defer></script>
    <script src="{% minified_static 'js/language-detection.js' %}" defer></script>

    {% block extra_js %}{% endblock %}

    <!-- Theme Toggle Script (Premium Dark Mode) -->
    <script src="{% minified_static 'js/theme-toggle.js' %}" defer></script>

    <!-- PWA Install Script -->
    <script src="{% minified_static 'js/pwa-install.js' %}" defer></script>

    <!-- Service Worker Registration - moved to end of body for better performance -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('[SW] Registered:', registration.scope);
              setInterval(() => { registration.update(); }, 3600000);
            })
            .catch((error) => {
              console.log('[SW] Registration failed:', error);
            });
        });
      }
    </script>

    <!-- Unified Analytics: Yandex.Metrika + GA4 with CookieConsent -->
    <!-- Deferred loading to improve LCP - analytics loads after page is interactive -->
    <script>
      (function() {
        // Delay analytics loading until after page is interactive
        function loadAnalytics() {
          (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {
              if (document.scripts[j].src === r) { return; }
            }
            k=e.createElement(t), a=e.getElementsByTagName(t)[0];
            k.async = 1; k.defer = 1; k.src = r; a.parentNode.insertBefore(k,a);
          })(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

          var gtagScript = document.createElement('script');
          gtagScript.src = "https://www.googletagmanager.com/gtag/js?id=G-65KKH2JRKC";
          gtagScript.async = true;
          gtagScript.defer = true;
          document.head.appendChild(gtagScript);

          // Wait for scripts to load before initializing
          function waitForScripts(callback) {
            var attempts = 0;
            var maxAttempts = 50; // 5 seconds max wait

            function check() {
              attempts++;
              // Check if Yandex Metrika is loaded (optional, will work without it)
              var ymReady = typeof window.ym !== 'undefined' || attempts > 10;
              // Check if Google Analytics is loaded
              var gaReady = typeof window.gtag !== 'undefined' || attempts > 10;

              if (ymReady && gaReady) {
                callback();
              } else if (attempts < maxAttempts) {
                setTimeout(check, 100);
              } else {
                // Timeout - initialize anyway (scripts might load later)
                callback();
              }
            }
            check();
          }

          function initAnalytics() {
            // Initialize Yandex Metrika
            // Disable clickmap on mobile - it creates an overlay that blocks touch scroll on some Android devices
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            var ymConfig = {
              clickmap: !isMobile,
              trackLinks: true,
              accurateTrackBounce: true,
              webvisor: false
            };

            if (typeof window.ym !== 'undefined') {
              try {
                ym(105790338, 'init', ymConfig);
                ym(105790338, 'hit', window.location.href);
              } catch(e) {
                console.warn('Yandex Metrika init error:', e);
              }
            } else {
              // Yandex script not loaded yet, try again later
              setTimeout(function() {
                if (typeof window.ym !== 'undefined') {
                  ym(105790338, 'init', ymConfig);
                  ym(105790338, 'hit', window.location.href);
                }
              }, 1000);
            }

            // Initialize Google Analytics
            window.dataLayer = window.dataLayer || [];
            if (typeof window.gtag === 'undefined') {
              function gtag(){dataLayer.push(arguments);}
              window.gtag = gtag;
            }

            try {
              gtag('js', new Date());
              gtag('config', 'G-65KKH2JRKC', { send_page_view: false });
              gtag('event', 'page_view', { page_path: window.location.pathname });
            } catch(e) {
              console.warn('Google Analytics init error:', e);
            }
          }

          // Check cookie consent
          function checkAndInitAnalytics() {
            var cookieConsent = localStorage.getItem('cookie_consent');
            var cookieAnalytics = localStorage.getItem('cookie_analytics');

            // If user has accepted cookies and analytics is enabled
            if (cookieConsent === 'accepted' && cookieAnalytics === 'true') {
              waitForScripts(initAnalytics);
            } else if (!cookieConsent) {
              // No consent yet - wait for user decision
              window.addEventListener('cookieConsentAccepted', function() {
                waitForScripts(initAnalytics);
              }, { once: true });
            }
            // If user rejected, don't initialize analytics
          }

          checkAndInitAnalytics();
        }

        // Load analytics after page is interactive (not blocking LCP)
        if (document.readyState === 'complete') {
          // Page already loaded, load analytics immediately
          setTimeout(loadAnalytics, 0);
        } else {
          // Wait for page to be interactive before loading analytics
          window.addEventListener('load', function() {
            // Use requestIdleCallback if available, otherwise setTimeout
            if (window.requestIdleCallback) {
              requestIdleCallback(loadAnalytics, { timeout: 2000 });
            } else {
              setTimeout(loadAnalytics, 2000);
            }
          });
        }
      })();
    </script>
  </body>
</html>
